<div dir="ltr">Hello, while testing new PMI implementation I faced a problem with OpenIB and/or usNIC support. <div>The cluster I use is build on Mellanox QDR. We don&#39;t use Cisco hardware, thus no Cisco Virtual Interface Card. To exclude possibility of new PMI code influence I used mpirun to launch the job. Slurm job script is attached.<div>
<br></div><div>While investigating the problem I found the following:</div><div>1. With TCP btl everything works without errors (add export OMPI_MCA_btl=&quot;tcp,self&quot; in attached batch script).</div><div><br></div>
<div>2. With fixed OpenIB  support  (add export OMPI_MCA_btl=&quot;openib,self&quot; in attached batch script) I get followint error:</div><div><div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div>
<div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div><div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div>
<div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div><div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div>
<div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div><div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div>
<div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div><div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div>
<div>hellompi: /home/research/artpol/ompi_dev//ompi-trunk_r31907/ompi/mca/btl/openib/btl_openib.c:1151: mca_btl_openib_del_procs: Assertion `((opal_object_t*)endpoint)-&gt;obj_reference_count == 1&#39; failed.</div></div>
<div><div><br></div><div>Complete logs are tar-ed, check &quot;openib-failure&quot; directory.</div><div><br></div><div>3. If I do not fix the BTL component (no OMPI_MCA_btl is exported) I can get either immediate fail talking about usNIC/OpenIB problems OR programs hangs.</div>
<div>For both cases I&#39;m attaching complete tar-ed logs. Check &quot;auto-failure&quot; dir for ompi stdout and stderr and &quot;auto-hang&quot; for the hang case.</div><div><br></div><div>I am ready to provide additional info or help with testing but I have no time to track the problem myself in near several days.</div>
<div><br></div>-- <br>С Уважением, Поляков Артем Юрьевич<br>Best regards, Artem Y. Polyakov
</div></div></div>

