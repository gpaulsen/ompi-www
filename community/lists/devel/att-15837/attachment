<div dir="ltr"><div>Hello, </div><div><br></div><div>I would like to introduce OMPI timing framework that was included into the trunk yesterday (r32738). The code is new so if you&#39;ll hit some bugs - just let me know.</div><div><br></div><div>The framework consists of the set of macro&#39;s and routines for internal OMPI usage + standalone tool mpisync and few additional scripts: mpirun_prof and ompi_timing_post. The set of features is very basic and I am open for discussion of new things that are desirable there. </div><div><br></div><div>To enable framework compilation you should configure OMPI with --enable-timing option. If the option was passed to ./configure, standalone tools and scripts will be installed into &lt;prefix&gt;/bin.</div><div><br></div><div>The timing code is located in OPAL (opal/utils/timing.[ch]). There is a set of macro&#39;s that should be used to preprocess out all mentions of the timing code in case it wasn&#39;t requested with --enable-timing:</div><div>OPAL_TIMING_DECLARE(t) - declare timing handler structure with name &quot;t&quot;.</div><div>OPAL_TIMING_DECLARE_EXT(x, t) - external declaration of a timing handler &quot;t&quot;.</div><div>OPAL_TIMING_INIT(t) - initialize timing handler &quot;t&quot;</div><div>OPAL_TIMING_EVENT(x) - printf-like event declaration similar to OPAL_OUTPUT.</div><div>The information about the event will be quickly inserted into the linked list. Maximum event description is limited by OPAL_TIMING_DESCR_MAX. </div><div>The malloc is performed in buckets (OPAL_TIMING_BUFSIZE at once) and overhead (time to malloc and prepare the bucket) is accounted in corresponding list element. It might be excluded from the timing results (controlled by OMPI_MCA_opal_timing_overhead parameter).</div><div>OPAL_TIMING_REPORT(enable, t, prefix) - prepare and print out timing information. If OMPI_MCA_opal_timing_file was specified the output will go to that file. In other case the output will be directed using opal_output, each line will be prefixed with &quot;prefix&quot; to ease grep&#39;ing. &quot;enable&quot; is a boolean/integer variable that is used for runtime selection of what should be reported.</div><div>OPAL_TIMING_RELEASE(t) - the counterpart for OPAL_TIMING_INIT.</div><div><br></div><div>There are several examples in OMPI code. And here is another simple example:</div><div>    OPAL_TIMING_DECLARE(tm);</div><div>    OPAL_TIMING_INIT(&amp;tm);</div><div>    ...</div><div>    OPAL_TIMING_EVENT((&amp;tm,&quot;Begin of timing: %s&quot;, ORTE_NAME_PRINT(&amp;(peer-&gt;name)) ));</div><div>    ....</div><div>    OPAL_TIMING_EVENT((&amp;tm,&quot;Next timing event with condition x = %d&quot;, x ));</div><div>    ...</div><div>    OPAL_TIMING_EVENT((&amp;tm,&quot;Finish&quot;));</div><div>    OPAL_TIMING_REPORT(enable_var, &amp;tm,&quot;MPI Init&quot;);</div><div>    OPAL_TIMING_RELEASE(&amp;tm);</div><div><br></div><div><br></div><div>An output from all OMPI processes (mpirun, orted&#39;s, user processes) is merged together. NTP provides 1 millisecond - 100 microsecond level of precision. This may not be sufficient to order events globally.</div><div>To help developers extract the most realistic picture of what is going on, additional time synchronisation might be performed before profiling. The mpisync program should be runned 1-user-process-per-node to acquire the file with time offsets relative to HNP of each node. If the cluster runs over Gig Ethernet the precision will be 30-50 microseconds, in case of Infiniband - 4 microseconds. mpisync produces output file that might be readed and used by timing framework (OMPI_MCA_opal_clksync_file parameter). The bad news is that this synchronisation is not enough because of different clock skew on different nodes. Additional periodical synchronisation is needed. This is planned for the near future (me and Ralph discussing possible ways now). </div><div><br></div><div>the mpirun_prof &amp; ompi_timing_post script may be used to automate clock synchronisation in following manner:</div><div>export OMPI_MCA_ompi_timing=true</div><div>export OMPI_MCA_orte_oob_timing=true</div><div>export OMPI_MCA_orte_rml_timing=true</div><div>export OMPI_MCA_opal_timing_file=timing.out</div><div>mpirun_prof &lt;ompi-params&gt; ./mpiprog</div><div>ompi_timing_post timing.out</div><div><br></div><div>ompi_timing_post will simply sort the events and made all times to be relative to the first one.</div><div><br></div>-- <br>С Уважением, Поляков Артем Юрьевич<br>Best regards, Artem Y. Polyakov
</div>

