<div dir="ltr">Ralph,<div><br></div><div>Not there yet. I got similar deadlocks, but the stack not looks slightly different. I only have 1 single thread doing something useful (aka being in listen_thread_fn), every other thread is having a similar stack:</div><div><br></div><div><div>  * frame #0: 0x00007fff93306de6 libsystem_kernel.dylib`__psynch_mutexwait + 10</div><div>    frame #1: 0x00007fff9a000e4a libsystem_pthread.dylib`_pthread_mutex_lock_wait + 89</div><div>    frame #2: 0x00007fff99ffe5f5 libsystem_pthread.dylib`_pthread_mutex_lock_slow + 300</div><div>    frame #3: 0x00007fff8c2a00f8 libdyld.dylib`dyldGlobalLockAcquire() + 16</div><div>    frame #4: 0x00007fff6bbc3177 dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(unsigned int, ImageLoader::LinkContext const&amp;, void (*)(), void (*)()) + 55</div><div>    frame #5: 0x00007fff6bbad063 dyld`dyld::fastBindLazySymbol(ImageLoader**, unsigned long) + 90</div><div>    frame #6: 0x00007fff8c2a0262 libdyld.dylib`dyld_stub_binder + 282</div><div>    frame #7: 0x00000001019d39b0 libopen-pal.0.dylib`obj_order_type + 3776</div></div><div><br></div><div>  George.</div><div><br></div></div><div class="gmail_extra"><br><div class="gmail_quote">On Mon, Jun 6, 2016 at 1:41 PM, Ralph Castain <span dir="ltr">&lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div style="word-wrap:break-word">I think I have this fixed here: <a href="https://github.com/open-mpi/ompi/pull/1756" target="_blank">https://github.com/open-mpi/ompi/pull/1756</a><div><br></div><div>George - can you please try it on your system?</div><div><div class="h5"><div><br></div><div><br><div><blockquote type="cite"><div>On Jun 5, 2016, at 4:18 PM, Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt; wrote:</div><br><div><div>Yeah, I can reproduce on my box. What is happening is that we aren’t properly protected during finalize, and so we tear down some component that is registered for a callback, and then the callback occurs. So we just need to ensure that we finalize in the right order<br><br><blockquote type="cite">On Jun 5, 2016, at 3:51 PM, Jeff Squyres (jsquyres) &lt;<a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a>&gt; wrote:<br><br>Ok, good.<br><br>FWIW: I tried all Friday afternoon to reproduce on my OS X laptop (i.e., I did something like George&#39;s shell script loop), and just now I ran George&#39;s exact loop, but I haven&#39;t been able to reproduce.  In this case, I&#39;m falling on the wrong side of whatever race condition is happening...<br><br><br><blockquote type="cite">On Jun 4, 2016, at 7:57 PM, Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt; wrote:<br><br>I may have an idea of what’s going on here - I just need to finish something else first and then I’ll take a look.<br><br><br><blockquote type="cite">On Jun 4, 2016, at 4:20 PM, George Bosilca &lt;<a href="mailto:bosilca@icl.utk.edu" target="_blank">bosilca@icl.utk.edu</a>&gt; wrote:<br><br><blockquote type="cite"><br>On Jun 5, 2016, at 07:53 , Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt; wrote:<br><br><blockquote type="cite"><br>On Jun 4, 2016, at 1:11 PM, George Bosilca &lt;<a href="mailto:bosilca@icl.utk.edu" target="_blank">bosilca@icl.utk.edu</a>&gt; wrote:<br><br><br><br>On Sat, Jun 4, 2016 at 11:05 PM, Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt; wrote:<br>He can try adding &quot;-mca state_base_verbose 5”, but if we are failing to catch sigchld, I’m not sure what debugging info is going to help resolve that problem. These aren’t even fast-running apps, so there was plenty of time to register for the signal prior to termination.<br><br>I vaguely recollect that we have occasionally seen this on Mac before and it had something to do with oddness in sigchld handling…<br><br>Assuming sigchld has some oddness on OSX. Why is then mpirun deadlocking instead of quitting which will then allow the OS to clean all children?<br></blockquote><br>I don’t think mpirun is actually “deadlocked” - I think it may just be waiting for sigchld to tell it that the local processes have terminated.<br><br>However, that wouldn&#39;t explain why you see what looks like libraries being unloaded. That implies mpirun is actually finalizing, but failing to fully exit - which would indeed be more of a deadlock.<br><br>So the question is: are you truly seeing us missing sigchld (as was suggested earlier in this thread),<br></blockquote><br>In theory the processes remains in zombie state until the parent calls waitpid on them, at which moment they are supposed to disappear. Based on this, as the processes are still in zombie state, I assumed that mpirun was not calling waitpid. One could also assume we are again hit by the fork race condition we had a while back, but as all local processes are in zombie mode, this is hardly believable.<br><br><blockquote type="cite">or did mpirun correctly see all the child processes terminate and is actually hanging while trying to exit (as was also suggested earlier)?<br></blockquote><br>One way or another the stack of the main thread looks busted. While the discussion about this was going on I was able to replicate the bug with only ORTE involved. Simply running <br><br>for i in `seq 1 1 1000`; do echo “$i&quot;; mpirun -np 4 hostname; done<br><br>‘deadlock’ or whatever name we want to call this reliably before hitting the 300 iteration. Unfortunately adding the verbose option alter the behavior enough that the issue does not reproduce.<br><br> George.<br><br><blockquote type="cite"><br>Adding the state verbosity should tell us which of those two is true, assuming it doesn’t affect the timing so much that everything works :-/<br><br><br><blockquote type="cite"><br> George.<br><br><br><br><br><blockquote type="cite">On Jun 4, 2016, at 7:01 AM, Jeff Squyres (jsquyres) &lt;<a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a>&gt; wrote:<br><br>Meh.  Ok.  Should George run with some verbose level to get more info?<br><br><blockquote type="cite">On Jun 4, 2016, at 6:43 AM, Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt; wrote:<br><br>Neither of those threads have anything to do with catching the sigchld - threads 4-5 are listening for OOB and PMIx connection requests. It looks more like mpirun thought it had picked everything up and has begun shutting down, but I can’t really tell for certain.<br><br><blockquote type="cite">On Jun 4, 2016, at 6:29 AM, Jeff Squyres (jsquyres) &lt;<a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a>&gt; wrote:<br><br>On Jun 3, 2016, at 11:07 PM, George Bosilca &lt;<a href="mailto:bosilca@icl.utk.edu" target="_blank">bosilca@icl.utk.edu</a>&gt; wrote:<br><blockquote type="cite"><br>After finalize. As I said in my original email I se all the output the application is generating, and all processes (which are local as this happens on my laptop) are in zombie mode (Z+). This basically means whoever was supposed to get the SIGCHLD, didn&#39;t do it&#39;s job of cleaning them up.<br></blockquote><br>Ah -- so perhaps threads 1,2,3 are red herrings: the real problem here is that the parent didn&#39;t catch the child exits (which presumably should have been caught in threads 4 or 5).<br><br>Ralph: is there any state from threads 4 or 5 that would be helpful to examine to see if they somehow missed catching children exits?<br><br>--<br>Jeff Squyres<br><a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a><br>For corporate legal information go to: <a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19070.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19070.php</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19071.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19071.php</a><br></blockquote><br><br>--<br>Jeff Squyres<br><a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a><br>For corporate legal information go to: <a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19072.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19072.php</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19073.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19073.php</a><br><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19074.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19074.php</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19075.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19075.php</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19076.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19076.php</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19077.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19077.php</a><br></blockquote><br><br>-- <br>Jeff Squyres<br><a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a><br>For corporate legal information go to: <a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19078.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19078.php</a><br></blockquote><br></div></div></blockquote></div><br></div></div></div></div><br>_______________________________________________<br>
devel mailing list<br>
<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>
Subscription: <a href="https://www.open-mpi.org/mailman/listinfo.cgi/devel" rel="noreferrer" target="_blank">https://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/06/19080.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/06/19080.php</a><br></blockquote></div><br></div>

