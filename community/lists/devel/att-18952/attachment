<div dir="ltr">I am currently working with the v2.x branch, rather than tarballs.<div><br></div><div>While attempting to build on AIX (which is ILP32 by default), I encountered an unexpected undefined reference to __sync_add_and_fetch_8() from opal/class/opal_list.h.</div><div><br></div><div>I found that when debugging is enabled (as in almost every build I try) there is the following code:</div><div><div>#if OPAL_ENABLE_DEBUG</div><div>        /* Spot check: ensure this item is only on the list that we</div><div>           just insertted it into */</div><div><br></div><div>        (void)opal_atomic_add( &amp;(item-&gt;opal_list_item_refcount), 1 );</div><div>        assert(1 == item-&gt;opal_list_item_refcount);<br></div><div>        item-&gt;opal_list_item_belong_to = list;</div><div>#endif</div></div><div><br></div><div>I am not sure why (and it may be an AIX-specific issue), but that &quot;opal_atomic_add()&quot; is attempting a 64-bit add.</div><div>That is a problem, given that &#39;opal_list_item_refcount&#39; is 32-bits!</div><div><br></div><div>Noting that all other accesses to this field are OPAL_THREAD_ADD32(), I suggest the following (with a bonus spell-check at no additional charge):</div><div><br></div><div><div><font face="monospace, monospace">--- opal/class/opal_list.c~     2016-05-10 10:20:19.000000000 -0700</font></div><div><font face="monospace, monospace">+++ opal/class/opal_list.c      2016-05-10 10:29:14.000000000 -0700</font></div><div><font face="monospace, monospace">@@ -142,9 +142,9 @@</font></div><div><font face="monospace, monospace"><br></font></div><div><font face="monospace, monospace">  #if OPAL_ENABLE_DEBUG</font></div><div><font face="monospace, monospace">          /* Spot check: ensure this item is only on the list that we</font></div><div><font face="monospace, monospace">-            just insertted it into */</font></div><div><font face="monospace, monospace">+            just inserted it into */</font></div><div><font face="monospace, monospace"><br></font></div><div><font face="monospace, monospace">-         (void)opal_atomic_add( &amp;(item-&gt;opal_list_item_refcount), 1 );</font></div><div><font face="monospace, monospace">+         (void)OPAL_THREAD_ADD32( &amp;(item-&gt;opal_list_item_refcount), 1 );</font></div><div><font face="monospace, monospace">          assert(1 == item-&gt;opal_list_item_refcount);</font></div><div><font face="monospace, monospace">          item-&gt;opal_list_item_belong_to = list;</font></div><div><font face="monospace, monospace">  #endif</font></div></div><div><br></div><div><br></div><div><div>Source inspection shows the same mixing or opal_atomic_add() vs OPAL_THREAD_ADD32() in master.</div></div><div><br></div><div>-Paul</div><div><br></div><div><div><br></div>-- <br><div class="gmail_signature"><div dir="ltr"><div><font face="courier new, monospace"><div>Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: +1-510-495-2352</div><div>Lawrence Berkeley National Laboratory     Fax: +1-510-486-6900</div></font></div></div></div>
</div></div>

