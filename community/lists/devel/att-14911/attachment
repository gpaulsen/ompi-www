<div dir="ltr"><div><div><div><div><div><div><div><div><div><div><div><div><div><div><div><div><div>Folks,<br><br></div>i recently had to solve a tricky issue that involves alignment of fortran types.<br><br></div>the attached program can be used and ran on two tasks in order to evidence the issue.<br>
<br></div>if gfortran is used (to build both openmpi and the test case), then the test is successful<br></div>if ifort (Intel compiler) is used (to build both openmpi and the test case), then the test fails.<br><br></div>
<div>this was mentionned in the openmpi users list quite a while ago at<br><a href="http://www.open-mpi.org/community/lists/users/2010/07/13857.php">http://www.open-mpi.org/community/lists/users/2010/07/13857.php</a><br><br>
</div>the root cause is gfortran considers mpi_real8 must be aligned on 8 bytes whereas ifort considers mpi_real8 does not need to be aligned.<br>consequently, the derived data type ddt is built with an extent of 16 (gfortran) or 12 (ifort)<br>
<br><br></div>in order to determine the type aligment, configure builds a simple program with c and fortran that involves common.<br></div>the default behaviour of ifort is to :<br></div>- *not* align common<br></div>- align records (aka the real8_int fortran type)<br>
</div><div>hence the mismatch and the failure.<br><br></div>the default behaviour of gfortran is to align both common and records, hence the success.<br><br></div><div>/* i &quot;extracted&quot; from configure conftest.c and conftestf.f that can be used to build the conftest binary. conftest will store the alignment in the conftestval file */<br>
</div><div><br></div>i am wondering how this should be dealt by OpenMPI.<br><br><br>here is a non exhaustive list of option :<br><br></div>a) do nothing, this is not related to openmpi, and even if we do something, application built with -noalign will break.<br>
</div>b) advise ifort users to configure with FCFLAGS=&quot;-align zcommons&quot; since it is likely this is what they want <br></div>c) advise ifort users to build their application with &quot;-noalign&quot; to be on the safe side (modulo a performance penalty)<br>
</div>d) update OpenMPI so fortran type alignment is determined via a record instead of a common if fortran &gt;= 90 is used<br></div><div>(so far, i could not find any drawback in doing that)<br></div>e) advise ifort users to create ddt with MPI_DOUBLE instead of mpi_real8 (because this works (!), i did not dig to find out why)<br>
</div><div>f) other ...<br><br></div><div>any thoughts ?<br><br></div><div>Cheers,<br><br></div><div>Gilles<br></div></div>

