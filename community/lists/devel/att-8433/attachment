<html><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; ">I found the bug in&nbsp;otfprofile.<div><br></div><div><div><div><div><div>When ompi/contrib/vt/vt/extlib/otf/tools/otfprofile/otfprofile.cpp is compiled with the PGI C++ compiler, two "expected an&nbsp;identifier" errors occur:</div></div></div></div><div><br></div><div><div><div><div><div></div></div></div></div><blockquote type="cite"><div><div><div><div>"/opt/pgi/linux86-64/10.3/include/omp.h", line 41: error: expected an<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier<br>&nbsp;extern int omp_get_thread_num(void);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^<br><br>"/opt/pgi/linux86-64/10.3/include/omp.h", line 43: error: expected an<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier<br>&nbsp;extern int omp_get_num_threads(void);</div></div></div></div></blockquote></div><div><br></div><div>I saved the preprocessor output for&nbsp;otfprofile.cpp. &nbsp;The&nbsp;code in /opt/pgi/linux86-64/10.3/include/omp.h:</div><div><br></div><div><div></div></div><blockquote type="cite"><div><div>#ifdef __cplusplus</div><div>extern "C" {</div><div>#endif</div><div><br></div><div>extern void omp_set_num_threads(int n);</div><div>extern int omp_get_thread_num(void);</div><div>extern int omp_get_num_procs(void);</div><div>extern int omp_get_num_threads(void);</div><div>extern int omp_get_max_threads(void);</div></div></blockquote><div><br></div><div>expands to:</div><div><br></div><div><div></div></div><blockquote type="cite"><div><div><br></div><div>extern "C" {</div><div><br></div><div><br></div><div>extern void omp_set_num_threads(int n);</div><div>extern int 0;</div><div>extern int omp_get_num_procs(void);</div><div>extern int 1;</div><div>extern int omp_get_max_threads(void);</div></div></blockquote><div><br></div><div>It is easy to see why the compiler issued the error. &nbsp;The root of the problem is the definition of the OpenMP function proxys when the PGI compiler is used:</div><div><br></div><div><div></div></div><blockquote type="cite"><div><div>/* Disable OpenMP if the PGI compiler is used to work around the following errors:</div><div><br></div><div>compiler version &nbsp;compiler error</div><div>&lt; 9.0-3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGCC-S-0000-Internal compiler error. calc_dw_tag:no tag</div><div>(see Technical Problem Report 4337 at <a href="http://www.pgroup.com/support/release_tprs_90.htm)">http://www.pgroup.com/support/release_tprs_90.htm)</a></div><div><br></div><div>10.1 - 10.6 &nbsp; &nbsp; &nbsp; this kind of pragma may not be used here</div><div>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#pargma omp barrier</div><div>*/</div><div>#if defined(_OPENMP) &amp;&amp; defined(__PGI)</div><div># &nbsp; &nbsp; &nbsp; undef _OPENMP</div><div>#endif</div><div><br></div><div><br></div><div>#ifdef _OPENMP</div><div># &nbsp; &nbsp; &nbsp; include &lt;omp.h&gt;</div><div>#else</div><div># &nbsp; &nbsp; &nbsp; define omp_get_thread_num() 0</div><div># &nbsp; &nbsp; &nbsp; define omp_get_num_threads() 1</div><div>#endif</div></div></blockquote><div><br></div><div>Later in&nbsp;otfprofile.cpp, the&nbsp;#include "Summary.h" eventually causes&nbsp;/opt/pgi/linux86-64/10.3/include/omp.h to be included, which leads to the syntax error.</div><div><br></div><div>This is not the way to enable/disable OpenMP. &nbsp;_OPENMP is informational only. &nbsp;In fact, the PGI C++ compiler does not use _OPENMP internally to control whether &lt;omp.h&gt; is included, which is why #undef _OPENMP is ineffective. &nbsp;The proper way to deal with this is using configure/libtool. &nbsp;I changed the code to ignore the __PGI macro:</div><div><br></div><div><div></div></div><blockquote type="cite"><div><div>/* Disable OpenMP if the PGI compiler is used to work around the following errors:</div><div><br></div><div>compiler version &nbsp;compiler error</div><div>&lt; 9.0-3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PGCC-S-0000-Internal compiler error. calc_dw_tag:no tag</div><div>(see Technical Problem Report 4337 at <a href="http://www.pgroup.com/support/release_tprs_90.htm)">http://www.pgroup.com/support/release_tprs_90.htm)</a></div><div><br></div><div>*/</div></div><div><br></div><div><div>#ifdef _OPENMP</div><div># &nbsp; &nbsp; &nbsp; include &lt;omp.h&gt;</div><div>#endif</div></div></blockquote><div><br></div><div>The code compiles fine for PGI C++ 10.3. &nbsp;I believe the comment about 10.1-10.6 not working is possibly due to the&nbsp;(previously reported)&nbsp;mistaken identification of the 10.x compilers by configure/libtool, which I fixed.</div><div><br></div><div apple-content-edited="true"> <div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; "><div><div><div><div><div><div><div><div><div><div>Larry Baker</div><div>US Geological Survey</div><div>650-329-5608</div><div><a href="mailto:baker@usgs.gov">baker@usgs.gov</a></div></div></div></div></div></div></div></div></div></div></div> </div><div><br><div>Begin forwarded message:</div><br class="Apple-interchange-newline"><blockquote type="cite"><div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>From: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Larry Baker &lt;<a href="mailto:baker@usgs.gov">baker@usgs.gov</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Date: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">August 31, 2010 5:21:13 PM PDT</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>To: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Subject: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica"><b>[OMPI devel] Fwd:<span class="Apple-converted-space">&nbsp; </span>1.5rc5 has been posted</b></font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Reply-To: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; min-height: 14px; "><br></div> </div><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; ">My head hurts from working on this! &nbsp;I just realized &lt;omp.h&gt; is for OpenMP, not OpenMPI. &nbsp;So, of course the PGI &lt;omp.h&gt; is used. &nbsp;I still don't know why&nbsp;otfprofile&nbsp;is failing, but at least that explains why OpenMPI-1.5rc5 has no &lt;mpi.h&gt;.<br><div><br></div><div>Sorry for the noise.</div><div><br><div apple-content-edited="true"> <div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; "><div><div><div><div><div><div><div><div><div><div>Larry Baker</div><div>US Geological Survey</div><div>650-329-5608</div><div><a href="mailto:baker@usgs.gov">baker@usgs.gov</a></div></div></div></div></div></div></div></div></div></div></div> </div><div><br><div>Begin forwarded message:</div><br class="Apple-interchange-newline"><blockquote type="cite"><div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>From: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Larry Baker &lt;<a href="mailto:baker@usgs.gov">baker@usgs.gov</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Date: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">August 31, 2010 10:04:35 AM PDT</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>To: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Subject: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica"><b>Re: [OMPI devel] 1.5rc5 has been posted</b></font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; "><font face="Helvetica" size="3" color="#000000" style="font: 12.0px Helvetica; color: #000000"><b>Reply-To: </b></font><font face="Helvetica" size="3" style="font: 12.0px Helvetica">Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a>&gt;</font></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; min-height: 14px; "><br></div> </div><div>The make of OpenMPI 1.5rc5 fails for PGI 10.3 in otfprofile:<br><br><blockquote type="cite">Making all in otfprofile<br></blockquote><blockquote type="cite">make[9]: Entering directory `/usr/local/src/openmpi-1.5rc5/ompi/contrib/vt/vt/extlib/otf/tools/otfprofile'<br></blockquote><blockquote type="cite"> &nbsp;CXX &nbsp;&nbsp;&nbsp;otfprofile-otfprofile.o<br></blockquote><blockquote type="cite">"/opt/pgi/linux86-64/10.3/include/omp.h", line 41: error: expected an<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier<br></blockquote><blockquote type="cite"> &nbsp;extern int omp_get_thread_num(void);<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^<br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">"/opt/pgi/linux86-64/10.3/include/omp.h", line 43: error: expected an<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier<br></blockquote><blockquote type="cite"> &nbsp;extern int omp_get_num_threads(void);<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^<br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">2 errors detected in the compilation of "otfprofile.cpp".<br></blockquote><br>The errors are coming from an &lt;omp.h&gt; file that comes with the PGI compiler. &nbsp;I would think OpenMPI would use its own. &nbsp;The problem is, there isn't one (yet?):<br><br><blockquote type="cite">[root@hydra otfprofile]# find /usr/local/src/openmpi-1.5rc5 -name omp.h<br></blockquote><br>The C++ file that is using the PGI &lt;omp.h&gt; file is &nbsp;ompi/contrib/vt/vt/extlib/otf/tools/otfprofile/otfprofile.cpp:<br><br><blockquote type="cite">[root@hydra otfprofile]# cd ompi/contrib/vt/vt/extlib/otf/tools/otfprofile<br></blockquote><blockquote type="cite">[root@hydra otfprofile]# grep omp.h *.cpp<br></blockquote><blockquote type="cite">otfprofile.cpp:#<span class="Apple-tab-span" style="white-space:pre">	</span>include &lt;omp.h&gt;<br></blockquote><br>I ran the compile from make -n to verify that:<br><br><blockquote type="cite">[root@hydra otfprofile]# pgcpp -m64 -DHAVE_CONFIG_H -I. -I../.. -I../../otflib -I../../otflib &nbsp;-DINSIDE_OPENMPI &nbsp;-D_REENTRANT -mp -g -O3 -tp amd64 -DNO_PGI_OFFSET -c -o otfprofile-otfprofile.o `test -f 'otfprofile.cpp' || echo './'`otfprofile.cpp<br></blockquote><blockquote type="cite">"/opt/pgi/linux86-64/10.3/include/omp.h", line 41: error: expected an<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier<br></blockquote><blockquote type="cite"> &nbsp;extern int omp_get_thread_num(void);<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^<br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">"/opt/pgi/linux86-64/10.3/include/omp.h", line 43: error: expected an<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier<br></blockquote><blockquote type="cite"> &nbsp;extern int omp_get_num_threads(void);<br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^<br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">2 errors detected in the compilation of "otfprofile.cpp".<br></blockquote><br>I don't know how to fix this. &nbsp;Where is otfprofile.cpp expecting to get &lt;omp.h&gt;? &nbsp;Why isn't it there? &nbsp;I'm beginning to think this contrib/vt stuff should not be enabled by default. &nbsp;I don't know that it is needed in general.<br><br>Larry Baker<br>US Geological Survey<br>650-329-5608<br><a href="mailto:baker@usgs.gov">baker@usgs.gov</a><br><br>On Aug 17, 2010, at 2:18 PM, Jeff Squyres wrote:<br><br><blockquote type="cite">We still have one known possible regression:<br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;<a href="https://svn.open-mpi.org/trac/ompi/ticket/2530">https://svn.open-mpi.org/trac/ompi/ticket/2530</a><br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">But we posted rc5 anyway (there's a bunch of stuff that has been pending for a while that is now in). &nbsp;Please test!<br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite"> &nbsp;&nbsp;&nbsp;<a href="http://www.open-mpi.org/software/ompi/v1.5/">http://www.open-mpi.org/software/ompi/v1.5/</a><br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">-- <br></blockquote><blockquote type="cite">Jeff Squyres<br></blockquote><blockquote type="cite"><a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br></blockquote><blockquote type="cite">For corporate legal information go to:<br></blockquote><blockquote type="cite"><a href="http://www.cisco.com/web/about/doing_business/legal/cri/">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite"><br></blockquote><blockquote type="cite">_______________________________________________<br></blockquote><blockquote type="cite">devel mailing list<br></blockquote><blockquote type="cite"><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br></blockquote><blockquote type="cite"><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel<br></div></blockquote></div><br></div></div>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel</blockquote></div><br></div></body></html>
