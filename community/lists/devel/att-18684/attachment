<div dir="ltr">All,<div><br></div><div>     Ben&#39;s suggestion seems reasonable to me.  How about having the </div><div>mpifort script choose the correct mpif-sizeof.h header file based on</div><div>the OMPI_FC compiler given at compile time?</div><div><br></div><div>                       Dave</div></div><div class="gmail_extra"><br><div class="gmail_quote">On Thu, Mar 3, 2016 at 9:48 PM, Ben Menadue <span dir="ltr">&lt;<a href="mailto:ben.menadue@nci.org.au" target="_blank">ben.menadue@nci.org.au</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div lang="EN-AU" link="blue" vlink="purple"><div><p>Hi Dave,<u></u><u></u></p><p><u></u> <u></u></p><p>The issue is the way MPI_Sizeof is handled; it&#39;s implemented as a series of interfaces that map the MPI_Sizeof call to the right function in the library. I suspect this is needed because that function doesn&#39;t take a datatype argument and instead infers this from the argument types - in Fortran, this is only possible if you use an interface to call a different function for each data type.<u></u><u></u></p><p><u></u> <u></u></p><p>Since &quot;real, dimension(:)&quot; is different from &quot;real, dimension(:, :)&quot; from the perspective of the interface, you need a separate entry for each possible array rank. In Fortran 2008 the maximum rank was increased to 15. This is supported in Intel Fortran and so the mpif-sizeof.h from such a build needs to have interface blocks for up to rank-15 arrays. However, the version of gfortran that you&#39;re using doesn’t, and hence it complains when it sees the rank &gt; 7 interfaces in mpif-sizeof.h.<u></u><u></u></p><p><u></u> <u></u></p><p>To make it compatible between Fortran 2008 compliant and non-compliant compilers, you would need to implement MPI_Sizeof in a totally different fashion - if that’s even possible.<u></u><u></u></p><p><u></u> <u></u></p><p>FWIW: We maintain two copies of mpif-sizeof.h in separate subdirectories – one for gfortran and one for ifort. Then, there are wrappers around each of the compilers that adds the appropriate subdirectory to the include path. This makes it transparent to our users, and allows us to present a single build tree that works for both compilers.<u></u><u></u></p><p><u></u> <u></u></p><p>Cheers,<u></u><u></u></p><p>Ben<u></u><u></u></p><p><u></u> <u></u></p><p><u></u> <u></u></p><p class="MsoNormal"><a name="2132111122__MailEndCompose"><span style="font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif"><u></u> <u></u></span></a></p><p class="MsoNormal"><b><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif">From:</span></b><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif"> devel [mailto:<a href="mailto:devel-bounces@open-mpi.org" target="_blank">devel-bounces@open-mpi.org</a>] <b>On Behalf Of </b>Dave Turner<br><b>Sent:</b> Friday, 4 March 2016 2:23 PM<br><b>To:</b> Larry Baker &lt;<a href="mailto:baker@usgs.gov" target="_blank">baker@usgs.gov</a>&gt;<br><b>Cc:</b> Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a>&gt;<br><b>Subject:</b> Re: [OMPI devel] mpif.h on Intel build when run with OMPI_FC=gfortran<u></u><u></u></span></p><div><div class="h5"><p class="MsoNormal"><u></u> <u></u></p><div><p class="MsoNormal">All,<u></u><u></u></p><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">     I think that a GNU build of OpenMPI will allow compiling with both<u></u><u></u></p></div><div><p class="MsoNormal">gfortan and ifort, so I think OMPI_FC is useful.  I&#39;d like to see it fully<u></u><u></u></p></div><div><p class="MsoNormal">supported if possible, so if the higher-dimensions in mpif-sizeof.h are<u></u><u></u></p></div><div><p class="MsoNormal">not vital and there is another way of accomplishing the same thing I think<u></u><u></u></p></div><div><p class="MsoNormal">it would be useful to address.<u></u><u></u></p></div><div><p class="MsoNormal">     If not, I would at least like to see some warnings in the documentation<u></u><u></u></p></div><div><p class="MsoNormal">of the OMPI_FC section that would list the cases like this where it will fail.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">                 Dave<u></u><u></u></p></div></div><div><p class="MsoNormal"><u></u> <u></u></p><div><p class="MsoNormal">On Thu, Mar 3, 2016 at 9:07 PM, Larry Baker &lt;<a href="mailto:baker@usgs.gov" target="_blank">baker@usgs.gov</a>&gt; wrote:<u></u><u></u></p><blockquote style="border:none;border-left:solid #cccccc 1.0pt;padding:0cm 0cm 0cm 6.0pt;margin-left:4.8pt;margin-top:5.0pt;margin-right:0cm;margin-bottom:5.0pt"><div><p class="MsoNormal">Dave,<u></u><u></u></p><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">Both Gilles and Chris raise important points.  You really cannot expect to mix modules from two different Fortran compilers in a single executable.  There is no requirement placed on a compiler by the Fortran standard for what object language it should use, how the information in modules is made available across compilation units, or the procedure calling conventions.  This makes me wonder, as you do, what the point is of the OMPI_CC and OMPI_FC environment variables?  I do think that Intel has tried to make their objects interoperable with GCC objects.  That is a link-time issue.  You are encountering compile-time issues.  Gilles says whatever mpif-sizeof.h was intended to define, it cannot be done in gfortran.  Even if mpif-sizeof.h generated for an Intel compiler was standard-conforming (so the errors you encountered are not show stoppers), I&#39;m not sure you would be able to get past the incompatibility between the internal formats used by each compiler to store module definitions and declarations for later USE by another compilation unit.  I think your expectations cannot be fulfilled because of the compilers, not because of OpenMPI.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p><div><p class="MsoNormal" style="margin-bottom:12.0pt"><span style="font-size:13.5pt;font-family:&quot;Helvetica Neue&quot;,serif;color:black">Larry Baker<br>US Geological Survey<br></span><a href="tel:650-329-5608" target="_blank"><span style="font-size:13.5pt;font-family:&quot;Helvetica Neue&quot;,serif">650-329-5608</span></a><span style="font-size:13.5pt;font-family:&quot;Helvetica Neue&quot;,serif;color:black"><br></span><a href="mailto:baker@usgs.gov" target="_blank"><span style="font-size:13.5pt;font-family:&quot;Helvetica Neue&quot;,serif">baker@usgs.gov</span></a><span style="font-size:13.5pt;font-family:&quot;Helvetica Neue&quot;,serif;color:black"><br><br></span><u></u><u></u></p></div><p class="MsoNormal"><u></u> <u></u></p><div><div><div><div><p class="MsoNormal">On 3 Mar 2016, at 6:39 PM, Dave Turner wrote:<u></u><u></u></p></div><p class="MsoNormal"><u></u> <u></u></p></div></div><blockquote style="margin-top:5.0pt;margin-bottom:5.0pt"><div><div><div><p class="MsoNormal">Gilles,<u></u><u></u></p><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">    I don&#39;t see the point of having the OMPI_CC and OMPI_FC environment<u></u><u></u></p></div><div><p class="MsoNormal">variables at all if you&#39;re saying that we shouldn&#39;t expect them to work.  I <u></u><u></u></p></div><div><p class="MsoNormal">actually do think they work fine if you do a GNU build and use them to<u></u><u></u></p></div><div><p class="MsoNormal">specify the Intel compilers.  I also think it works fine when you do an<u></u><u></u></p></div><div><p class="MsoNormal">Intel build and compile with gcc.  So to me it just looks like that one<u></u><u></u></p></div><div><p class="MsoNormal">include file is the problem.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">                  Dave<u></u><u></u></p></div></div><div><p class="MsoNormal"><u></u> <u></u></p><div><p class="MsoNormal">On Thu, Mar 3, 2016 at 8:02 PM, Gilles Gouaillardet &lt;<a href="mailto:gilles@rist.or.jp" target="_blank">gilles@rist.or.jp</a>&gt; wrote:<u></u><u></u></p><blockquote style="border:none;border-left:solid #cccccc 1.0pt;padding:0cm 0cm 0cm 6.0pt;margin-left:4.8pt;margin-top:5.0pt;margin-right:0cm;margin-bottom:5.0pt"><div><p class="MsoNormal">Dave,<br><br>you should not expect anything when mixing Fortran compilers<br>(and to be on the safe side, you might not expect much when mixing C/C++ compilers too,<br>for example, if you built ompi with intel and use gcc for your app, gcc might complain about unresolved symbols from the intel runtime)<br><br>if you compile OpenMPI with gfortran 4.8.5, the automatically generated mpif-sizeof.h contains<br><br>! Sad panda.<br>!<br>! This compiler does not support the Right Stuff to enable MPI_SIZEOF.<br>! Specifically: we need support for the INTERFACE keyword,<br>! ISO_FORTRAN_ENV, and the STORAGE_SIZE() intrinsic on all types.<br>! Apparently, this compiler does not support both of those things, so<br>! this file will be (effecitvely) blank (i.e., we didn&#39;t bother<br>! generating the necessary stuff for MPI_SIZEOF because the compiler<br>! doesn&#39;t support<br>! it).<br>!<br>! If you want support for MPI_SIZEOF, please use a different Fortran<br>! compiler to build Open MPI.<br><br>intel fortran compilers have the right stuff, so mpif-sizeof.h is usable, and you get something very different.<br><br>Cheers,<br><br>Gilles<u></u><u></u></p><div><div><p class="MsoNormal" style="margin-bottom:12.0pt"><u></u> <u></u></p><div><p class="MsoNormal">On 3/4/2016 10:17 AM, Dave Turner wrote:<u></u><u></u></p></div></div></div><blockquote style="margin-top:5.0pt;margin-bottom:5.0pt"><div><div><div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">     My understanding is that OpenMPI built with either Intel or<u></u><u></u></p></div><div><p class="MsoNormal">GNU compilers should be able to use the other compilers using the<u></u><u></u></p></div><div><p class="MsoNormal">OMPI_CC and OMPI_FC environmental variables.<u></u><u></u></p></div><div><p class="MsoNormal">     For OpenMPI-1.8.8 built with Intel compilers, if you try to<u></u><u></u></p></div><div><p class="MsoNormal">compile any code that includes mpif.h using OMPI_FC=gfortran it<u></u><u></u></p></div><div><p class="MsoNormal">fails.  The Intel build creates mpi-sizeof.h that dimensions<u></u><u></u></p></div><div><p class="MsoNormal">arrays to more than 6 dimensions which gfortran cannot handle.<u></u><u></u></p></div><div><p class="MsoNormal">The example below illustrates this.<u></u><u></u></p></div><div><p class="MsoNormal">     I wasn&#39;t able to find any other reports like this on the<u></u><u></u></p></div><div><p class="MsoNormal">web, and I don&#39;t see any way of specifying a path to an alternate<u></u><u></u></p></div><div><p class="MsoNormal">mpif.h include file.  This looks to be a bug to me, but please let<u></u><u></u></p></div><div><p class="MsoNormal">me know if I missed a config flag somewhere.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">               Dave Turner<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">Selene cat bugtest.F<u></u><u></u></p></div><div><p class="MsoNormal">! Program to illustrate bug when OpenMPI is compiled with Intel<u></u><u></u></p></div><div><p class="MsoNormal">!    compilers but run using OMPI_FC=gfortran.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">      PROGRAM BUGTEST<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">      INCLUDE &quot;mpif.h&quot;<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">      END<u></u><u></u></p></div><div><p class="MsoNormal">Selene cat go<u></u><u></u></p></div><div><p class="MsoNormal">#!/bin/bash<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">echo &quot;Compile test using default ifort&quot;<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">mpifort --version<u></u><u></u></p></div><div><p class="MsoNormal">mpifort bugtest.F -o bugtest_ifort<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">echo &quot;Compile test using gfortan when OpenMPI was compiled with ifort/icc&quot;<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">export OMPI_FC=gfortran<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">mpifort --version<u></u><u></u></p></div><div><p class="MsoNormal">mpifort bugtest.F -o bugtest_gfortran<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">Selene ./go<u></u><u></u></p></div><div><p class="MsoNormal">Compile test using default ifort<u></u><u></u></p></div><div><p class="MsoNormal">ifort (IFORT) 15.0.3 20150407<u></u><u></u></p></div><div><p class="MsoNormal">Copyright (C) 1985-2015 Intel Corporation.  All rights reserved.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">Compile test using gfortan when OpenMPI was compiled with ifort/icc<u></u><u></u></p></div><div><p class="MsoNormal">GNU Fortran (Gentoo 4.9.3 p1.4, pie-0.6.4) 4.9.3<u></u><u></u></p></div><div><p class="MsoNormal">Copyright (C) 2015 Free Software Foundation, Inc.<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">GNU Fortran comes with NO WARRANTY, to the extent permitted by law.<u></u><u></u></p></div><div><p class="MsoNormal">You may redistribute copies of GNU Fortran<u></u><u></u></p></div><div><p class="MsoNormal">under the terms of the GNU General Public License.<u></u><u></u></p></div><div><p class="MsoNormal">For more information about these matters, see the file named COPYING<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">mpif-sizeof.h:75.48:<u></u><u></u></p></div><div><p class="MsoNormal">    Included at mpif.h:61:<u></u><u></u></p></div><div><p class="MsoNormal">    Included at bugtest.F:6:<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">      COMPLEX(REAL128), DIMENSION(1,1,1,1,1,1,1,*)::x<u></u><u></u></p></div><div><p class="MsoNormal">                                                1<u></u><u></u></p></div><div><p class="MsoNormal">Error: Array specification at (1) has more than 7 dimensions<u></u><u></u></p></div><div><p class="MsoNormal">mpif-sizeof.h:82.48:<u></u><u></u></p></div><div><p class="MsoNormal">    Included at mpif.h:61:<u></u><u></u></p></div><div><p class="MsoNormal">    Included at bugtest.F:6:<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">      COMPLEX(REAL128), DIMENSION(1,1,1,1,1,1,1,1,*)::x<u></u><u></u></p></div><div><p class="MsoNormal">                                                1<u></u><u></u></p></div><div><p class="MsoNormal">Error: Array specification at (1) has more than 7 dimensions<u></u><u></u></p></div><div><p class="MsoNormal">mpif-sizeof.h:89.48:<u></u><u></u></p></div><div><p class="MsoNormal">    Included at mpif.h:61:<u></u><u></u></p></div><div><p class="MsoNormal">    Included at bugtest.F:6:<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">      COMPLEX(REAL128), DIMENSION(1,1,1,1,1,1,1,1,1,*)::x<u></u><u></u></p></div><div><p class="MsoNormal">                                                1<u></u><u></u></p></div><div><p class="MsoNormal">Error: Array specification at (1) has more than 7 dimensions<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal">[ More of the same errors have been clipped ]<u></u><u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><div><p class="MsoNormal"><u></u> <u></u></p></div><p class="MsoNormal">-- <u></u><u></u></p><div><div><div><div><p class="MsoNormal">Work:     <a href="mailto:DaveTurner@ksu.edu" target="_blank">DaveTurner@ksu.edu</a>     <a href="tel:%28785%29%20532-7791" target="_blank">(785) 532-7791</a> <u></u><u></u></p><div><p class="MsoNormal">             2219 Durland, Manhattan KS  66502<br>Home:    <a href="mailto:DrDaveTurner@gmail.com" target="_blank">DrDaveTurner@gmail.com</a><br>              cell: <a href="tel:%28785%29%20770-5929" target="_blank">(785) 770-5929</a><u></u><u></u></p></div></div></div></div></div></div><p class="MsoNormal" style="margin-bottom:12.0pt"><u></u> <u></u></p></div></div><pre>_______________________________________________<u></u><u></u></pre><pre>devel mailing list<u></u><u></u></pre><pre><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><u></u><u></u></pre><pre>Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><u></u><u></u></pre><pre>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/03/18671.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/03/18671.php</a><u></u><u></u></pre></blockquote><p class="MsoNormal"><u></u> <u></u></p></div></blockquote></div><p class="MsoNormal"><br><br clear="all"><u></u><u></u></p><div><p class="MsoNormal"><u></u> <u></u></p></div><p class="MsoNormal">-- <u></u><u></u></p><div><div><div><div><p class="MsoNormal">Work:     <a href="mailto:DaveTurner@ksu.edu" target="_blank">DaveTurner@ksu.edu</a>     <a href="tel:%28785%29%20532-7791" target="_blank">(785) 532-7791</a><u></u><u></u></p><div><p class="MsoNormal">             2219 Durland, Manhattan KS  66502<br>Home:    <a href="mailto:DrDaveTurner@gmail.com" target="_blank">DrDaveTurner@gmail.com</a><br>              cell: <a href="tel:%28785%29%20770-5929" target="_blank">(785) 770-5929</a><u></u><u></u></p></div></div></div></div></div></div><p class="MsoNormal">_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><u></u><u></u></p></div></div><p class="MsoNormal">Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2016/03/18678.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2016/03/18678.php</a><u></u><u></u></p></blockquote></div><p class="MsoNormal"><u></u> <u></u></p></div></div></blockquote></div><p class="MsoNormal"><br><br clear="all"><u></u><u></u></p><div><p class="MsoNormal"><u></u> <u></u></p></div><p class="MsoNormal">-- <u></u><u></u></p><div><div><div><div><p class="MsoNormal">Work:     <a href="mailto:DaveTurner@ksu.edu" target="_blank">DaveTurner@ksu.edu</a>     <a href="tel:%28785%29%20532-7791" value="+17855327791" target="_blank">(785) 532-7791</a><u></u><u></u></p><div><p class="MsoNormal">             2219 Durland, Manhattan KS  66502<br>Home:    <a href="mailto:DrDaveTurner@gmail.com" target="_blank">DrDaveTurner@gmail.com</a><br>              cell: <a href="tel:%28785%29%20770-5929" value="+17857705929" target="_blank">(785) 770-5929</a><u></u><u></u></p></div></div></div></div></div></div></div></div></div></div></blockquote></div><br><br clear="all"><div><br></div>-- <br><div class="gmail_signature"><div dir="ltr"><div><div dir="ltr">Work:     <a href="mailto:DaveTurner@ksu.edu" target="_blank">DaveTurner@ksu.edu</a>     (785) 532-7791<div>             2219 Durland, Manhattan KS  66502<br>Home:    <a href="mailto:DrDaveTurner@gmail.com" target="_blank">DrDaveTurner@gmail.com</a><br>              cell: (785) 770-5929<br></div></div></div></div></div>
</div>

