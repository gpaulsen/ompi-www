<div dir="ltr">+1 for the overall idea !<div class="gmail_extra"><br><div class="gmail_quote">On Fri, Jul 18, 2014 at 10:17 PM, Ralph Castain <span dir="ltr">&lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt;</span> wrote:<blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">
<div style="word-wrap:break-word"><div><div class=""><blockquote type="cite">* add an OBJ_CLASS_DEREGISTER and require that all instantiations be matched by deregister at close of the framework/component that instanced it. Of course, that requires that we protect the class system against someone releasing/deconstructing an object after the class was deregistered since we don&#39;t know who might be using that class outside of where it was created.<br>
<br></blockquote></div></div></div></blockquote><div>my understanding is that in theory, we already have an issue and fortunatly, we do not hit it :</div><div>let&#39;s consider a framework/component that instanciate a class (OBJ_CLASS_INSTANCE) *with a destructor*, allocate an object of this class (OBJ_NEW) and expects &quot;someone else&quot; will free it (OBJ_RELEASE)</div>
<div>if this framework/component ends up in a dynamic library that is dlclose&#39;d when the framework/component is no more used, then OBJ_RELEASE will try to call the destructor which is no more accessible (since the lib was dlclose&#39;d)</div>
<div><br></div><div>i could not experience such a scenario yet, and of course, this does not mean there is no problem. i experienced a &quot;kind of&quot; similar situation described inÂ <a href="http://www.open-mpi.org/community/lists/devel/2014/06/14937.php">http://www.open-mpi.org/community/lists/devel/2014/06/14937.php</a></div>
<div><br></div><div>back to OBJ_CLASS_DEREGISTER, what about an OBJ_CLASS_REGISTER in order to make this symmetric and easier to debug ?</div><div><br></div><div>currently, OBJ_CLASS_REGISTER is &quot;implied&quot; the first time an object of a given class is allocated. from opal_obj_new :</div>
<div>if (0 == cls-&gt;cls_initialized) opal_class_initialize(cls);</div><div><br></div><div>that could be replaced by an error if 0 == cls-&gt;cls_initialized</div><div>and OBJ_CLASS_REGISTER would simply call opal_class_initialize</div>
<div><br></div><div>of course, this change could be implemented only when compiled</div><div>with OPAL_ENABLE_DEBUG</div><div><br></div><div>Cheers,</div><div><br></div><div>Gilles</div></div></div></div>

