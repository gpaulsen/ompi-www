<html><head><meta http-equiv="Content-Type" content="text/html charset=us-ascii"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">Hi Gilles<div><br></div><div>I'm surprised this came into the trunk - last I saw, we hadn't fully decided which approach we wanted to pursue. Did I miss some discussion?</div><div><br></div><div>Due to some other issues, we had been leaning more towards the other alternative - i.e., adding structure to the opal identifier struct. Is there some reason why you chose this alternative?</div><div><br><div><br><div>Begin forwarded message:</div><br class="Apple-interchange-newline"><blockquote type="cite"><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"><span style="font-family:'Helvetica'; color:rgba(0, 0, 0, 1.0);"><b>From: </b></span><span style="font-family:'Helvetica';"><a href="mailto:gitdub@crest.iu.edu">gitdub@crest.iu.edu</a><br></span></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"><span style="font-family:'Helvetica'; color:rgba(0, 0, 0, 1.0);"><b>Subject: </b></span><span style="font-family:'Helvetica';"><b>[OMPI commits] Git: open-mpi/ompi branch master updated. dev-102-gc9c5d40</b><br></span></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"><span style="font-family:'Helvetica'; color:rgba(0, 0, 0, 1.0);"><b>Date: </b></span><span style="font-family:'Helvetica';">October 15, 2014 at 3:50:43 AM PDT<br></span></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"><span style="font-family:'Helvetica'; color:rgba(0, 0, 0, 1.0);"><b>To: </b></span><span style="font-family:'Helvetica';"><a href="mailto:ompi-commits@open-mpi.org">ompi-commits@open-mpi.org</a><br></span></div><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"><span style="font-family:'Helvetica'; color:rgba(0, 0, 0, 1.0);"><b>Reply-To: </b></span><span style="font-family:'Helvetica';"><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br></span></div><br><div>This is an automated email from the git hooks/post-receive script. It was<br>generated because a ref change was pushed to the repository containing<br>the project "open-mpi/ompi".<br><br>The branch, master has been updated<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;via &nbsp;c9c5d4011bf6ea1ade1a5bd9b6a77f02157dc774 (commit)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from &nbsp;5c81658d58e260170c995030ac17e42a4032e2dd (commit)<br><br>Those revisions listed above that are new to this repository have<br>not appeared on any other notification email; so we list those<br>revisions in full, below.<br><br>- Log -----------------------------------------------------------------<br><a href="https://github.com/open-mpi/ompi/commit/c9c5d4011bf6ea1ade1a5bd9b6a77f02157dc774">https://github.com/open-mpi/ompi/commit/c9c5d4011bf6ea1ade1a5bd9b6a77f02157dc774</a><br><br>commit c9c5d4011bf6ea1ade1a5bd9b6a77f02157dc774<br>Author: Gilles Gouaillardet &lt;gilles.gouaillardet@iferc.org&gt;<br>Date: &nbsp;&nbsp;Wed Oct 15 17:19:13 2014 +0900<br><br> &nbsp;&nbsp;&nbsp;Fix heterogeneous support<br><br> &nbsp;&nbsp;&nbsp;* redefine orte_process_name_t so it can be converted<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;between host and network format as an opal_identifier_t<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aka uint64_t by the OPAL layer.<br> &nbsp;&nbsp;&nbsp;* correctly send OPAL_DSTORE_ARCH key<br><br>diff --git a/ompi/proc/proc.c b/ompi/proc/proc.c<br>index d30182f..12b781e 100644<br>--- a/ompi/proc/proc.c<br>+++ b/ompi/proc/proc.c<br>@@ -107,6 +107,7 @@ int ompi_proc_init(void)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OMPI_CAST_RTE_NAME(&amp;proc-&gt;super.proc_name)-&gt;vpid = i;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i == OMPI_PROC_MY_NAME-&gt;vpid) {<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opal_value_t kv;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ompi_proc_local_proc = proc;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proc-&gt;super.proc_flags = OPAL_PROC_ALL_LOCAL;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proc-&gt;super.proc_hostname = strdup(ompi_process_info.nodename);<br>@@ -115,8 +116,13 @@ int ompi_proc_init(void)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opal_proc_local_set(&amp;proc-&gt;super);<br> #if OPAL_ENABLE_HETEROGENEOUS_SUPPORT<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* add our arch to the modex */<br>- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPAL_MODEX_SEND_STRING(ret, PMIX_SYNC_REQD, PMIX_REMOTE, OPAL_DSTORE_ARCH,<br>- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;proc-&gt;super.proc_arch, OPAL_UINT32);<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJ_CONSTRUCT(&amp;kv, opal_value_t);<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kv.key = strdup(OPAL_DSTORE_ARCH);<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kv.type = OPAL_UINT32;<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kv.data.uint32 = opal_local_arch;<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret = opal_pmix.put(PMIX_REMOTE, &amp;kv);<br>+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJ_DESTRUCT(&amp;kv);<br>+<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (OPAL_SUCCESS != ret) {<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ret;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>diff --git a/opal/util/proc.h b/opal/util/proc.h<br>index 8a52a08..db5cfbc 100644<br>--- a/opal/util/proc.h<br>+++ b/opal/util/proc.h<br>@@ -23,7 +23,7 @@<br> #include "opal/dss/dss.h"<br><br> #if OPAL_ENABLE_HETEROGENEOUS_SUPPORT<br>-#include &lt;arpa/inet.h&gt;<br>+#include "opal/types.h"<br> #endif<br><br> /**<br>@@ -37,22 +37,11 @@<br> typedef opal_identifier_t opal_process_name_t;<br><br> #if OPAL_ENABLE_HETEROGENEOUS_SUPPORT &amp;&amp; !defined(WORDS_BIGENDIAN)<br>-#define OPAL_PROCESS_NAME_NTOH(guid) opal_process_name_ntoh_intr(&amp;(guid))<br>-static inline __opal_attribute_always_inline__ void<br>-opal_process_name_ntoh_intr(opal_process_name_t *name)<br>-{<br>- &nbsp;&nbsp;&nbsp;uint32_t * w = (uint32_t *)name;<br>- &nbsp;&nbsp;&nbsp;w[0] = ntohl(w[0]);<br>- &nbsp;&nbsp;&nbsp;w[1] = ntohl(w[1]);<br>-}<br>-#define OPAL_PROCESS_NAME_HTON(guid) opal_process_name_hton_intr(&amp;(guid))<br>-static inline __opal_attribute_always_inline__ void<br>-opal_process_name_hton_intr(opal_process_name_t *name)<br>-{<br>- &nbsp;&nbsp;&nbsp;uint32_t * w = (uint32_t *)name;<br>- &nbsp;&nbsp;&nbsp;w[0] = htonl(w[0]);<br>- &nbsp;&nbsp;&nbsp;w[1] = htonl(w[1]);<br>-}<br>+#define OPAL_PROCESS_NAME_NTOH(guid) \<br>+ &nbsp;&nbsp;&nbsp;guid = ntoh64(guid)<br>+<br>+#define OPAL_PROCESS_NAME_HTON(guid) \<br>+ &nbsp;&nbsp;&nbsp;guid = hton64(guid)<br> #else<br> #define OPAL_PROCESS_NAME_NTOH(guid)<br> #define OPAL_PROCESS_NAME_HTON(guid)<br>diff --git a/orte/include/orte/types.h b/orte/include/orte/types.h<br>index c9ae320..f14b527 100644<br>--- a/orte/include/orte/types.h<br>+++ b/orte/include/orte/types.h<br>@@ -10,6 +10,8 @@<br> &nbsp;* Copyright (c) 2004-2005 The Regents of the University of California.<br> &nbsp;* &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;All rights reserved.<br> &nbsp;* Copyright (c) 2014 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Intel, Inc. All rights reserved.<br>+ * Copyright (c) 2014 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Research Organization for Information Science<br>+ * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and Technology (RIST). All rights reserved.<br> &nbsp;* $COPYRIGHT$<br> &nbsp;*<br> &nbsp;* Additional copyrights may follow<br>@@ -83,17 +85,17 @@ typedef uint32_t orte_vpid_t;<br> #define ORTE_VPID_MAX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UINT32_MAX-2<br> #define ORTE_VPID_MIN &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0<br><br>-#define ORTE_PROCESS_NAME_HTON(n) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>-do { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>- &nbsp;&nbsp;&nbsp;n.jobid = htonl(n.jobid); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>- &nbsp;&nbsp;&nbsp;n.vpid = htonl(n.vpid); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>-} while (0)<br>+#if OPAL_ENABLE_HETEROGENEOUS_SUPPORT &amp;&amp; !defined(WORDS_BIGENDIAN)<br>+#define ORTE_PROCESS_NAME_HTON(n) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>+ &nbsp;&nbsp;&nbsp;OPAL_PROCESS_NAME_HTON(*(opal_process_name_t *)&amp;(n))<br><br>-#define ORTE_PROCESS_NAME_NTOH(n) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>-do { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>- &nbsp;&nbsp;&nbsp;n.jobid = ntohl(n.jobid); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>- &nbsp;&nbsp;&nbsp;n.vpid = ntohl(n.vpid); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>-} while (0)<br>+#define ORTE_PROCESS_NAME_NTOH(n) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>+ &nbsp;&nbsp;&nbsp;OPAL_PROCESS_NAME_NTOH(*(opal_process_name_t *)&amp;(n))<br>+#else<br>+#define ORTE_PROCESS_NAME_HTON(n)<br>+<br>+#define ORTE_PROCESS_NAME_NTOH(n)<br>+#endif<br><br> #define ORTE_NAME_ARGS(n) \<br> &nbsp;&nbsp;&nbsp;&nbsp;(unsigned long) ((NULL == n) ? (unsigned long)ORTE_JOBID_INVALID : (unsigned long)(n)-&gt;jobid), \<br>@@ -115,11 +117,23 @@ do { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br><br> /*<br> &nbsp;* define the process name structure<br>+ * the OPAL layer sees an orte_process_name_t as an opal_process_name_t aka uint64_t<br>+ * if heterogeneous is supported, when converting this uint64_t to<br>+ * an endian neutral format, vpid and jobid will be swapped.<br>+ * consequently, the orte_process_name_t struct must have different definitions<br>+ * (swap jobid and vpid) on little and big endian arch.<br> &nbsp;*/<br>+#if OPAL_ENABLE_HETEROGENEOUS_SUPPORT &amp;&amp; !defined(WORDS_BIGENDIAN)<br>+struct orte_process_name_t {<br>+ &nbsp;&nbsp;&nbsp;orte_vpid_t vpid; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt; Process id - equivalent to rank */<br>+ &nbsp;&nbsp;&nbsp;orte_jobid_t jobid; &nbsp;&nbsp;&nbsp;&nbsp;/**&lt; Job number */<br>+};<br>+#else<br> struct orte_process_name_t {<br> &nbsp;&nbsp;&nbsp;&nbsp;orte_jobid_t jobid; &nbsp;&nbsp;&nbsp;&nbsp;/**&lt; Job number */<br> &nbsp;&nbsp;&nbsp;&nbsp;orte_vpid_t vpid; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt; Process id - equivalent to rank */<br> };<br>+#endif<br> typedef struct orte_process_name_t orte_process_name_t;<br><br><br><br><br>-----------------------------------------------------------------------<br><br>Summary of changes:<br> ompi/proc/proc.c &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 10 ++++++++--<br> opal/util/proc.h &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| 23 ++++++-----------------<br> orte/include/orte/types.h | 34 ++++++++++++++++++++++++----------<br> 3 files changed, 38 insertions(+), 29 deletions(-)<br><br><br>hooks/post-receive<br>-- <br>open-mpi/ompi<br>_______________________________________________<br>ompi-commits mailing list<br>ompi-commits@open-mpi.org<br>http://www.open-mpi.org/mailman/listinfo.cgi/ompi-commits<br></div></blockquote></div><br></div></body></html>
