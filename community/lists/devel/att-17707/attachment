Thanks Paul,<div><br></div><div>I think that by default, resolution occurs the first time a symbol is used.</div><div>that means that without the dlsym check, ompi will crash when accessing the unresolved symbol.</div><div>the test is here to disable the opening btl before something bad happen.</div><div><br></div><div>I will see how I can disable the test if nodal open or static libs only.</div><div>but I am afraid I cannot get a working solution if both static and dynamic libs are built.</div><div><br></div><div>Cheers,</div><div><br></div><div>Gilles<br><br>On Saturday, July 25, 2015, Paul Hargrove &lt;<a href="mailto:phhargrove@lbl.gov">phhargrove@lbl.gov</a>&gt; wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">Gilles,<div><br></div><div>I can confirm that it is not an environment problem, since the strace command (thanks for that) confirms the expect lib is used on both nodes:</div><blockquote style="margin:0px 0px 0px 40px;border:none;padding:0px"><div><div><font face="monospace, monospace">$ grep libibverbs.so log| grep -v ENOENT</font></div></div><div><div><font face="monospace, monospace">open(&quot;/usr/lib64/libibverbs.so.1&quot;, O_RDONLY) = 14</font></div></div><div><div><font face="monospace, monospace">open(&quot;/usr/lib64/libibverbs.so.1&quot;, O_RDONLY) = 14</font></div></div></blockquote><br><div>Configure command arguments (other than --prefix):</div><div><blockquote style="margin:0px 0px 0px 40px;border:none;padding:0px"><div><font face="monospace, monospace">--enable-debug</font><span style="font-family:monospace,monospace"> --with-tm=/usr/syscom/opt/torque/4.1.1 </span><span style="font-family:monospace,monospace">CC=icc CXX=icpc FC=ifort</span></div></blockquote></div><div><br></div><div>I tried your work-around, changing the dlsym() call to look for the versioned symbol.</div><div>I *did* eliminate the &quot;XRC error:&quot; message, but the modex recv failure message remains.</div><div><br></div><div>I am not an expert on linkers/loaders, but I have my doubts that this check will ever detect a real mismatch, since both the symbols you check for are referenced explicitly in the code.</div><div><br></div><div>Regardless of any other factors, I think you should NOT be using the dlsym() check if not using shared libs, including in the --disable-dlopen and --disable-shared cases.</div><div><br></div><div>Also, I noticed that you don&#39;t have a dlclose(lib) call in mca_btl_openib_xrc_check_api().</div><div><br></div><div>-Paul</div><div class="gmail_extra"><br><div class="gmail_quote">On Fri, Jul 24, 2015 at 11:55 PM, Gilles Gouaillardet <span dir="ltr">&lt;<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;gilles.gouaillardet@gmail.com&#39;);" target="_blank">gilles.gouaillardet@gmail.com</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex">Paul,<div><br></div><div>this test is here to gracefully disable the opening btl if ompi was built with recent ofed, but is running with an old version (or the other way around)</div><div><br></div><div>I recently got a similar false positive when ompi was configure&#39;d with static libraries only.</div>in this case, a workaround was to dlsym the versionned symbol (e.g. ibv_create_xrc_recv_qp@@IBVERBS_1.1 )<div><br></div><div>that works just fine if ompi is configured with dynamic libraries.</div><div><br></div><div>I do not know how to fix that :-(</div><div><br></div><div>I can add an mac to make this test optional.</div><div>I can dlsym both versionned and non versionned symbols, but I do not know an elegant way to figure out what the versionned symbol name is.</div><div><br></div><div>mpirun -np 2 strace -e open a.out</div><div>will tell you which libibverbs.so is used</div><div><br></div><div>first, I invite you to confirm this is a bug and not an environment issue.</div><div>how did you configure ompi ?</div><div>can you give a try to my workaround ?</div><div><br></div><div>any suggestions on how to fix this is welcome.</div><div>if not, the test can be made optional via a MCA param, or be simply removed</div><div><br></div><div>Cheers,</div><div><br></div><div>Gilles<br><div><div><div><br>On Saturday, July 25, 2015, Paul Hargrove &lt;<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;phhargrove@lbl.gov&#39;);" target="_blank">phhargrove@lbl.gov</a>&gt; wrote:<br></div></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr"><div><div>I know Gilles and I went to a fair amount of effort to get configure detection of &quot;older&quot; XRC working again for 1.8.7 (having been broken in 1.8.5 and 1.8.6).</div></div><div><div><div>However, I had tested on configuring and building the XRC support, but had not *run* it (because my test scripts execute on the login node with no IB interfaces).<div><br></div><div>What I saw today when 1.10.0rc2 (and confirmed in 1.8.7) on the actual compute nodes is the following:</div><div><br></div></div></div><div><div><div><div><font face="monospace, monospace">mpirun -np 2 examples/ring_c&#39;</font></div><div><font face="monospace, monospace">[c0869][[27518,1],1][/global/homes/h/hargrove/GSCRATCH/OMPI/openmpi-1.8.7-linux-x86_64-icc-11.1/openmpi-1.8.7/ompi/mca/btl/openib/btl_openib_proc.c:155:mca_btl_openib_proc_create] [/global/homes/h/hargrove/GSCRATCH/OMPI/openmpi-1.8.7-linux-x86_64-icc-11.1/openmpi-1.8.7/ompi/mca/btl/openib/btl_openib_proc.c:155] ompi_modex_recv failed for peer [[27518,1],0]</font></div><div><font face="monospace, monospace">Process 0 sending 10 to 1, tag 201 (2 processes in ring)</font></div><div><font face="monospace, monospace">Process 0 sent to 1</font></div><div><font face="monospace, monospace">Process 0 decremented value: 9</font></div><div><font face="monospace, monospace">Process 0 decremented value: 8</font></div><div><font face="monospace, monospace">Process 0 decremented value: 7</font></div><div><font face="monospace, monospace">Process 0 decremented value: 6</font></div><div><font face="monospace, monospace">Process 0 decremented value: 5</font></div><div><font face="monospace, monospace">Process 0 decremented value: 4</font></div><div><font face="monospace, monospace">Process 0 decremented value: 3</font></div><div><font face="monospace, monospace">Process 0 decremented value: 2</font></div><div><font face="monospace, monospace">Process 0 decremented value: 1</font></div><div><font face="monospace, monospace">Process 0 decremented value: 0</font></div><div><font face="monospace, monospace">Process 0 exiting</font></div><div><font face="monospace, monospace">Process 1 exiting</font></div><div><font face="monospace, monospace">[c0869][[27518,1],1][/global/homes/h/hargrove/GSCRATCH/OMPI/openmpi-1.8.7-linux-x86_64-icc-11.1/openmpi-1.8.7/ompi/mca/btl/openib/btl_openib_xrc.c:57:mca_btl_openib_xrc_check_api] XRC error: bad XRC API (require XRC from OFED pre 3.12).</font></div><div><br></div><div><br></div><div>There are TWO things in there:</div><div>+ the modex failure</div><div>+ the &quot;bad XRC API&quot; error</div><div><br></div><div>I don&#39;t know what the source of the modex failure may be, but the &quot;bad XRC API&quot; message is from the following:</div><div><br></div><div><div><font face="monospace, monospace">    if (NULL != dlsym(lib, &quot;ibv_create_xrc_rcv_qp&quot;)) {</font></div><div><font face="monospace, monospace">        BTL_ERROR((&quot;XRC error: bad XRC API (require XRC from OFED pre 3.12).&quot;));</font></div><div><font face="monospace, monospace">        return false;</font></div><div><font face="monospace, monospace">    }</font></div></div><div><br></div><div>Yet, the symbol *is* in /usr/lib64/libibverbs.so:</div><div><br></div><div><div><font face="monospace, monospace">$ objdump -T /usr/lib64/libibverbs.so | grep ibv_create_xrc_rcv_qp</font></div><div><font face="monospace, monospace">0000000000009bd0 g    DF .text  0000000000000033  IBVERBS_1.1 ibv_create_xrc_rcv_qp</font></div></div><div><br></div><div><br></div><div>HOWEVER, there are other OFED installs on this system which are NOT in LD_LIBRARY_PATH.</div><div>None of those contain ibv_create_xrc_rcv_qp.</div><div><br></div><div><div>I am hoping this is some weird environment problem, but don&#39;t know how to test that theory.</div></div><div><div>If I can determine that /usr/lib64/libibverbs.so is *not* the library being loaded, then at least I know this is not an Open MPI problem.</div></div><div>So, how can I actually determine which libibverbs is getting loaded at runtime?</div><div>Is there some mca parameter that would help?</div><div><br></div><div>-Paul</div><div><br></div><div><br></div></div></div><div><br clear="all"><span><font color="#888888"><div><br></div>-- <br></font></span><div><div dir="ltr"><div><font face="courier new, monospace"><span><font color="#888888"><div>Paul H. Hargrove                          <a>PHHargrove@lbl.gov</a></div></font></span><span><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: <a href="tel:%2B1-510-495-2352" value="+15104952352" target="_blank">+1-510-495-2352</a></div><div>Lawrence Berkeley National Laboratory     Fax: <a href="tel:%2B1-510-486-6900" value="+15104866900" target="_blank">+1-510-486-6900</a></div></span></font></div></div></div>
</div></div></div></div>
</blockquote></div></div>
<br>_______________________________________________<br>
devel mailing list<br>
<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;devel@open-mpi.org&#39;);" target="_blank">devel@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel" rel="noreferrer" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2015/07/17705.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/devel/2015/07/17705.php</a><br></blockquote></div><br><br clear="all"><div><br></div>-- <br><div><div dir="ltr"><div><font face="courier new, monospace"><div>Paul H. Hargrove                          <a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;PHHargrove@lbl.gov&#39;);" target="_blank">PHHargrove@lbl.gov</a></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: +1-510-495-2352</div><div>Lawrence Berkeley National Laboratory     Fax: +1-510-486-6900</div></font></div></div></div>
</div></div>
</blockquote></div>

