<div dir="ltr">Back in February I reported (<a href="http://www.open-mpi.org/community/lists/devel/2015/02/17073.php">http://www.open-mpi.org/community/lists/devel/2015/02/17073.php</a>) that when building master on Linux with the Solaris Studio compilers and -m32 I saw the following:<div><br></div><div><font face="monospace, monospace"><span style="color:rgb(0,0,0);font-size:12px">/bin/sh ../../../libtool --tag=CC --mode=link cc -m32 -g -mt </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px"> -export-dynamic -o opal_wrapper opal_wrapper.o ../../../opal/ </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px"><a href="http://libopen-pal.la">libopen-pal.la</a> -lrt -lm -lutil -lrt -lm -lutil </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px">libtool: link: cc -m32 -g -mt -o .libs/opal_wrapper opal_wrapper.o </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px">-Wl,--export-dynamic ../../../opal/.libs/libopen-pal.so -ldl -lrt -lm </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px">-lutil -mt -Wl,-rpath </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px">-Wl,/scratch/phargrov/OMPI/openmpi-master-linux-x86_64-ss12u4-m32/INST/lib </span><br style="color:rgb(0,0,0);font-size:12px"><span style="color:rgb(0,0,0);font-size:12px">../../../opal/.libs/libopen-pal.so: undefined reference to `ebx&#39; </span></font><br></div><div><br></div><div>Where obviously &#39;ebx&#39; should be a register, not a symbol.</div><div><br></div><div>Nobody got back to me on that, but I figured it out this morning.</div><div>The 2-line patch below fixed this issue for me.<br></div><div><br></div><div>It looks like the gcc asm syntax for multiple assembler dialects (search for &quot;dialects&quot; in <a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html</a>) is not supported by the Studio compilers.</div><div>Since there doesn&#39;t appear to be any real effort to support Intel asm syntax (vs the ATT syntax used by gas) elsewhere in Open MPI, it is kind of pointless to do it just in this one header.<br></div><div>So, I believe that the &quot;{l}&quot; on the changed lines can/should also be changed to bare &quot;l&quot;.</div><div><br></div><div><br></div><div>On a related note:</div><div>As of gcc-5.1 (released in April), ebx is now scheduled as an other register and not reserved to be the GOT pointer.</div><div>So, the</div><div><font face="monospace, monospace">    xchgl %%ebx, %1</font></div><div>could (I think) now become</div><div><font face="monospace, monospace">    xchgl  %%ebx,%%ebx</font></div><div>which is not going to have the desired effect of preserving %ebx across the cpuid instruction.</div><div>However the problem only occurs if &quot;b&quot; is a member of the &quot;r&quot; class, which I have not verified.</div><div>*IF* the problem can occur, then one fix would be to change &quot;=r&quot; to something like &quot;=SD&quot;.</div><div><br></div><div>-Paul<br clear="all"><div><br></div><div><br></div><div><div><font face="monospace, monospace">--- opal/include/opal/sys/ia32/timer.h.orig     2015-07-01 08:12:59.357980816 -0700</font></div><div><font face="monospace, monospace">+++ opal/include/opal/sys/ia32/timer.h  2015-07-01 07:59:36.452918286 -0700</font></div><div><font face="monospace, monospace">@@ -35,9 +35,9 @@</font></div><div><font face="monospace, monospace">     int tmp;</font></div><div><font face="monospace, monospace"> </font></div><div><font face="monospace, monospace">     __asm__ __volatile__(</font></div><div><font face="monospace, monospace">-                         &quot;xchg{l} {%%}ebx, %1\n&quot;</font></div><div><font face="monospace, monospace">+                         &quot;xchg{l} %%ebx, %1\n&quot;</font></div><div><font face="monospace, monospace">                          &quot;cpuid\n&quot;</font></div><div><font face="monospace, monospace">-                         &quot;xchg{l} {%%}ebx, %1\n&quot;</font></div><div><font face="monospace, monospace">+                         &quot;xchg{l} %%ebx, %1\n&quot;</font></div><div><font face="monospace, monospace">                          &quot;rdtsc\n&quot;</font></div><div><font face="monospace, monospace">                          : &quot;=A&quot;(ret), &quot;=r&quot;(tmp)</font></div><div><font face="monospace, monospace">                          :: &quot;ecx&quot;);</font></div></div><div><br></div><div><br></div>-- <br><div class="gmail_signature"><div dir="ltr"><div><font face="courier new, monospace"><div>Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: +1-510-495-2352</div><div>Lawrence Berkeley National Laboratory     Fax: +1-510-486-6900</div></font></div></div></div>
</div></div>

