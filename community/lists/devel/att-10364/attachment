<html><head></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; ">Yes, I missed that point before - too early in the morning :-/<div><br></div><div>As I said in my last note, it would be nice to either have a flag indicating we are bound, or see all the cpu info so we can compute that we are bound. Either way, we still need to have a complete picture of all I/O devices so you can compute the distance.</div><div><br></div><div><br><div><div>On Feb 9, 2012, at 6:01 AM, <a href="mailto:nadia.derbey@bull.net">nadia.derbey@bull.net</a> wrote:</div><br class="Apple-interchange-newline"><blockquote type="cite"><font size="3">&nbsp;</font>
<br>
<br><tt><font size="2"><a href="mailto:devel-bounces@open-mpi.org">devel-bounces@open-mpi.org</a> wrote on 02/09/2012 01:32:31
PM:<br>
<br>
&gt; De : Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org">rhc@open-mpi.org</a>&gt;</font></tt>
<br><tt><font size="2">&gt; A : Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a>&gt;</font></tt>
<br><tt><font size="2">&gt; Date : 02/09/2012 01:32 PM</font></tt>
<br><tt><font size="2">&gt; Objet : Re: [OMPI devel] btl/openib: get_ib_dev_distance
doesn't see<br>
&gt; processes as bound if the job has been launched by srun</font></tt>
<br><tt><font size="2">&gt; Envoyé par : <a href="mailto:devel-bounces@open-mpi.org">devel-bounces@open-mpi.org</a></font></tt>
<br><tt><font size="2">&gt; <br>
&gt; Hi Nadia</font></tt>
<br><tt><font size="2">&gt; <br>
&gt; I'm wondering what value there is in showing the full topology, or
<br>
&gt; using it in any of our components, if the process is restricted to
a<br>
&gt; specific set of cpus? Does it really help to know that there are <br>
&gt; other cpus out there that are unreachable?</font></tt>
<br>
<br><tt><font size="2">Ralph,</font></tt>
<br>
<br><tt><font size="2">The intention here is not to show cpus that are unreachable,
but to fix an issue we have at least in get_ib_dev_distance() in the openib
btl.</font></tt>
<br>
<br><tt><font size="2">The problem is that if a process is restricted to
a single CPU, the algorithm used in get_ib_dev_distance doesn't work at
all:</font></tt>
<br><tt><font size="2">I have 2 ib interfaces on my victim (say mlx4_0 and
mlx4_1), and I want the openib btl to select the one that is the closest
to my rank.</font></tt>
<br>
<br><tt><font size="2">As I said in my first e-mail, here is what is done
today:</font></tt>
<br><tt><font size="2">&nbsp; &nbsp;. opal_paffinity_base_get_processor_info()
is called to get the number of logical processors (we get 1 due to the
singleton cpuset)<br>
 &nbsp; . we loop over that # of processors to check whether our process
is bound to one of them. In our case the loop will be executed only once
and we will never get the correct binding information.<br>
 &nbsp; . if the process is bound actually get the distance to the device.<br>
 &nbsp; &nbsp; &nbsp; &nbsp;in our case, the distance won't be computed
and mlx4_0 will be seen as "equivalent" to mlx4_1 in terms of
distances. This is what I definitely want to avoid.</font></tt>
<br>
<br><tt><font size="2">Regards,</font></tt>
<br><tt><font size="2">Nadia</font></tt>
<br>
<br><tt><font size="2">&gt; <br>
&gt; On Feb 9, 2012, at 5:15 AM, <a href="mailto:nadia.derbey@bull.net">nadia.derbey@bull.net</a> wrote:</font></tt>
<br><tt><font size="2">&gt; <br>
&gt; &nbsp; <br>
&gt; <br>
&gt; <a href="mailto:devel-bounces@open-mpi.org">devel-bounces@open-mpi.org</a> wrote on 02/09/2012 12:20:41 PM:<br>
&gt; <br>
&gt; &gt; De : Brice Goglin &lt;<a href="mailto:Brice.Goglin@inria.fr">Brice.Goglin@inria.fr</a>&gt; <br>
&gt; &gt; A : Open MPI Developers &lt;<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a>&gt; <br>
&gt; &gt; Date : 02/09/2012 12:20 PM <br>
&gt; &gt; Objet : Re: [OMPI devel] btl/openib: get_ib_dev_distance doesn't
see<br>
&gt; &gt; processes as bound if the job has been launched by srun <br>
&gt; &gt; Envoyé par : <a href="mailto:devel-bounces@open-mpi.org">devel-bounces@open-mpi.org</a> <br>
&gt; &gt; <br>
&gt; &gt; By default, hwloc only shows what's inside the current cpuset.
There's<br>
&gt; &gt; an option to show everything instead (topology flag). <br>
&gt; <br>
&gt; So may be using that flag inside <br>
&gt; opal_paffinity_base_get_processor_info() would be a better fix than
<br>
&gt; the one I'm proposing in my patch. <br>
&gt; <br>
&gt; I found a bunch of other places where things are managed as in <br>
&gt; get_ib_dev_distance(). <br>
&gt; <br>
&gt; Just doing a grep in the sources, I could find: <br>
&gt; &nbsp; . init_maffinity() in btl/sm/btl_sm.c <br>
&gt; &nbsp; . vader_init_maffinity() in btl/vader/btl_vader.c <br>
&gt; &nbsp; . get_ib_dev_distance() in btl/wv/btl_wv_component.c <br>
&gt; <br>
&gt; So I think the flag Brice is talking about should definitely be the
fix. <br>
&gt; <br>
&gt; Regards, <br>
&gt; Nadia <br>
&gt; <br>
&gt; &gt; <br>
&gt; &gt; Brice<br>
&gt; &gt; <br>
&gt; &gt; <br>
&gt; &gt; <br>
&gt; &gt; Le 09/02/2012 12:18, Jeff Squyres a écrit :<br>
&gt; &gt; &gt; Just so that I understand this better -- if a process is
bound in <br>
&gt; &gt; a cpuset, will tools like hwloc's lstopo only show the Linux
<br>
&gt; &gt; processors *in that cpuset*? &nbsp;I.e., does it not have any
visibility <br>
&gt; &gt; of the processors outside of its cpuset?<br>
&gt; &gt; &gt;<br>
&gt; &gt; &gt;<br>
&gt; &gt; &gt; On Jan 27, 2012, at 11:38 AM, nadia.derbey wrote:<br>
&gt; &gt; &gt;<br>
&gt; &gt; &gt;&gt; Hi,<br>
&gt; &gt; &gt;&gt;<br>
&gt; &gt; &gt;&gt; If a job is launched using "srun --resv-ports --cpu_bind:..."
and slurm<br>
&gt; &gt; &gt;&gt; is configured with:<br>
&gt; &gt; &gt;&gt; &nbsp; TaskPlugin=task/affinity<br>
&gt; &gt; &gt;&gt; &nbsp; TaskPluginParam=Cpusets<br>
&gt; &gt; &gt;&gt;<br>
&gt; &gt; &gt;&gt; each rank of that job is in a cpuset that contains a
single CPU.<br>
&gt; &gt; &gt;&gt;<br>
&gt; &gt; &gt;&gt; Now, if we use carto on top of this, the following happens
in<br>
&gt; &gt; &gt;&gt; get_ib_dev_distance() (in btl/openib/btl_openib_component.c):<br>
&gt; &gt; &gt;&gt; &nbsp; . opal_paffinity_base_get_processor_info() is
called to get the<br>
&gt; &gt; &gt;&gt; &nbsp; &nbsp; number of logical processors (we get 1
due to the singleton cpuset)<br>
&gt; &gt; &gt;&gt; &nbsp; . we loop over that # of processors to check
whether our process is<br>
&gt; &gt; &gt;&gt; &nbsp; &nbsp; bound to one of them. In our case the
loop will be executed only<br>
&gt; &gt; &gt;&gt; &nbsp; &nbsp; once and we will never get the correct
binding information.<br>
&gt; &gt; &gt;&gt; &nbsp; . if the process is bound actually get the distance
to the device.<br>
&gt; &gt; &gt;&gt; &nbsp; &nbsp; in our case we won't execute that part
of the code.<br>
&gt; &gt; &gt;&gt;<br>
&gt; &gt; &gt;&gt; The attached patch is a proposal to fix the issue.<br>
&gt; &gt; &gt;&gt;<br>
&gt; &gt; &gt;&gt; Regards,<br>
&gt; &gt; &gt;&gt; Nadia<br>
&gt; &gt; &gt;&gt; <br>
&gt; &lt;get_ib_dev_distance.patch&gt;_______________________________________________<br>
&gt; &gt; &gt;&gt; devel mailing list<br>
&gt; &gt; &gt;&gt; <a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>
&gt; &gt; &gt;&gt; </font></tt><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel"><tt><font size="2">http://www.open-mpi.org/mailman/listinfo.cgi/devel</font></tt></a><tt><font size="2"><br>
&gt; &gt; &gt;<br>
&gt; &gt; <br>
&gt; &gt; _______________________________________________<br>
&gt; &gt; devel mailing list<br>
&gt; &gt; <a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>
&gt; &gt; </font></tt><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel"><tt><font size="2">http://www.open-mpi.org/mailman/listinfo.cgi/devel</font></tt></a><tt><font size="2"><br>
&gt; _______________________________________________<br>
&gt; devel mailing list<br>
&gt; <a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>
&gt; </font></tt><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel"><tt><font size="2">http://www.open-mpi.org/mailman/listinfo.cgi/devel</font></tt></a>
<br><tt><font size="2">&gt; _______________________________________________<br>
&gt; devel mailing list<br>
&gt; <a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>
&gt; </font></tt><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel"><tt><font size="2">http://www.open-mpi.org/mailman/listinfo.cgi/devel</font></tt></a>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel</blockquote></div><br></div></body></html>
