<html><head><meta http-equiv="Content-Type" content="text/html charset=windows-1252"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><br><div><div>On Dec 15, 2013, at 12:08 PM, George Bosilca &lt;<a href="mailto:bosilca@icl.utk.edu">bosilca@icl.utk.edu</a>&gt; wrote:</div><br class="Apple-interchange-newline"><blockquote type="cite"><div style="font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;">On Dec 15, 2013, at 14:36 , Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org">rhc@open-mpi.org</a>&gt; wrote:<br><br><blockquote type="cite">Sure you can - just find the ompi_proc_t without setting the thread lock since (as you point out) it is already being held.<br></blockquote><br>This is hardly thread-safe for all the cases where this function is not called while owning the lock (aka all the modules).<br></div></blockquote><div><br></div>Fair enough - we can use the other option.<br><blockquote type="cite"><div style="font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br><blockquote type="cite">Or we could pass the ompi_proc_t into the call, if necessary. Either way should work.<br></blockquote><br>There is already the orte_process_name_t on the call, as it is the only information needed.<br><br>To be extremely clear, there is no need to alter the current code, it is correct by all means. The first thing we do after the modex_exchange is going in the second stage of the ompi_proc setup (ompi_proc_complete_init) where the first call is for retrieving the proc_hostname from the database. The code I removed was 1) totally superfluous and 2) completely broken on multi-threaded scenarios.<br></div></blockquote><div><br></div>Not true, George - look more closely at the code. We only retrieve the hostname if the number of procs is low. Otherwise, we do *not* retrieve it until we do a modex_recv, and thus the debug is now broken at scale. This was required for scalable launch, which is something I know is important to you as well.</div><div><br></div><div>Modifying the API isn't a big deal, so why the fuss? Let's just change it and get the debug working again.</div><div><br></div><div><br><blockquote type="cite"><div style="font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br>&nbsp;George.<br><br><br><blockquote type="cite"><br>On Dec 15, 2013, at 11:30 AM, George Bosilca &lt;<a href="mailto:bosilca@icl.utk.edu">bosilca@icl.utk.edu</a>&gt; wrote:<br><br><blockquote type="cite">The current code is correct. If the goal is to continue to retrieve the proc_name in a call that is asking for something else, I don’t see how you can remove this circular dependency between setting and using the ompi_procs.<br><br>George.<br><br>On Dec 15, 2013, at 13:52 , Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org">rhc@open-mpi.org</a>&gt; wrote:<br><br><blockquote type="cite">Okay - then let's correct the code rather than lose the debug. I'll fix that problem.<br><br>Thanks<br>Ralph<br><br>On Dec 15, 2013, at 9:54 AM, George Bosilca &lt;<a href="mailto:bosilca@icl.utk.edu">bosilca@icl.utk.edu</a>&gt; wrote:<br><br><blockquote type="cite">I understand your reasons but the code as it was in the trunk is not correct. In most of the cases when you reach one of the ompi_rte_db_fetch calls, you are setting up an ompi_proc … which means you own the ompi_proc_lock mutex. As the ompi_rte_db_fetch was calling back into the proc infrastructure to find a proc, it was deadlocking on acquiring the ompi_proc_lock mutex as locking this mutex it is the first thing ompi_proc_find is doing.<br><br>A quick grep indicates that most places where the proc_hostname is used are capable of handling NULL, so avoiding a deadlock in exchange for few hostname replaced by NULL in the output seemed like a acceptable approach to me.<br><br>George.<br><br>On Dec 15, 2013, at 12:18 , Ralph Castain &lt;<a href="mailto:rhc@open-mpi.org">rhc@open-mpi.org</a>&gt; wrote:<br><br><blockquote type="cite">This actually creates a bit of a problem. The reason we did this was because the OMPI-layer "show-help" calls want to report the hostname of the proc. Since we don't retrieve that info by default, the show-help calls all fail due to a NULL pointer.<br><br>Nathan tried wrapping all the show-help calls with a modex-fetch of hostname, but that isn't a good solution as the fetch might fail depending on the problem we are trying to report.<br><br>We also noted that the modex recv's current implemented all fetched the complete RTE-level info whenever any info was requested for that proc. So the fetch of the hostname was a very low cost operation.<br><br>So we decided to always ensure we load the hostname info if it hasn't already been done, thus keeping the show-help operations functional.<br><br>Make sense? Or do you have an alternative method?<br>Ralph<br><br><br>On Dec 15, 2013, at 8:54 AM, <a href="mailto:svn-commit-mailer@open-mpi.org">svn-commit-mailer@open-mpi.org</a> wrote:<br><br><blockquote type="cite">Author: bosilca (George Bosilca)<br>Date: 2013-12-15 11:54:01 EST (Sun, 15 Dec 2013)<br>New Revision: 29917<br>URL: <a href="https://svn.open-mpi.org/trac/ompi/changeset/29917">https://svn.open-mpi.org/trac/ompi/changeset/29917</a><br><br>Log:<br>Don't be greedy, just do what we asked for.<br><br>Text files modified:<span class="Apple-converted-space">&nbsp;</span><br>trunk/ompi/mca/rte/orte/rte_orte_module.c | &nbsp;&nbsp;&nbsp;15 --------------- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>1 files changed, 0 insertions(+), 15 deletions(-)<br><br>Modified: trunk/ompi/mca/rte/orte/rte_orte_module.c<br>==============================================================================<br>--- trunk/ompi/mca/rte/orte/rte_orte_module.c<span class="Apple-tab-span" style="white-space: pre;">	</span>Sun Dec 15 11:49:27 2013<span class="Apple-tab-span" style="white-space: pre;">	</span>(r29916)<br>+++ trunk/ompi/mca/rte/orte/rte_orte_module.c<span class="Apple-tab-span" style="white-space: pre;">	</span>2013-12-15 11:54:01 EST (Sun, 15 Dec 2013)<span class="Apple-tab-span" style="white-space: pre;">	</span>(r29917)<br>@@ -153,11 +153,6 @@<br>if (OPAL_SUCCESS != (rc = opal_db.fetch((opal_identifier_t*)nm, key, data, type))) {<br>&nbsp;&nbsp;return rc;<br>}<br>- &nbsp;&nbsp;&nbsp;/* update the hostname */<br>- &nbsp;&nbsp;&nbsp;proct = ompi_proc_find(nm);<br>- &nbsp;&nbsp;&nbsp;if (NULL == proct-&gt;proc_hostname) {<br>- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opal_db.fetch_pointer((opal_identifier_t*)nm, ORTE_DB_HOSTNAME, (void**)&amp;proct-&gt;proc_hostname, OPAL_STRING);<br>- &nbsp;&nbsp;&nbsp;}<br>return OMPI_SUCCESS;<br>}<br><br>@@ -171,11 +166,6 @@<br>if (OPAL_SUCCESS != (rc = opal_db.fetch_pointer((opal_identifier_t*)nm, key, data, type))) {<br>&nbsp;&nbsp;return rc;<br>}<br>- &nbsp;&nbsp;&nbsp;/* update the hostname */<br>- &nbsp;&nbsp;&nbsp;proct = ompi_proc_find(nm);<br>- &nbsp;&nbsp;&nbsp;if (NULL == proct-&gt;proc_hostname) {<br>- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opal_db.fetch_pointer((opal_identifier_t*)nm, ORTE_DB_HOSTNAME, (void**)&amp;proct-&gt;proc_hostname, OPAL_STRING);<br>- &nbsp;&nbsp;&nbsp;}<br>return OMPI_SUCCESS;<br>}<br><br>@@ -191,11 +181,6 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPAL_SCOPE_GLOBAL, key, kvs))) {<br>&nbsp;&nbsp;return rc;<br>}<br>- &nbsp;&nbsp;&nbsp;/* update the hostname */<br>- &nbsp;&nbsp;&nbsp;proct = ompi_proc_find(nm);<br>- &nbsp;&nbsp;&nbsp;if (NULL == proct-&gt;proc_hostname) {<br>- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opal_db.fetch_pointer((opal_identifier_t*)nm, ORTE_DB_HOSTNAME, (void**)&amp;proct-&gt;proc_hostname, OPAL_STRING);<br>- &nbsp;&nbsp;&nbsp;}<br>return OMPI_SUCCESS;<br>}<br><br>_______________________________________________<br>svn mailing list<br><a href="mailto:svn@open-mpi.org">svn@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/svn<br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel<br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel<br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel<br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/devel<br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br></blockquote><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br><a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a></div></blockquote></div><br></body></html>
