<div dir="ltr">Alexey,<div><br></div><div>There is a conceptual different between GET and WAIT: one can return NULL while the other cannot. If you want a solution with do {} while, I think the best place is specifically in the PML OB1 recv functions (around the OMPI_FREE_LIST_GET_MT) and not inside the OMPI_FREE_LIST_GET_MT  macro itself.</div><div><br></div><div>  George.</div><div><br></div></div><div class="gmail_extra"><br><div class="gmail_quote">On Thu, Sep 17, 2015 at 2:35 AM, Алексей Рыжих <span dir="ltr">&lt;<a href="mailto:avryzhikh@compcenter.org" target="_blank">avryzhikh@compcenter.org</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div lang="RU" link="blue" vlink="purple"><div><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">George,</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Thank you for response.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">In my opinion our solution with do/while() loop  in  </span><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">OMPI_FREE_LIST_GET_MT  is better for our MPI+OpenMP hybrid application than using OMPI_FREE_LIST_WAIT_MT.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Because in case OMPI_FREE_LIST_WAIT_MT MPI_Irecv()  will be suspended in opal_progress() until one of MPI_Irecv() requests  from other thread is completed.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">And it is not the case when the list reached   free_list_max_num  limit. The situation is that the threads consumed   all items from free list   before one other thread completed ompi_free_list_grow() and that thread executing  ompi_free_list_grow() got NULL.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Sorry for my poor English.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Alexey.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;">From:</span></b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"> devel [mailto:<a href="mailto:devel-bounces@open-mpi.org" target="_blank">devel-bounces@open-mpi.org</a>] <b>On Behalf Of </b>George Bosilca<br><b>Sent:</b> Wednesday, September 16, 2015 10:18 PM</span></p><div><div class="h5"><br><b>To:</b> Open MPI Developers<br><b>Subject:</b> Re: [OMPI devel] The issue with OMPI_FREE_LIST_GET_MT()</div></div><p></p><div><div class="h5"><p class="MsoNormal"> </p><div><div><div><p class="MsoNormal">On Wed, Sep 16, 2015 at 3:11 PM, Владимир Трущин &lt;<a href="mailto:vdtruschin@compcenter.org" target="_blank">vdtruschin@compcenter.org</a>&gt; wrote:</p><div><div><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Sorry, “We saw the following problem in OMPI_FREE_LIST_GET_MT…”.</span></p></div></div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal">That&#39;s exactly what the WAIT macro is supposed to solve, wait (grow the freelist and call opal_progress) until an item become available.</p></div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal">  George.</p></div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal"> </p></div><blockquote style="border:none;border-left:solid #cccccc 1.0pt;padding:0cm 0cm 0cm 6.0pt;margin-left:4.8pt;margin-right:0cm"><div><div><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><div><div style="border:none;border-top:solid #b5c4df 1.0pt;padding:3.0pt 0cm 0cm 0cm"><p class="MsoNormal"><b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;">From:</span></b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"> Владимир Трущин [mailto:<a href="mailto:vdtruschin@compcenter.org" target="_blank">vdtruschin@compcenter.org</a>] <br><b>Sent:</b> Wednesday, September 16, 2015 10:09 PM<br><b>To:</b> &#39;Open MPI Developers&#39;<br><b>Subject:</b> RE: [OMPI devel] The issue with OMPI_FREE_LIST_GET_MT()</span></p></div></div><p class="MsoNormal"> </p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">George,</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">You are right. The sequence of calls in our test is MPI_Irecv -&gt; mca_pml_ob1_irecv -&gt; MCA_PML_OB1_RECV_REQUEST_ALLOC. We will try to use OMPI_FREE_LIST_WAIT_MT.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">We saw the following problem in OMPI_FREE_LIST_WAIT_MT. It returned NULL in case when thread A was suspended after the call of  ompi_free_list_grow. At this time others threads took all items from free list at the first call of opal_atomic_lifo_pop in macro. So, when thread A was unsuspended and call the second opal_atomic_lifo_pop in macro - it returned NULL.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Best regards,</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d">Vladimir.</span></p><p class="MsoNormal"><span lang="EN-US" style="font-size:11.0pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d"> </span></p><p class="MsoNormal"><b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;">From:</span></b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"> devel [<a href="mailto:devel-bounces@open-mpi.org" target="_blank">mailto:devel-bounces@open-m<span lang="RU">pi.org</span></a></span><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;">] <b>On Behalf Of </b>George Bosilca<br><b>Sent:</b> Wednesday, September 16, 2015 7:00 PM<br><b>To:</b> Open MPI Developers<br><b>Subject:</b> Re: [OMPI devel] The issue with OMPI_FREE_LIST_GET_MT()</span></p><p class="MsoNormal"> </p><div><p class="MsoNormal">Alexey,</p><div><div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal">This is not necessarily the fix for all cases. Most of the internal uses of the free_list can easily accommodate to the fact that no more elements are available. Based on your description of the problem I would assume you encounter this problem once the MCA_PML_OB1_RECV_REQUEST_ALLOC is called. In this particular case the problem is that fact that we call OMPI_FREE_LIST_GET_MT and that the upper level is unable to correctly deal with the case where the returned item is NULL. In this particular case the real fix is to use the blocking version of the free_list accessor (similar to the case for send) OMPI_FREE_LIST_WAIT_MT.</p></div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal">It is also possible that I misunderstood your problem. IF the solution above doesn&#39;t work can you describe exactly where the NULL return of the OMPI_FREE_LIST_GET_MT is creating an issue?</p></div><div><p class="MsoNormal"> </p></div><div><p class="MsoNormal">George.</p></div><div><p class="MsoNormal"> </p></div></div></div></div><div><div><div><p class="MsoNormal"> </p><div><p class="MsoNormal">On Wed, Sep 16, 2015 at 9:03 AM, Алексей Рыжих &lt;<a href="mailto:avryzhikh@compcenter.org" target="_blank">avryzhikh@compcenter.org</a>&gt; wrote:</p><div><div><p class="MsoNormal"><span lang="EN-US">Hi all,</span></p><p class="MsoNormal"><span lang="EN-US">We experimented with MPI+OpenMP hybrid application (MPI_THREAD_MULTIPLE support level)  where several threads submits a lot of MPI_Irecv() requests simultaneously and encountered an intermittent bug OMPI_ERR_TEMP_OUT_OF_RESOURCE after MCA_PML_OB1_RECV_REQUEST_ALLOC()  because  OMPI_FREE_LIST_GET_MT()  returned NULL.  Investigating this bug we found that sometimes the thread calling ompi_free_list_grow()  don’t have any free items in LIFO list at exit because other threads  retrieved  all new items at opal_atomic_lifo_pop()  </span></p><p class="MsoNormal"><span lang="EN-US">So we suggest to change OMPI_FREE_LIST_GET_MT() as below:</span></p><p class="MsoNormal"><span lang="EN-US"> </span></p><p class="MsoNormal"><span lang="EN-US">#define OMPI_FREE_LIST_GET_MT(fl, item)                                                                \</span></p><p class="MsoNormal"><span lang="EN-US">    {                                                                                             \</span></p><p class="MsoNormal"><span lang="EN-US">        item = (ompi_free_list_item_t*) opal_atomic_lifo_pop(&amp;((fl)-&gt;super));             \</span></p><p class="MsoNormal"><span lang="EN-US">        if( OPAL_UNLIKELY(NULL == item) ) {                                               \</span></p><p class="MsoNormal"><span lang="EN-US">            if(opal_using_threads()) {                                                    \</span></p><p class="MsoNormal"><span lang="EN-US">                int rc;                                                                   \</span></p><p class="MsoNormal"><span lang="EN-US">                opal_mutex_lock(&amp;((fl)-&gt;fl_lock));                                        \</span></p><p class="MsoNormal"><span lang="EN-US">                do                                                                        \</span></p><p class="MsoNormal"><span lang="EN-US">                {                                                                         \</span></p><p class="MsoNormal"><span lang="EN-US">                    rc = ompi_free_list_grow((fl), (fl)-&gt;fl_num_per_alloc);               \</span></p><p class="MsoNormal"><span lang="EN-US">                    if( OPAL_UNLIKELY(rc != OMPI_SUCCESS)) break;                         \</span></p><p class="MsoNormal"><span lang="EN-US">                                                                                          \</span></p><p class="MsoNormal"><span lang="EN-US">                    item = (ompi_free_list_item_t*) opal_atomic_lifo_pop(&amp;((fl)-&gt;super)); \</span></p><p class="MsoNormal"><span lang="EN-US">                                                                                          \</span></p><p class="MsoNormal"><span lang="EN-US">                } while (!item);                                                          \</span></p><p class="MsoNormal"><span lang="EN-US">                opal_mutex_unlock(&amp;((fl)-&gt;fl_lock));                                      \</span></p><p class="MsoNormal"><span lang="EN-US">            } else {                                                                      \</span></p><p class="MsoNormal"><span lang="EN-US">                ompi_free_list_grow((fl), (fl)-&gt;fl_num_per_alloc);                        \</span></p><p class="MsoNormal"><span lang="EN-US">                item = (ompi_free_list_item_t*) opal_atomic_lifo_pop(&amp;((fl)-&gt;super));     \</span></p><p class="MsoNormal"><span lang="EN-US">            } /* opal_using_threads() */                                                  \</span></p><p class="MsoNormal"><span lang="EN-US">        } /* NULL == item */                                                              \</span></p><p class="MsoNormal"><span lang="EN-US">    }</span></p><p class="MsoNormal"><span lang="EN-US"> </span></p><p class="MsoNormal"><span lang="EN-US"> </span></p><p class="MsoNormal"><span lang="EN-US">Another workaround is to increase the value of  pml_ob1_free_list_inc parameter.</span></p><p class="MsoNormal"><span lang="EN-US"> </span></p><p class="MsoNormal"><span lang="EN-US">Regards,</span></p><p class="MsoNormal"><span lang="EN-US">Alexey</span></p><p class="MsoNormal"><span lang="EN-US"> </span></p></div></div><p class="MsoNormal"><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2015/09/18039.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2015/09/18039.php</a></p></div><p class="MsoNormal"> </p></div></div></div></div></div><p class="MsoNormal"><br>_______________________________________________<br>devel mailing list<br><a href="mailto:devel@open-mpi.org" target="_blank">devel@open-mpi.org</a><br>Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2015/09/18054.php" target="_blank">http://www.open-mpi.org/community/lists/devel/2015/09/18054.php</a></p></blockquote></div><p class="MsoNormal"> </p></div></div></div></div></div></div>
<br>_______________________________________________<br>
devel mailing list<br>
<a href="mailto:devel@open-mpi.org">devel@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/devel" rel="noreferrer" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/devel</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/devel/2015/09/18061.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/devel/2015/09/18061.php</a><br></blockquote></div><br></div>

