<html><head><meta http-equiv="Content-Type" content="text/html charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;" class=""><br class=""><div><blockquote type="cite" class=""><div class="">On Nov 6, 2014, at 1:39 PM, Nathan Hjelm &lt;<a href="mailto:hjelmn@lanl.gov" class="">hjelmn@lanl.gov</a>&gt; wrote:</div><br class="Apple-interchange-newline"><div class="">On Thu, Nov 06, 2014 at 04:29:44PM -0500, Joshua Ladd wrote:<br class=""><blockquote type="cite" class=""> &nbsp;&nbsp;On Thursday, November 6, 2014, Nathan Hjelm &lt;<a href="mailto:hjelmn@lanl.gov" class="">hjelmn@lanl.gov</a>&gt; wrote:<br class=""><br class=""> &nbsp;&nbsp;&nbsp;&nbsp;On Thu, Nov 06, 2014 at 04:06:23PM -0500, Joshua Ladd wrote:<br class=""><blockquote type="cite" class=""> &nbsp;&nbsp;Nathan,<br class=""> &nbsp;&nbsp;Has this bug always been present in OpenIB or is this a recent<br class=""></blockquote> &nbsp;&nbsp;&nbsp;&nbsp;addition?<br class=""><blockquote type="cite" class=""> &nbsp;&nbsp;If this is regression, I would also be inclined to say that this is<br class=""></blockquote> &nbsp;&nbsp;&nbsp;&nbsp;a<br class=""><br class=""> &nbsp;&nbsp;&nbsp;&nbsp;The bug is as old as the message coalescing feature in the openib<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;btl. When the feature was added the openib btl no longer supported<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;calling btl_free on descriptors allocated by sendi (a serious bug).<br class=""><br class=""><blockquote type="cite" class=""> &nbsp;&nbsp;blocker for 1.8.4. This is a SIGNIFICANT bug. Both Howard and I<br class=""></blockquote> &nbsp;&nbsp;&nbsp;&nbsp;were quite<br class=""><blockquote type="cite" class=""> &nbsp;&nbsp;surprised that all the while this code has been in use at LANL<br class=""> &nbsp;&nbsp;in production systems, this issue was never discovered.<br class=""></blockquote><br class=""> &nbsp;&nbsp;&nbsp;&nbsp;Don't know why it suddenly came up but in 1.8.1 we added a inline send<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;optimization to the MPI_Isend path. The optimization uses the btl_sendi<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;function to get the fragment on the wire without allocating a send<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;request. If this fails the btl fragment returned by sendi is released<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;with btl_free, a send request is allocated, and the normal send path is<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;used. The optimization was tested with the openib btl so I don't know<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;why this wasn't caught earlier. My guess is some other change may have<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;triggered it.<br class=""><br class=""> &nbsp;&nbsp;&nbsp;&nbsp;We fixed the bug in 1.8.4 by totally disabling message coalescing. The<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;feature is meant to game the osu_mbw_mr test and does next to nothing<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;for real apps. Additionally, the inline send optimization makes the<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;feature less of a win with osu_mbw_mr anyway. We beat mvapich handily on<br class=""> &nbsp;&nbsp;&nbsp;&nbsp;LANL systems without message coalescing.<br class=""><br class=""> &nbsp;&nbsp;[josh] Can you point to the PR, Nathan? I didn't realize this was already<br class=""> &nbsp;&nbsp;addressed in the 1.8.4 prerelease. I would seek Howard's guidance as to<br class=""> &nbsp;&nbsp;whether this is an acceptable solution for LANL. &nbsp;Regardless of your<br class=""> &nbsp;&nbsp;opinion about the utility of MC, real decisions are made on the basis of<br class=""> &nbsp;&nbsp;those benchmarks, so I'm not entirely convinced of your argument<br class=""> &nbsp;&nbsp;here. &nbsp;OMPI, as we are all aware tends to be a target on the basis of<br class=""> &nbsp;&nbsp;these comparisons. <br class=""></blockquote><br class="">This was already discussed here. On LANL systems the message rates are<br class="">the same with and without the message coalescing "feature" so we are<br class="">turning it off and disabling it for 1.8.4. As for the PR. It looks like<br class="">Ralph has not merged it into 1.8.4 yet.<br class=""></div></blockquote><div><br class=""></div>Correct - it is still pending review/comment. Youâ€™ll find it here:</div><div><br class=""></div><div><a href="https://github.com/open-mpi/ompi-release/pull/79" class="">https://github.com/open-mpi/ompi-release/pull/79</a></div><div><br class=""></div><div><br class=""><blockquote type="cite" class=""><div class=""><br class="">-Nathan<br class="">_______________________________________________<br class="">devel mailing list<br class=""><a href="mailto:devel@open-mpi.org" class="">devel@open-mpi.org</a><br class="">Subscription: http://www.open-mpi.org/mailman/listinfo.cgi/devel<br class="">Link to this post: http://www.open-mpi.org/community/lists/devel/2014/11/16253.php</div></blockquote></div><br class=""></body></html>
