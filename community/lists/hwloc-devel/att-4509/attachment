<div dir="ltr">Brice,<div><br></div><div>I am glad you asked me to test widely, because I did find 2 compilers that rejected my version with &quot;=r&quot; and one that generated bad code for that case.</div><div>However, the original &quot;=S&quot; works everywhere I could test (list of 26 compilers below), as did &quot;=D&quot; and &quot;=SD&quot;.</div><div>Since the &quot;=SD&quot; constraint gives the compiler more choices than the other two, it should be preferred:</div><div><br></div><div><div><font face="monospace, monospace">#elif defined(HWLOC_X86_32_ARCH)</font></div><div><font face="monospace, monospace">  __asm__(</font></div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div><div><font face="monospace, monospace">  &quot;cpuid\n\t&quot;</font></div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div><div><font face="monospace, monospace">  : &quot;=a&quot; (*eax), &quot;=SD&quot; (*ebx), &quot;=c&quot; (*ecx), &quot;=d&quot; (*edx)</font></div><div><font face="monospace, monospace">  : &quot;0&quot; (*eax), &quot;2&quot; (*ecx));</font></div><div><font face="monospace, monospace">#else</font></div></div><div><font face="monospace, monospace"><br></font></div>The tested platforms and compilers include the oldest and newest gcc, icc, pgcc and suncc versions I could find with x86 support.<div>Unfortunately my Solaris/x86 platform is currently down.</div><div><br></div><div>-Paul<br><br>The list:</div><div><br><div>Red Hat Linux 8.0 (32-bit host)</div><div>  gcc 2.96</div><div>  gcc (GCC) 3.2 20020903 (Red Hat Linux 8.0 3.2-7)</div><div><div>  gcc (GCC) 6.0.0 20150706 [a development snapshot]</div></div><div><br></div><div>OpenSuSE 10.2 (32-bit host)</div><div>  gcc (GCC) 4.1.2 20061115 (prerelease) (SUSE Linux)</div><div><br></div><div>Scientific Linux 5.5 (-m32 on 64-bit host)</div><div>  pgi 9.0-4</div><div>  pgi 13.10-0</div><div>  pgi 14.10-0</div><div>  icc (ICC) 11.1 20100414</div><div>  icc (ICC) 14.0.2 20140120</div><div><br></div><div>Scientific Linux 6.6 (-m32 on 64-bit host)</div><div>  gcc (GCC) 4.4.7 20120313 (Red Hat 4.4.7-11)</div><div>  clang version 3.4.2 (tags/RELEASE_34/dot2-final)</div><div>  Open64 Compiler Suite: Version 4.5.2.1</div><div>  Sun C 5.12 Linux_i386 2011/11/16 [a.k.a. Solaris Studio 12.3]</div><div>  Sun C 5.13 Linux_i386 2014/10/20 [a.k.a. Solaris Studio 12.4]</div><div><br></div><div>Scientific Linux 6.6 (32-bit host)<br></div><div>  gcc (GCC) 4.4.7 20120313 (Red Hat 4.4.7-11)<br></div><div><br></div><div>Debian Jessie</div><div>  gcc (Debian 4.9.2-10) 4.9.2</div><div><br></div><div>Ubuntu 12.04.5 (-m32 on 64-bit host)<br></div><div>  icc (ICC) 15.0.3 20150407</div><div><br></div><div>Ubuntu 14.04.02 (-m32 on 64-bit host)</div><div>  Sun Ceres C 5.10 Linux_i386 2009/03/06 [a.k.a. Studio Express 03/09]</div><div>  Sun C 5.11 Linux_i386 2010/08/13 [a.k.a. Solaris Studio 12.2]</div><div><br></div><div>Mac OS X 10.5 (64-bit host, but 32-bit is default target)</div><div>  i686-apple-darwin9-gcc-4.0.1 (GCC) 4.0.1 (Apple Inc. build 5465)</div><div><br></div><div>Mac OS X 10.6 (-m32 on 64-bit host)</div><div>  gcc 4.2.1 (Apple Inc. build 5646)</div><div><br></div><div>Mac OS X 10.8 (-m32 on 64-bit host)</div><div>  Apple LLVM version 4.2 (clang-425.0.28) (based on LLVM 3.2svn)</div><div>  i686-apple-darwin11-llvm-gcc-4.2 (GCC) 4.2.1 (Based on Apple Inc. build 5658) (LLVM build 2336.11.00)</div><div><br></div><div>NetBSD 6.1.5 (32-bit host)</div><div>  gcc (NetBSD nb2 20110806) 4.5.3</div><div><br></div><div>OpenBSD 5.7 (32-bit host)</div><div>  gcc (GCC) 4.2.1 20070719</div><div><br></div><div>FreeBSD 10.1 (32-bit host)</div><div>  FreeBSD clang version 3.4.1 (tags/RELEASE_34/dot1-final 208032) 20140512</div><br><br><br></div></div><div class="gmail_extra"><br><div class="gmail_quote">On Tue, Jul 21, 2015 at 11:22 AM, Paul Hargrove <span dir="ltr">&lt;<a href="mailto:phhargrove@lbl.gov" target="_blank">phhargrove@lbl.gov</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">Brice,<div><br></div><div>I don&#39;t have anywhere near the testing coverage for Linux on x86 as I do on x86-64.</div><div>However, I will see what I can do.</div><span class="HOEnZb"><font color="#888888"><div><br></div><div>-Paul</div></font></span></div><div class="HOEnZb"><div class="h5"><div class="gmail_extra"><br><div class="gmail_quote">On Tue, Jul 21, 2015 at 4:24 AM, Brice Goglin <span dir="ltr">&lt;<a href="mailto:brice.goglin@inria.fr" target="_blank">brice.goglin@inria.fr</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div>Thanks.<br>
Could you test this new asm on all your systems/compilers? I don&#39;t want break that fragile code again.<br>
Brice<br><br><div class="gmail_quote"><div><div>Le 21 juillet 2015 08:17:06 UTC+02:00, Paul Hargrove &lt;<a href="mailto:phhargrove@lbl.gov" target="_blank">phhargrove@lbl.gov</a>&gt; a écrit :</div></div><blockquote class="gmail_quote" style="margin:0pt 0pt 0pt 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div><div>
<div dir="ltr">Oops - send the wrong asm code.<div>While &quot;=S&quot; is correct for the second constraint, I meant to send a version that had &quot;=r&quot; because it allows the compiler more choices.</div><div><br></div><div>-Paul</div></div><div class="gmail_extra"><br><div class="gmail_quote">On Mon, Jul 20, 2015 at 11:12 PM, Paul Hargrove <span dir="ltr">&lt;<a href="mailto:phhargrove@lbl.gov" target="_blank">phhargrove@lbl.gov</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">PGI-14.10 for 32-bit targets fails in the same manner as 13.7, 13.9 and 13.10.<div><br></div><div>I believe the following inline x86 asm is correct and more robust than the existing code that pgi appears to reject:</div><div><br></div><div><div><font face="monospace, monospace">#elif defined(HWLOC_X86_32_ARCH)</font></div><div><font face="monospace, monospace">  __asm__(</font></div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div><div><font face="monospace, monospace">  &quot;cpuid\n\t&quot;</font></div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div><div><font face="monospace, monospace">  : &quot;=a&quot; (*eax), &quot;=S&quot; (*ebx), &quot;=c&quot; (*ecx), &quot;=d&quot; (*edx)</font></div><div><font face="monospace, monospace">  : &quot;0&quot; (*eax), &quot;2&quot; (*ecx));</font></div><div><font face="monospace, monospace">#else</font></div><span><font color="#888888"></font><div><font color="#888888"><br></font></div><div>-Paul</div></span></div></div><div><div><div class="gmail_extra"><br><div class="gmail_quote">On Mon, Jul 20, 2015 at 9:50 PM, Paul Hargrove <span dir="ltr">&lt;<a href="mailto:phhargrove@lbl.gov" target="_blank">phhargrove@lbl.gov</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">Pavan,<div><br></div><div>I can confirm that I see the same with PGI-13.10.</div><div><br></div><div>I have a couple systems with 14.x installed but neither with 32-bit support.</div><div>I am downloading 32-bit support now (which I am assuming will work with the existing license) and will report back.</div><div><br></div><div>-Paul</div></div><div class="gmail_extra"><br><div class="gmail_quote"><span>On Mon, Jul 20, 2015 at 9:00 PM, Balaji, Pavan <span dir="ltr">&lt;<a href="mailto:balaji@anl.gov" target="_blank">balaji@anl.gov</a>&gt;</span> wrote:<br></span><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><span>Hello,<br>
<br>
The hwloc-1.11 build seems to fail with the pgi compiler on 32-bit platforms.  I see the following error:<br>
<br>
----8&lt;----<br>
  CC       topology-x86.lo<br>
PGC-F-0000-Internal compiler error. unable to allocate a register       8 (topology-x86.c: 87)<br>
PGC/x86 Linux 13.9-0: compilation aborted<br>
----8&lt;----<br>
<br>
I only tried pgi-13.7 and 13.9 (I don&#39;t have access to later compiler versions).  It looks like the compiler doesn&#39;t like the assembly code in include/private/cpuid-x86.h for 32-bit platforms.<br>
<br>
<br>
<br>
Thanks,<br>
<br>
  -- Pavan<br>
<br>
_______________________________________________<br>
hwloc-devel mailing list<br>
</span><a href="mailto:hwloc-devel@open-mpi.org" target="_blank">hwloc-devel@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/hwloc-devel" rel="noreferrer" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/hwloc-devel</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/hwloc-devel/2015/07/4501.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/hwloc-devel/2015/07/4501.php</a><span><font color="#888888"><br>
</font></span></blockquote></div><span><font color="#888888"><br><br clear="all"></font><div><font color="#888888"><br></font></div>-- <br><div><div dir="ltr"><div><font face="courier new, monospace"></font><div><font face="courier new, monospace">Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></font></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: <a href="tel:%2B1-510-495-2352" value="+15104952352" target="_blank">+1-510-495-2352</a></div><div>Lawrence Berkeley National Laboratory     Fax: <a href="tel:%2B1-510-486-6900" value="+15104866900" target="_blank">+1-510-486-6900</a></div></div></div></div>
</span></div>
</blockquote></div><br><br clear="all"><div><br></div>-- <br><div><div dir="ltr"><div><font face="courier new, monospace"></font><div><font face="courier new, monospace">Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></font></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: <a href="tel:%2B1-510-495-2352" value="+15104952352" target="_blank">+1-510-495-2352</a></div><div>Lawrence Berkeley National Laboratory     Fax: <a href="tel:%2B1-510-486-6900" value="+15104866900" target="_blank">+1-510-486-6900</a></div></div></div></div>
</div>
</div></div></blockquote></div><br><br clear="all"><div><br></div>-- <br><div><div dir="ltr"><div><font face="courier new, monospace"></font><div><font face="courier new, monospace">Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></font></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: <a href="tel:%2B1-510-495-2352" value="+15104952352" target="_blank">+1-510-495-2352</a></div><div>Lawrence Berkeley National Laboratory     Fax: <a href="tel:%2B1-510-486-6900" value="+15104866900" target="_blank">+1-510-486-6900</a></div></div></div></div>
</div>
<p style="margin-top:2.5em;margin-bottom:1em;border-bottom:1px solid #000"></p></div></div><pre><div><div><hr><br>hwloc-devel mailing list<br><a href="mailto:hwloc-devel@open-mpi.org" target="_blank">hwloc-devel@open-mpi.org</a><br>Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/hwloc-devel" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/hwloc-devel</a><br></div></div>Link to this post: <a href="http://www.open-mpi.org/community/lists/hwloc-devel/2015/07/4505.php" target="_blank">http://www.open-mpi.org/community/lists/hwloc-devel/2015/07/4505.php</a></pre></blockquote></div></div></blockquote></div><br><br clear="all"><div><br></div>-- <br><div><div dir="ltr"><div><font face="courier new, monospace"><div>Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: <a href="tel:%2B1-510-495-2352" value="+15104952352" target="_blank">+1-510-495-2352</a></div><div>Lawrence Berkeley National Laboratory     Fax: <a href="tel:%2B1-510-486-6900" value="+15104866900" target="_blank">+1-510-486-6900</a></div></font></div></div></div>
</div>
</div></div></blockquote></div><br><br clear="all"><div><br></div>-- <br><div class="gmail_signature"><div dir="ltr"><div><font face="courier new, monospace"><div>Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: +1-510-495-2352</div><div>Lawrence Berkeley National Laboratory     Fax: +1-510-486-6900</div></font></div></div></div>
</div>

