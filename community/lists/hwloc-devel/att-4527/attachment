<div dir="ltr"><br><div class="gmail_extra"><br><div class="gmail_quote">On Tue, Jul 28, 2015 at 3:05 PM, Samuel Thibault <span dir="ltr">&lt;<a href="mailto:samuel.thibault@inria.fr" target="_blank">samuel.thibault@inria.fr</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><span class="">Paul Hargrove, le Tue 28 Jul 2015 15:00:36 -0700, a écrit :<br>
&gt; Well, for the compiler that accepted the &quot;=r&quot; form and then generated code that<br>
&gt; SEGV&#39;d I would say &quot;buggy&quot;.<br>
<br>
</span>I would like to see the generated code before saying anything, since<br>
it&#39;s so easy to write bogus inline assembly and being completely unable<br>
to see the issue before seeing the bogus generated code :)<br></blockquote><div><br></div><div>The compiler I have characterized as &quot;buggy&quot; is Solaris Studio 12.2 for Linux (&quot;Sun C 5.11 Linux_i386 2010/08/13&quot;):</div><div><br></div><div>Previously I only had a bunch of SEGVs from &quot;make check&quot; to support that.</div><div>However, now I have the generated code that Samuel requested to support that conclusion.</div><div><br></div><div>The inline asm I had originally tested that lead to that characterization was:</div></div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div class="gmail_quote"><div><div><font face="monospace, monospace">  __asm__(</font></div></div></div></div><div class="gmail_extra"><div class="gmail_quote"><div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div></div></div></div><div class="gmail_extra"><div class="gmail_quote"><div><div><font face="monospace, monospace">  &quot;cpuid\n\t&quot;</font></div></div></div></div><div class="gmail_extra"><div class="gmail_quote"><div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div></div></div></div><div class="gmail_extra"><div class="gmail_quote"><div><div><font face="monospace, monospace">  : &quot;=a&quot; (*eax), &quot;=r&quot; (*ebx), &quot;=c&quot; (*ecx), &quot;=d&quot; (*edx)</font></div></div></div></div><div class="gmail_extra"><div class="gmail_quote"><div><div><font face="monospace, monospace">  : &quot;0&quot; (*eax), &quot;2&quot; (*ecx));</font></div></div></div></div></blockquote><div class="gmail_extra"><div class="gmail_quote"><div><br></div><div>And retesting that asm today, I find the following generated code:</div></div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><font face="monospace, monospace">$ objdump -d src/.libs/libhwloc.so | grep -C1 -w cpuid<br>   5f5c5:       87 d3                   xchg   %edx,%ebx<br>   5f5c7:       0f a2                   cpuid  <br>   5f5c9:       87 d3                   xchg   %edx,%ebx</font></blockquote><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div class="gmail_quote"><div> </div></div></div></blockquote><div class="gmail_extra"><div>So the compiler chose %edx for the 2nd output, even though is is explicitly used for the 4th output.</div><div>I don&#39;t see how that could ever be correct.</div><div><br></div><div>I tried adding the early-clobbers (&quot;=&amp;&quot; vs &quot;=&quot;):</div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div><div class="gmail_extra"><div class="gmail_quote"><font face="monospace, monospace">  : &quot;=a&quot; (*eax), &quot;=r&amp;&quot; (*ebx), &quot;=c&quot; (*ecx), &quot;=&amp;d&quot; (*edx)</font></div></div></div></div></blockquote><div class="gmail_extra"><div><div class="gmail_extra"><div class="gmail_quote"><div></div></div></div></div><div><br></div><div>But the same bogus code is generated.</div><div><br></div><div><br></div><div>We already know the following &quot;final&quot; asm works on this system (on all the systems I tested):</div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div><div><font face="monospace, monospace">  __asm__(</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">  &quot;mov %%ebx,%1\n\t&quot;</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">  &quot;cpuid\n\t&quot;</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">  &quot;xchg %%ebx,%1\n\t&quot;</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">  : &quot;+a&quot; (*eax), &quot;=&amp;SD&quot; (*ebx), &quot;+c&quot; (*ecx), &quot;=&amp;d&quot; (*edx));</font></div></div><div><font face="monospace, monospace"><br></font></div></div></blockquote><div class="gmail_extra"><div>But I tried changing &quot;SD&quot; to &quot;r&quot;:</div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div><div><font face="monospace, monospace">  : &quot;+a&quot; (*eax), &quot;=&amp;r&quot; (*ebx), &quot;+c&quot; (*ecx), &quot;=&amp;d&quot; (*edx));</font></div></div></div></blockquote><div class="gmail_extra"><div><font face="monospace, monospace"><br></font></div><div><font face="arial, helvetica, sans-serif">And we again see %edx being chosen for two outputs:</font></div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><font face="monospace, monospace">$ objdump -d src/.libs/libhwloc.so | grep -C1 -w cpuid<br></font><font face="monospace, monospace">   5f5b3:       8b d3                   mov    %ebx,%edx<br></font><font face="monospace, monospace">   5f5b5:       0f a2                   cpuid  <br></font><font face="monospace, monospace">   5f5b7:       87 d3                   xchg   %edx,%ebx</font></blockquote><div class="gmail_extra"><div><div style="font-family:arial,helvetica,sans-serif"><br></div></div><div style="font-family:arial,helvetica,sans-serif"><br></div><div style="font-family:arial,helvetica,sans-serif"><br></div><div style="font-family:arial,helvetica,sans-serif">It is also worth pointing out that the first asm in this email was never a real candidate because it also resulted in build failures on a couple gcc versions:</div><div style="font-family:arial,helvetica,sans-serif"><br></div><div style="font-family:arial,helvetica,sans-serif">With &quot;gcc (GCC) 4.4.7 20120313 (Red Hat 4.4.7-11)&quot; on Scientific Linux 6.6 (RHEL clone like CentOS):</div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div><div><font face="monospace, monospace">libtool: compile:  gcc -DHAVE_CONFIG_H -I. -I/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/src </font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">-I../include/private/autogen -I../include/hwloc/autogen -I/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/BLD/</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">include -I/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include -DHWLOC_INSIDE_LIBHWLOC -DHWLOC</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">_PLUGINS_PATH=\&quot;/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/INST/lib/hwloc\&quot; -fvisibility=hidden -g -O2 -M</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">T topology-x86.lo -MD -MP -MF .deps/topology-x86.Tpo -c /home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">1.11.0/src/topology-x86.c  -fPIC -DPIC -o .libs/topology-x86.o</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/src/topology-x86.c: In function ?look_proc?:</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: can&#39;t find a register in class ?CLOBBERED_REGS? while reloading ?asm?</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">/home/phargrov/OMPI/hwloc-1.11.0-linux-x86-sl6x/hwloc-1.11.0/include/private/cpuid-x86.h:75: error: ?asm? operand has impossible constraints</font></div></div></div><div class="gmail_extra"><div><div><font face="monospace, monospace">make[1]: *** [topology-x86.lo] Error 1</font></div></div><div><font face="monospace, monospace"><br></font></div></div></blockquote><div class="gmail_extra">And with &quot;gcc (GCC) 3.2 20020903 (Red Hat Linux 8.0 3.2-7)&quot; on Red Hat Linux 8.0:</div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">libtool: compile:  gcc -DHAVE_CONFIG_H -I. -I/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/src -I../include/private/autogen -I../include/hwloc/autogen -I/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/BLD/include -I/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/include -DHWLOC_INSIDE_LIBHWLOC -DHWLOC_PLUGINS_PATH=\&quot;/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/INST/lib/hwloc\&quot; -g -O2 -MT topology-x86.lo -MD -MP -MF .deps/topology-x86.Tpo -c /home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/src/topology-x86.c  -fPIC -DPIC -o .libs/topology-x86.o</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/src/topology-x86.c: In function `look_proc&#39;:</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/include/private/cpuid-x86.h:75: can&#39;t find a register in class `Q_REGS&#39; while reloading `asm&#39;</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/include/private/cpuid-x86.h:75: can&#39;t find a register in class `Q_REGS&#39; while reloading `asm&#39;</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/include/private/cpuid-x86.h:75: can&#39;t find a register in class `Q_REGS&#39; while reloading `asm&#39;</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/include/private/cpuid-x86.h:75: can&#39;t find a register in class `Q_REGS&#39; while reloading `asm&#39;</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">/home/pcp1/phargrov/OMPI/hwloc-1.11.0-linux-x86-RH8/hwloc-1.11.0/include/private/cpuid-x86.h:75: can&#39;t find a register in class `Q_REGS&#39; while reloading `asm&#39;</font></div></div><div class="gmail_extra"><div class="gmail_extra"><font face="monospace, monospace">make[1]: *** [topology-x86.lo] Error 1</font></div></div></blockquote><div class="gmail_extra"><div style="font-family:arial,helvetica,sans-serif"><br></div><div style="font-family:arial,helvetica,sans-serif">These two are examples of &quot;poorly performing&quot; register allocators, as opposed to the *incorrect* one seen in Solaris Studio 12.2.</div><div style="font-family:arial,helvetica,sans-serif"><br></div><div>-Paul</div><div><br></div>-- <br><div class="gmail_signature"><div dir="ltr"><div><font face="courier new, monospace"><div>Paul H. Hargrove                          <a href="mailto:PHHargrove@lbl.gov" target="_blank">PHHargrove@lbl.gov</a></div><div>Computer Languages &amp; Systems Software (CLaSS) Group</div><div>Computer Science Department               Tel: +1-510-495-2352</div><div>Lawrence Berkeley National Laboratory     Fax: +1-510-486-6900</div></font></div></div></div>
</div></div>

