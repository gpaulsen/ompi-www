<div dir="ltr">Wouldn&#39;t this be partially available via <a href="https://github.com/open-mpi/ompi/pull/326">https://github.com/open-mpi/ompi/pull/326</a> in the trunk?<div><br></div><div>Of course the switch is not gathered from this, but it might work as an initial step towards what you seek Matt?</div></div><div class="gmail_extra"><br><div class="gmail_quote">2016-01-15 17:27 GMT+01:00 Ralph Castain <span dir="ltr">&lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt;</span>:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div style="word-wrap:break-word">Yes, we don’t propagate envars ourselves other than MCA params. You can ask mpirun to forward specific envars to every proc, but that would only push the same value to everyone, and that doesn’t sound like what you are looking for.<div><br></div><div>FWIW: we are working on adding the ability to directly query the info you are seeking - i.e., to ask for things like “which procs are on the same switch as me?”. Hoping to have it later this year, perhaps in the summer.</div><div><br></div><div><br><div><blockquote type="cite"><div><div class="h5"><div>On Jan 15, 2016, at 7:56 AM, Matt Thompson &lt;<a href="mailto:fortran@gmail.com" target="_blank">fortran@gmail.com</a>&gt; wrote:</div><br></div></div><div><div><div class="h5"><div dir="ltr">Ralph,<div><br></div><div>That doesn&#39;t help:</div><div><br></div><div><div>(1004) $ mpirun -map-by node -np 8 ./hostenv.x | sort -g -k2</div><div>Process    0 of    8 is on host borgo086</div><div>Process    0 of    8 is on processor borgo086</div><div>Process    1 of    8 is on host borgo086</div><div>Process    1 of    8 is on processor borgo140</div><div>Process    2 of    8 is on host borgo086</div><div>Process    2 of    8 is on processor borgo086</div><div>Process    3 of    8 is on host borgo086</div><div>Process    3 of    8 is on processor borgo140</div><div>Process    4 of    8 is on host borgo086</div><div>Process    4 of    8 is on processor borgo086</div><div>Process    5 of    8 is on host borgo086</div><div>Process    5 of    8 is on processor borgo140</div><div>Process    6 of    8 is on host borgo086</div><div>Process    6 of    8 is on processor borgo086</div><div>Process    7 of    8 is on host borgo086</div><div>Process    7 of    8 is on processor borgo140</div></div><div><br></div><div>But it was doing the right thing before. It saw my SLURM_* bits and correctly put 4 processes on the first node and 4 on the second (see the processor line which is from MPI, not the environment), and I only asked for 4 tasks per node:</div><div><br></div><div><div>SLURM_NODELIST=borgo[086,140]</div><div>SLURM_NTASKS_PER_NODE=4</div><div>SLURM_NNODES=2</div><div>SLURM_NTASKS=8</div><div>SLURM_TASKS_PER_NODE=4(x2)</div></div><div><br></div><div>My guess is no MPI stack wants to propagate an environment variable to every process. I&#39;m picturing an 1000 node/28000 core job...and poor Open MPI (or MPT or Intel MPI) would have to marshall 28000xN environment variables around and keep track of who gets what...</div><div><br></div><div>Matt</div><div><br></div></div><div class="gmail_extra"><br><div class="gmail_quote">On Fri, Jan 15, 2016 at 10:48 AM, Ralph Castain <span dir="ltr">&lt;<a href="mailto:rhc@open-mpi.org" target="_blank">rhc@open-mpi.org</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div style="word-wrap:break-word">Actually, the explanation is much simpler. You probably have more than 8 slots on borgj020, and so your job is simply small enough that we put it all on one host. If you want to force the job to use both hosts, add “-map-by node” to your cmd line<div><br></div><div><br><div><blockquote type="cite"><div><div><div>On Jan 15, 2016, at 7:02 AM, Jim Edwards &lt;<a href="mailto:jedwards@ucar.edu" target="_blank">jedwards@ucar.edu</a>&gt; wrote:</div><br></div></div><div><div><div><div dir="ltr" style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px"><div class="gmail_extra"><br><br><div class="gmail_quote">On Fri, Jan 15, 2016 at 7:53 AM, Matt Thompson<span> </span><span dir="ltr">&lt;<a href="mailto:fortran@gmail.com" target="_blank">fortran@gmail.com</a>&gt;</span><span> </span>wrote:<br><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr">All,<div><br></div><div>I&#39;m not too sure if this is an MPI issue, a Fortran issue, or something else but I thought I&#39;d ask the MPI gurus here first since my web search failed me.</div><div><br></div><div>There is a chance in the future I might want/need to query an environment variable in a Fortran program, namely to figure out what switch a currently running process is on (via SLURM_TOPOLOGY_ADDR in my case) and perhaps make a &quot;per-switch&quot; communicator.[1]</div><div><br></div><div>So, I coded up a boring Fortran program whose only exciting lines are:</div><div><br></div><div><div><font face="monospace, monospace">   call MPI_Get_Processor_Name(processor_name,name_length,ierror)</font></div><div><font face="monospace, monospace">   call get_environment_variable(&quot;HOST&quot;,host_name)</font></div><div><font face="monospace, monospace"><br></font></div><div><font face="monospace, monospace">   write (*,&#39;(A,X,I4,X,A,X,I4,X,A,X,A)&#39;) &quot;Process&quot;, myid, &quot;of&quot;, npes, &quot;is on processor&quot;, trim(processor_name)</font></div><div><font face="monospace, monospace">   write (*,&#39;(A,X,I4,X,A,X,I4,X,A,X,A)&#39;) &quot;Process&quot;, myid, &quot;of&quot;, npes, &quot;is on host&quot;, trim(host_name)</font></div></div><div><br></div><div>I decided to try out with the <font face="monospace, monospace">HOST</font> environment variable first because it is simple and different per node (I didn&#39;t want to take many, many nodes to find the point when a switch is traversed). I then grabbed two nodes with 4 processes per node and...:</div><div><br></div><div><div><font face="monospace, monospace">(1046) $ echo &quot;$SLURM_NODELIST&quot;</font></div><div><font face="monospace, monospace">borgj[020,036]</font></div><div><font face="monospace, monospace">(1047) $ pdsh -w &quot;$SLURM_NODELIST&quot; echo &#39;$HOST&#39;</font></div><div><font face="monospace, monospace">borgj036: borgj036<br></font></div><div><font face="monospace, monospace">borgj020: borgj020</font></div><div><font face="monospace, monospace">(1048) $ mpifort -o hostenv.x hostenv.F90</font></div><div><font face="monospace, monospace">(1049) $ mpirun -np 8 ./hostenv.x | sort -g -k2</font></div><div><font face="monospace, monospace">Process    0 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    0 of    8 is on processor borgj020</font></div><div><font face="monospace, monospace">Process    1 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    1 of    8 is on processor borgj020</font></div><div><font face="monospace, monospace">Process    2 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    2 of    8 is on processor borgj020</font></div><div><font face="monospace, monospace">Process    3 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    3 of    8 is on processor borgj020</font></div><div><font face="monospace, monospace">Process    4 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    4 of    8 is on processor borgj036</font></div><div><font face="monospace, monospace">Process    5 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    5 of    8 is on processor borgj036</font></div><div><font face="monospace, monospace">Process    6 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    6 of    8 is on processor borgj036</font></div><div><font face="monospace, monospace">Process    7 of    8 is on host borgj020</font></div><div><font face="monospace, monospace">Process    7 of    8 is on processor borgj036</font></div></div><div><br></div><div>It looks like MPI_Get_Processor_Name is doing its thing, but the HOST one seems to only be reflecting the first host. My guess is that OpenMPI doesn&#39;t export every processes&#39; environment separately to every process so it is reflecting HOST from process 0.</div><div><div class="gmail_default" style="font-family:&#39;comic sans ms&#39;,sans-serif;color:rgb(56,118,29)">​</div></div></div></blockquote><div><br></div><div><div class="gmail_default" style="font-family:&#39;comic sans ms&#39;,sans-serif;color:rgb(56,118,29)">​I would guess that what is actually happening is that slurm is exporting all of the variables from the host node including the $HOST variable and overwriting the ​</div><div class="gmail_default" style="font-family:&#39;comic sans ms&#39;,sans-serif;color:rgb(56,118,29)">​defaults on other nodes.   You should use the SLURM options to limit the list of </div><div class="gmail_default" style="font-family:&#39;comic sans ms&#39;,sans-serif;color:rgb(56,118,29)">variables that you export from the host to only those that you need.​</div><br></div><div><br></div><div> </div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr"><div><div class="gmail_default" style="font-family:&#39;comic sans ms&#39;,sans-serif;color:rgb(56,118,29)">​</div><br></div><div>So, I guess my question is: can this be done? Is there an option to Open MPI that might do it? Or is this just something MPI doesn&#39;t do? Or is my Google-fu just too weak to figure out the right search-phrase to find the answer to this probable FAQ?</div><div><br></div><div>Matt</div><div><br></div><div>[1] Note, this might be unnecessary, but I got to the point where I wanted to see if I *could* do it, rather than *should*.<span><font color="#888888"><br clear="all"><div><br></div>--<span> </span><br><div><div dir="ltr"><div><div dir="ltr"><div>Matt Thompson</div></div></div><blockquote style="margin:0px 0px 0px 40px;border:none;padding:0px"><div><div><div>Man Among Men</div></div></div><div><div><div>Fulcrum of History</div></div></div></blockquote></div></div></font></span></div></div><br>_______________________________________________<br>users mailing list<br><a href="mailto:users@open-mpi.org" target="_blank">users@open-mpi.org</a><br>Subscription:<span> </span><a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" rel="noreferrer" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>Link to this post:<span> </span><a href="http://www.open-mpi.org/community/lists/users/2016/01/28287.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/users/2016/01/28287.php</a><br></blockquote></div><br><br clear="all"><div><br></div>--<span> </span><br><div><div dir="ltr"><div><div><div>Jim Edwards<br><br></div><font size="1">CESM Software Engineer<br></font></div><font size="1">National Center for Atmospheric Research<br></font></div><font size="1">Boulder, CO</font><span> </span><br></div></div></div></div><span style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;float:none;display:inline!important">_______________________________________________</span><br style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px"><span style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;float:none;display:inline!important">users mailing list</span><br style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px"><a href="mailto:users@open-mpi.org" style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px" target="_blank">users@open-mpi.org</a><br style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px"><span style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;float:none;display:inline!important">Subscription:<span> </span></span><a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px"></div></div><span style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;float:none;display:inline!important">Link to this post:<span> </span></span><a href="http://www.open-mpi.org/community/lists/users/2016/01/28289.php" style="font-family:Helvetica;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px" target="_blank">http://www.open-mpi.org/community/lists/users/2016/01/28289.php</a></div></blockquote></div><br></div></div><br>_______________________________________________<br>
users mailing list<br>
<a href="mailto:users@open-mpi.org" target="_blank">users@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" rel="noreferrer" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/users/2016/01/28290.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/users/2016/01/28290.php</a><br></blockquote></div><br><br clear="all"><div><br></div>-- <br><div><div dir="ltr"><div><div dir="ltr"><div>Matt Thompson</div></div></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div><div><div>Man Among Men</div></div></div><div><div><div>Fulcrum of History</div></div></div></blockquote></div></div>
</div>
_______________________________________________<br>users mailing list<br><a href="mailto:users@open-mpi.org" target="_blank">users@open-mpi.org</a><br>Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br></div></div>Link to this post: <a href="http://www.open-mpi.org/community/lists/users/2016/01/28291.php" target="_blank">http://www.open-mpi.org/community/lists/users/2016/01/28291.php</a></div></blockquote></div><br></div></div><br>_______________________________________________<br>
users mailing list<br>
<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" rel="noreferrer" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/users/2016/01/28292.php" rel="noreferrer" target="_blank">http://www.open-mpi.org/community/lists/users/2016/01/28292.php</a><br></blockquote></div><br><br clear="all"><div><br></div>-- <br><div class="gmail_signature"><div dir="ltr"><div>Kind regards Nick</div></div></div>
</div>

