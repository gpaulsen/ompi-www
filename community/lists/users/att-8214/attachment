<table cellspacing="0" cellpadding="0" border="0" ><tr><td valign="top" style="font: inherit;"><div id="yiv1252175949">Dear all,<br><br>With this simple code I find I am getting a memory leak when I run on 2 processors.&nbsp; Can anyone advise why?<br><br>I'm fairly new to MPI (have only done very simple things in the past).&nbsp; I'm trying to do a non-blocking send/recv (from any proc to any proc) but the receiving processor doesn't know how much data it is going to be sent, hence the the blocking recv of the size in order to allocate the buffer.&nbsp; Is there a better way of doing this?<br><br>Thanks,<br><br>Mark<br><br>#include &lt;mpi.h&gt;<br><br>MPI_Request<br>nonBlockingSend(int *t, int size, const int tag, const int destinationRank)<br>{<br>&nbsp;&nbsp;&nbsp; MPI_Request request1;<br>&nbsp;&nbsp;&nbsp; MPI_Isend(&amp;size,1,MPI_INT,destinationRank,0,MPI_COMM_WORLD,&amp;request1);<br>&nbsp;&nbsp;&nbsp; MPI_Request request;<br>&nbsp;&nbsp;&nbsp;
 MPI_Isend(t,size,MPI_INT,destinationRank,tag,MPI_COMM_WORLD,&amp;request);<br>&nbsp;&nbsp;&nbsp; return request;<br>}<br><br>MPI_Request<br>nonBlockingRecv(int *&amp;t, int &amp;size, const int tag, const int senderRank)<br>{<br>&nbsp;&nbsp;&nbsp; MPI_Status s1;<br>&nbsp;&nbsp;&nbsp; MPI_Recv(&amp;size,1,MPI_INT,senderRank,0,MPI_COMM_WORLD,&amp;s1);<br>&nbsp;&nbsp;&nbsp; t = (int *) malloc(size*sizeof(int));<br>&nbsp;&nbsp;&nbsp; MPI_Request request;<br>&nbsp;&nbsp;&nbsp; MPI_Irecv(t,size,MPI_INT,senderRank,tag,MPI_COMM_WORLD,&amp;request);<br>&nbsp;&nbsp;&nbsp; return request;<br>}<br><br>void<br>communicationComplete(MPI_Request &amp;r)<br>{<br>&nbsp;&nbsp;&nbsp; MPI_Status status;<br>&nbsp;&nbsp;&nbsp; MPI_Wait(&amp;r,&amp;status);<br>}<br><br>void<br>barrier()<br>{<br>&nbsp;&nbsp;&nbsp; MPI_Barrier(MPI_COMM_WORLD);<br>}<br><br>int main(int argc, char *argv[])<br>{<br>&nbsp;&nbsp;&nbsp; MPI_Init(&amp;argc,&amp;argv);<br>&nbsp;&nbsp;&nbsp;
 <br>&nbsp;&nbsp;&nbsp; int numProcs,rank;<br>&nbsp;&nbsp;&nbsp; MPI_Comm_size(MPI_COMM_WORLD,&amp;numProcs);<br>&nbsp;&nbsp;&nbsp; MPI_Comm_rank(MPI_COMM_WORLD,&amp;rank);<br><br>&nbsp;&nbsp;&nbsp; int numIts = 10000000;<br>&nbsp;&nbsp;&nbsp; int bufSize = 10;<br><br>&nbsp;&nbsp;&nbsp; // Setup send buffers<br>&nbsp;&nbsp;&nbsp; int *sendData = (int *) malloc(bufSize*sizeof(int));<br>&nbsp;&nbsp;&nbsp; for(int i=0;i&lt;bufSize;i++)<br>&nbsp;&nbsp;&nbsp; sendData[i] = i;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; // Perform send and recvs<br>&nbsp;&nbsp;&nbsp; for(int i=0;i&lt;numIts;i++)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; if(rank==0)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; for(int proc = 1; proc&lt;numProcs;proc++)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; MPI_Request r = nonBlockingSend(sendData,bufSize,proc,proc);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
 communicationComplete(r);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; int *recvData;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; int size;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; MPI_Request r = nonBlockingRecv(recvData,size,rank,0);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; communicationComplete(r);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; free(recvData);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; barrier();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; free(sendData);<br><br>&nbsp;&nbsp;&nbsp; MPI_Finalize();<br><br>&nbsp;&nbsp;&nbsp; return 1;<br>}<br><br></div></td></tr></table><br>



      
