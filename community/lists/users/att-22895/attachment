<div>@Jeff, </div>
<div> </div>
<div> Well, it may have been &quot;just for giggles&quot;, but it Worked!! My helloWorld program ran as expected.  My original code ran through the initialization parts without overwriting data.  It will take a few days to finish computation and analysis to ensure it ran as expected.  I&#39;ll report back when I get done.</div>

<div> </div>
<div>It looks like a good Friday!</div>
<div> </div>
<div>Cheers,</div>
<div>--Jim<br><br></div>
<div class="gmail_quote">On Thu, Oct 31, 2013 at 4:06 PM, Jeff Squyres (jsquyres) <span dir="ltr">&lt;<a href="mailto:jsquyres@cisco.com" target="_blank">jsquyres@cisco.com</a>&gt;</span> wrote:<br>
<blockquote style="BORDER-LEFT:#ccc 1px solid;MARGIN:0px 0px 0px 0.8ex;PADDING-LEFT:1ex" class="gmail_quote">For giggles, try using MPI_STATUS_IGNORE (assuming you don&#39;t need to look at the status at all).  See if that works for you.<br>
<br>Meaning: I wonder if we&#39;re computing the status size for Fortran incorrectly in the -i8 case...<br>
<div>
<div class="h5"><br><br>On Oct 31, 2013, at 1:58 PM, Jim Parker &lt;<a href="mailto:jimparker96313@gmail.com">jimparker96313@gmail.com</a>&gt; wrote:<br><br>&gt; Some additional info that may jog some solutions.  Calls to MPI_SEND do not cause memory corruption.  Only calls to MPI_RECV.  Since the main difference is the fact that MPI_RECV needs a &quot;status&quot; array and SEND does not, seems to indicate to me that something is wrong with status.<br>
&gt;<br>&gt; Also, I can run a C version of the helloWorld program with no errors.  However, int types are only 4-byte.  To send 8byte integers, I define tempInt as long int and pass MPI_LONG as a type.<br>&gt;<br>&gt; @Jeff,<br>
&gt;   I got a copy of the openmpi conf.log.  See attached.<br>&gt;<br>&gt; Cheers,<br>&gt; --Jim<br>&gt;<br>&gt; On Wed, Oct 30, 2013 at 10:55 PM, Jim Parker &lt;<a href="mailto:jimparker96313@gmail.com">jimparker96313@gmail.com</a>&gt; wrote:<br>
&gt; Ok, all, where to begin...<br>&gt;<br>&gt; Perhaps I should start with the most pressing issue for me.  I need 64-bit indexing<br>&gt;<br>&gt; @Martin,<br>&gt;    you indicated that even if I get this up and running, the MPI library still uses signed 32-bit ints to count (your term), or index (my term) the recvbuffer lengths.  More concretely,<br>
&gt; in a call to MPI_Allgatherv( buffer, count, MPI_Integer, recvbuf, recv-count, displ, MPI_integer, MPI_COMM_WORLD, status, mpierr): count, recvcounts, and displs must be  32-bit integers, not 64-bit.  Actually, all I need is displs to hold 64-bit values...<br>
&gt; If this is true, then compiling OpenMPI this way is not a solution.  I&#39;ll have to restructure my code to collect 31-bit chunks...<br>&gt; Not that it matters, but I&#39;m not using DIRAC, but a custom code to compute circuit analyses.<br>
&gt;<br>&gt; @Jeff,<br>&gt;   Interesting, your runtime behavior has a different error than mine.  You have problems with the passed variable tempInt, which would make sense for the reasons you gave.  However, my problem involves the fact that the local variable &quot;rank&quot; gets overwritten by a memory corruption after MPI_RECV is called.<br>
&gt;<br>&gt; Re: config.log. I will try to have the admin guy recompile tomorrow and see if I can get the log for you.<br>&gt;<br>&gt; BTW, I&#39;m using the gcc 4.7.2 compiler suite on a Rocks 5.4 HPC cluster.  I use the options -m64 and -fdefault-integer-8<br>
&gt;<br>&gt; Cheers,<br>&gt; --Jim<br>&gt;<br>&gt;<br>&gt;<br>&gt; On Wed, Oct 30, 2013 at 7:36 PM, Martin Siegert &lt;<a href="mailto:siegert@sfu.ca">siegert@sfu.ca</a>&gt; wrote:<br>&gt; Hi Jim,<br>&gt;<br>&gt; I have quite a bit experience with compiling openmpi for dirac.<br>
&gt; Here is what I use to configure openmpi:<br>&gt;<br>&gt; ./configure --prefix=$instdir \<br>&gt;             --disable-silent-rules \<br>&gt;             --enable-mpirun-prefix-by-default \<br>&gt;             --with-threads=posix \<br>
&gt;             --enable-cxx-exceptions \<br>&gt;             --with-tm=$torquedir \<br>&gt;             --with-wrapper-ldflags=&quot;-Wl,-rpath,${instdir}/lib&quot; \<br>&gt;             --with-openib \<br>&gt;             --with-hwloc=$hwlocdir \<br>
&gt;             CC=gcc \<br>&gt;             CXX=g++ \<br>&gt;             FC=&quot;$FC&quot; \<br>&gt;             F77=&quot;$FC&quot; \<br>&gt;             CFLAGS=&quot;-O3&quot; \<br>&gt;             CXXFLAGS=&quot;-O3&quot; \<br>
&gt;             FFLAGS=&quot;-O3 $I8FLAG&quot; \<br>&gt;             FCFLAGS=&quot;-O3 $I8FLAG&quot;<br>&gt;<br>&gt; You need to set FC to either ifort or gfortran (those are the two compilers<br>&gt; that I have used) and set I8FLAG to -fdefault-integer-8 for gfortran or<br>
&gt; -i8 for ifort.<br>&gt; Set torquedir to the directory where torque is installed ($torquedir/lib<br>&gt; must contain libtorque.so), if you are running jobs under torque; otherwise<br>&gt; remove the --with-tm=... line.<br>
&gt; Set hwlocdir to the directory where you have hwloc installed. You many not<br>&gt; need the -with-hwloc=... option because openmpi comes with a hwloc version<br>&gt; (I don&#39;t have experience with that because we install hwloc independently).<br>
&gt; Set instdir to the directory where you what to install openmpi.<br>&gt; You may or may not need the --with-openib option depending on whether<br>&gt; you have an Infiniband interconnect.<br>&gt;<br>&gt; After configure/make/make install this so compiled version can be used<br>
&gt; with dirac without changing the dirac source code.<br>&gt; (there is one caveat: you should make sure that all &quot;count&quot; variables<br>&gt; in MPI calls in dirac are smaller than 2^31-1. I have run into a few cases<br>
&gt; when that is not the case; this problem can be overcome by replacing<br>&gt; MPI_Allreduce calls in dirac with a wrapper that calls MPI_Allreduce<br>&gt; repeatedly). This is what I use to setup dirac:<br>&gt;<br>&gt; export PATH=$instdir/bin<br>
&gt; ./setup --prefix=$diracinstdir \<br>&gt;         --fc=mpif90 \<br>&gt;         --cc=mpicc \<br>&gt;         --int64 \<br>&gt;         --explicit-libs=&quot;-lmkl_intel_ilp64 -lmkl_sequential -lmkl_core&quot;<br>&gt;<br>
&gt; where $instdir is the directory where you installed openmpi from above.<br>&gt;<br>&gt; I would never use the so-compiled openmpi version for anything other<br>&gt; than dirac though. I am not saying that it cannot work (at a minimum<br>
&gt; you need to compile Fortran programs with the appropriate I8FLAG),<br>&gt; but it is an unnecessary complication: I have not encountered a piece<br>&gt; of software other than dirac that requires this.<br>&gt;<br>&gt; Cheers,<br>
&gt; Martin<br>&gt;<br>&gt; --<br>&gt; Martin Siegert<br>&gt; Head, Research Computing<br>&gt; WestGrid/ComputeCanada Site Lead<br>&gt; Simon Fraser University<br>&gt; Burnaby, British Columbia<br>&gt; Canada<br>&gt;<br>&gt; On Wed, Oct 30, 2013 at 06:00:56PM -0500, Jim Parker wrote:<br>
&gt; &gt;<br>&gt; &gt;    Jeff,<br>&gt; &gt;      Here&#39;s what I know:<br>&gt; &gt;    1.  Checked FAQs.  Done<br>&gt; &gt;    2.  Version 1.6.5<br>&gt; &gt;    3. config.log file has been removed by the sysadmin...<br>
&gt; &gt;    4. ompi_info -a from head node is in attached as headnode.out<br>&gt; &gt;    5. N/A<br>&gt; &gt;    6. compute node info in attached as compute-x-yy.out<br>&gt; &gt;    7. As discussed, local variables are being overwritten after calls to<br>
&gt; &gt;    MPI_RECV from Fortran code<br>&gt; &gt;    8. ifconfig output from head node and computes listed as *-ifconfig.out<br>&gt; &gt;    Cheers,<br>&gt; &gt;    --Jim<br>&gt; &gt;<br>&gt; &gt;    On Wed, Oct 30, 2013 at 5:29 PM, Jeff Squyres (jsquyres)<br>
&gt; &gt;    &lt;[1]<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a>&gt; wrote:<br>&gt; &gt;<br>&gt; &gt;      Can you send the information listed here:<br>&gt; &gt;          [2]<a href="http://www.open-mpi.org/community/help/" target="_blank">http://www.open-mpi.org/community/help/</a><br>
&gt; &gt;<br>&gt; &gt;    On Oct 30, 2013, at 6:22 PM, Jim Parker &lt;[3]<a href="mailto:jimparker96313@gmail.com">jimparker96313@gmail.com</a>&gt;<br>&gt; &gt;    wrote:<br>&gt; &gt;    &gt; Jeff and Ralph,<br>&gt; &gt;    &gt;   Ok, I downshifted to a helloWorld example (attached), bottom line<br>
&gt; &gt;    after I hit the MPI_Recv call, my local variable (rank) gets borked.<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; I have compiled with -m64 -fdefault-integer-8 and even have assigned<br>&gt; &gt;    kind=8 to the integers (which would be the preferred method in my case)<br>
&gt; &gt;    &gt;<br>&gt; &gt;    &gt; Your help is appreciated.<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; Cheers,<br>&gt; &gt;    &gt; --Jim<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; On Wed, Oct 30, 2013 at 4:49 PM, Jeff Squyres (jsquyres)<br>
&gt; &gt;    &lt;[4]<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a>&gt; wrote:<br>&gt; &gt;    &gt; On Oct 30, 2013, at 4:35 PM, Jim Parker &lt;[5]<a href="mailto:jimparker96313@gmail.com">jimparker96313@gmail.com</a>&gt;<br>
&gt; &gt;    wrote:<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; &gt;   I have recently built a cluster that uses the 64-bit indexing<br>&gt; &gt;    feature of OpenMPI following the directions at<br>&gt; &gt;    &gt; &gt;<br>
&gt; &gt;    [6]<a href="http://wiki.chem.vu.nl/dirac/index.php/How_to_build_MPI_libraries_fo" target="_blank">http://wiki.chem.vu.nl/dirac/index.php/How_to_build_MPI_libraries_fo</a><br>&gt; &gt;    r_64-bit_integers<br>
&gt; &gt;    &gt;<br>&gt; &gt;    &gt; That should be correct (i.e., passing -i8 in FFLAGS and FCFLAGS for<br>&gt; &gt;    OMPI 1.6.x).<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; &gt; My question is what are the new prototypes for the MPI calls ?<br>
&gt; &gt;    &gt; &gt; specifically<br>&gt; &gt;    &gt; &gt; MPI_RECV<br>&gt; &gt;    &gt; &gt; MPI_Allgathterv<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; They&#39;re the same as they&#39;ve always been.<br>&gt; &gt;    &gt;<br>
&gt; &gt;    &gt; The magic is that the -i8 flag tells the compiler &quot;make all Fortran<br>&gt; &gt;    INTEGERs be 8 bytes, not (the default) 4.&quot;  So Ralph&#39;s answer was<br>&gt; &gt;    correct in that all the MPI parameters are INTEGERs -- but you can tell<br>
&gt; &gt;    the compiler that all INTEGERs are 8 bytes, not 4, and therefore get<br>&gt; &gt;    &quot;large&quot; integers.<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; Note that this means that you need to compile your application with<br>
&gt; &gt;    -i8, too.  That will make *your* INTEGERs also be 8 bytes, and then<br>&gt; &gt;    you&#39;ll match what Open MPI is doing.<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; &gt; I&#39;m curious because some off my local variables get killed (set to<br>
&gt; &gt;    null) upon my first call to MPI_RECV.  Typically, this is due (in<br>&gt; &gt;    Fortran) to someone not setting the &#39;status&#39; variable to an appropriate<br>&gt; &gt;    array size.<br>&gt; &gt;    &gt;<br>
&gt; &gt;    &gt; If you didn&#39;t compile your application with -i8, this could well be<br>&gt; &gt;    because your application is treating INTEGERs as 4 bytes, but OMPI is<br>&gt; &gt;    treating INTEGERs as 8 bytes.  Nothing good can come from that.<br>
&gt; &gt;    &gt;<br>&gt; &gt;    &gt; If you *did* compile your application with -i8 and you&#39;re seeing this<br>&gt; &gt;    kind of wonkyness, we should dig deeper and see what&#39;s going on.<br>&gt; &gt;    &gt;<br>
&gt; &gt;    &gt; &gt; My review of mpif.h and mpi.h seem to indicate that the functions<br>&gt; &gt;    are defined as C int types and therefore , I assume, the coercion<br>&gt; &gt;    during the compile makes the library support 64-bit indexing.  ie. int<br>
&gt; &gt;    -&gt; long int<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; FWIW: We actually define a type MPI_Fint; its actual type is<br>&gt; &gt;    determined by configure (int or long int, IIRC).  When your Fortran<br>&gt; &gt;    code calls C, we use the MPI_Fint type for parameters, and so it will<br>
&gt; &gt;    be either a 4 or 8 byte integer type.<br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; --<br>&gt; &gt;    &gt; Jeff Squyres<br>&gt; &gt;    &gt; [7]<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>&gt; &gt;    &gt; For corporate legal information go to:<br>
&gt; &gt;    [8]<a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br>&gt; &gt;    &gt;<br>&gt; &gt;    &gt; _______________________________________________<br>
&gt; &gt;    &gt; users mailing list<br>&gt; &gt;    &gt; [9]<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt;    &gt; [10]<a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt; &gt;    &gt;<br>&gt; &gt;<br>&gt; &gt;      &gt;<br>&gt; &gt;      &lt;mpi-test-64bit.tar.bz2&gt;____________________________________________<br>&gt; &gt;      ___<br>&gt; &gt;<br>&gt; &gt;    &gt; users mailing list<br>
&gt; &gt;    &gt; [11]<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt;    &gt; [12]<a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt; &gt;    --<br>&gt; &gt;    Jeff Squyres<br>&gt; &gt;    [13]<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>&gt; &gt;    For corporate legal information go to:<br>&gt; &gt;    [14]<a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br>
&gt; &gt;    _______________________________________________<br>&gt; &gt;    users mailing list<br>&gt; &gt;    [15]<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt;    [16]<a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt; &gt;<br>&gt; &gt; References<br>&gt; &gt;<br>&gt; &gt;    1. mailto:<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>&gt; &gt;    2. <a href="http://www.open-mpi.org/community/help/" target="_blank">http://www.open-mpi.org/community/help/</a><br>
&gt; &gt;    3. mailto:<a href="mailto:jimparker96313@gmail.com">jimparker96313@gmail.com</a><br>&gt; &gt;    4. mailto:<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>&gt; &gt;    5. mailto:<a href="mailto:jimparker96313@gmail.com">jimparker96313@gmail.com</a><br>
&gt; &gt;    6. <a href="http://wiki.chem.vu.nl/dirac/index.php/How_to_build_MPI_libraries_for_64-bit_integers" target="_blank">http://wiki.chem.vu.nl/dirac/index.php/How_to_build_MPI_libraries_for_64-bit_integers</a><br>
&gt; &gt;    7. mailto:<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>&gt; &gt;    8. <a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br>
&gt; &gt;    9. mailto:<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt;   10. <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt; &gt;   11. mailto:<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt;   12. <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt; &gt;   13. mailto:<a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>&gt; &gt;   14. <a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br>
&gt; &gt;   15. mailto:<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt;   16. <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt;<br>&gt;<br>&gt; &gt; _______________________________________________<br>&gt; &gt; users mailing list<br>&gt; &gt; <a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; &gt; <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt;<br>&gt; _______________________________________________<br>&gt; users mailing list<br>&gt; <a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
&gt;<br>&gt;<br>&gt;<br></div></div>&gt; &lt;openmpi-1.6.5.config.tar.gz&gt;_______________________________________________<br>
<div class="HOEnZb">
<div class="h5">&gt; users mailing list<br>&gt; <a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>&gt; <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
<br><br></div></div><span class="HOEnZb"><font color="#888888">--<br>Jeff Squyres<br><a href="mailto:jsquyres@cisco.com">jsquyres@cisco.com</a><br>For corporate legal information go to: <a href="http://www.cisco.com/web/about/doing_business/legal/cri/" target="_blank">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br>
<br>_______________________________________________<br>users mailing list<br><a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br><a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
</font></span></blockquote></div><br>

