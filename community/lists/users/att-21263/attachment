<span class="description">We have recently encountered a problem with using openmpi 1.5.3, 1.5.4, and 1.6.2 over compute nodes with two different generations of Infiniband (DDR and QDR).<br></span><span class="description"><span class="description"><span class="description">This error is very similar to one posted to the list in 2011:<br>
</span><a href="http://www.open-mpi.org/community/lists/users/2011/06/16773.php">http://www.open-mpi.org/community/lists/users/2011/06/16773.php</a><br></span>This issue was never resolved on the mailing list.<br><br>Here is the error:<br>
#################################################################<br></span><span class="description"><span class="description">iwtf-k43-28</span>$ which mpirun<br>/usr/local/packages/openmpi/1.5.4/gcc-4.4.5/bin/mpirun<br>
</span><span class="description"><span class="description"><br>iwtf-k43-28</span>$cat machinefile<br>iwtf-k43-28<br>iwm-k43-30<br></span><span class="description"><span class="description"><br>iwtf-k43-28</span>$ mpirun -np 2 -hostfile machinefile ./a.out 0<br>
--------------------------------------------------------------------------<br>Open MPI detected two different OpenFabrics transport types in the same Infiniband network.<br>Such mixed network trasport configuration is not supported by Open MPI.<br>
<br>  Local host:            <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a><br>  Local adapter:         mthca0 (vendor 0x2c9, part ID 25204)<br>  Local transport type:  MCA_BTL_OPENIB_TRANSPORT_UNKNOWN<br>
  <br>  Remote host:           iwtf-k43-28<br>  Remote Adapter:        (vendor 0x2c9, part ID 26428)<br>  Remote transport type: MCA_BTL_OPENIB_TRANSPORT_IB<br>------------------------------------------------------------------------------------------<br>
Hello from <a href="http://iwtf-k43-28.pace.gatech.edu">iwtf-k43-28.pace.gatech.edu</a>: 0 of 2<br>Hello from <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a>: 1 of 2<br>[<a href="http://iwtf-k43-28.pace.gatech.edu:12695">iwtf-k43-28.pace.gatech.edu:12695</a>] 1 more process has sent help message help-mpi-btl-openib.txt / conflicting transport types<br>
[<a href="http://iwtf-k43-28.pace.gatech.edu:12695">iwtf-k43-28.pace.gatech.edu:12695</a>] Set MCA parameter &quot;orte_base_help_aggregate&quot; to 0 to see all help / error messages<br>----------------------------------------------------------</span><br>
<span class="description"><span class="description"><br></span></span><br><span class="description"><span class="description"><span class="description"><span class="description">iwtf-k43-28</span>$ mpirun -np 2 -hostfile machinefile --mca btl openib,self ./a.out 0<br>
--------------------------------------------------------------------------<br>Open MPI detected two different OpenFabrics transport types in the same Infiniband network.<br>Such mixed network trasport configuration is not supported by Open MPI.<br>
<br>  Local host:            <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a><br>  Local adapter:         mthca0 (vendor 0x2c9, part ID 25204)<br>  Local transport type:  MCA_BTL_OPENIB_TRANSPORT_UNKNOWN<br>
  <br>  Remote host:           iwtf-k43-28<br>  Remote Adapter:        (vendor 0x2c9, part ID 26428)<br>  Remote transport type: MCA_BTL_OPENIB_TRANSPORT_IB<br>--------------------------------------------------------------------------<br>
--------------------------------------------------------------------------<br>At least one pair of MPI processes are unable to reach each other for<br>MPI communications.  This means that no Open MPI device has indicated<br>
that it can be used to communicate between these processes.  This is<br>an error; Open MPI requires that all MPI processes be able to reach<br>each other.  This error can sometimes be the result of forgetting to<br>specify the &quot;self&quot; BTL.<br>
<br>  Process 1 ([[34066,1],1]) is on host: <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a><br>  Process 2 ([[34066,1],0]) is on host: iwtf-k43-28<br>  BTLs attempted: self openib<br><br>Your MPI job is now going to abort; sorry.<br>
--------------------------------------------------------------------------<br>--------------------------------------------------------------------------<br>MPI_INIT has failed because at least one MPI process is unreachable<br>
from another.  This *usually* means that an underlying communication<br>plugin -- such as a BTL or an MTL -- has either not loaded or not<br>allowed itself to be used.  Your MPI job will now abort.<br><br>You may wish to try to narrow down the problem;<br>
<br> * Check the output of ompi_info to see which BTL/MTL plugins are<br>   available.<br> * Run your application with MPI_THREAD_SINGLE.<br> * Set the MCA parameter btl_base_verbose to 100 (or mtl_base_verbose,<br>   if using MTL-based communications) to see exactly which<br>
   communication plugins were considered and/or discarded.<br>--------------------------------------------------------------------------<br>[<a href="http://iwm-k43-30.pace.gatech.edu:9131">iwm-k43-30.pace.gatech.edu:9131</a>] *** An error occurred in MPI_Init<br>
[<a href="http://iwm-k43-30.pace.gatech.edu:9131">iwm-k43-30.pace.gatech.edu:9131</a>] *** on a NULL communicator<br>[<a href="http://iwm-k43-30.pace.gatech.edu:9131">iwm-k43-30.pace.gatech.edu:9131</a>] *** Unknown error<br>
[<a href="http://iwm-k43-30.pace.gatech.edu:9131">iwm-k43-30.pace.gatech.edu:9131</a>] *** MPI_ERRORS_ARE_FATAL: your MPI job will now abort<br>--------------------------------------------------------------------------<br>
An MPI process is aborting at a time when it cannot guarantee that all<br>of its peer processes in the job will be killed properly.  You should<br>double check that everything has shut down cleanly.<br><br>  Reason:     Before MPI_INIT completed<br>
  Local host: <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a><br>  PID:        9131<br>--------------------------------------------------------------------------<br>--------------------------------------------------------------------------<br>
mpirun has exited due to process rank 1 with PID 9131 on<br>node iwm-k43-30 exiting improperly. There are two reasons this could occur:<br><br>1. this process did not call &quot;init&quot; before exiting, but others in<br>
the job did. This can cause a job to hang indefinitely while it waits<br>for all processes to call &quot;init&quot;. By rule, if one process calls &quot;init&quot;,<br>then ALL processes must call &quot;init&quot; prior to termination.<br>
<br>2. this process called &quot;init&quot;, but exited without calling &quot;finalize&quot;.<br>By rule, all processes that call &quot;init&quot; MUST call &quot;finalize&quot; prior to<br>exiting or it will be considered an &quot;abnormal termination&quot;<br>
<br>This may have caused other processes in the application to be<br>terminated by signals sent by mpirun (as reported here).<br>--------------------------------------------------------------------------<br>[<a href="http://iwtf-k43-28.pace.gatech.edu:13279">iwtf-k43-28.pace.gatech.edu:13279</a>] 1 more process has sent help message help-mpi-btl-openib.txt / conflicting transport types<br>
[<a href="http://iwtf-k43-28.pace.gatech.edu:13279">iwtf-k43-28.pace.gatech.edu:13279</a>] Set MCA parameter &quot;orte_base_help_aggregate&quot; to 0 to see all help / error messages<br>[<a href="http://iwtf-k43-28.pace.gatech.edu:13279">iwtf-k43-28.pace.gatech.edu:13279</a>] 1 more process has sent help message help-mca-bml-r2.txt / unreachable proc<br>
[<a href="http://iwtf-k43-28.pace.gatech.edu:13279">iwtf-k43-28.pace.gatech.edu:13279</a>] 1 more process has sent help message help-mpi-runtime / mpi_init:startup:pml-add-procs-fail<br>[<a href="http://iwtf-k43-28.pace.gatech.edu:13279">iwtf-k43-28.pace.gatech.edu:13279</a>] 1 more process has sent help message help-mpi-errors.txt / mpi_errors_are_fatal unknown handle<br>
[<a href="http://iwtf-k43-28.pace.gatech.edu:13279">iwtf-k43-28.pace.gatech.edu:13279</a>] 1 more process has sent help message help-mpi-runtime.txt / ompi mpi abort:cannot guarantee all killed<br><br><br></span>#################################################################<br>
<br></span></span>openmpi 1.4.3 works as expected:<br>iwtf-k43-28$ <span class="description">which mpirun<br>/usr/local/packages/openmpi/1.4.3/gcc-4.4.5/bin/mpirun<br><br>iwtf-k43-28$ mpicc testmpi.c<br></span><span class="description"><br>
iwtf-k43-28$ mpirun -np 2 -hostfile machinefile ./a.out 0</span><br>Hello from <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a>: 1 of 2<br>Hello from <a href="http://iwtf-k43-28.pace.gatech.edu">iwtf-k43-28.pace.gatech.edu</a>: 0 of 2<br>
<br>iwtf-k43-28$ mpirun -np 2 -hostfile machinefile --mca btl openib,self ./a.out 0<br>Hello from <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a>: 1 of 2<br>Hello from <a href="http://iwtf-k43-28.pace.gatech.edu">iwtf-k43-28.pace.gatech.edu</a>: 0 of 2<br>
######################################################################<br><br>######################################################################<br>1.5.4 runs fine on iwm-k43-30 by itself:<br>iwtf-k43-28$ cat machinefile <br>
iwm-k43-30<br>iwm-k43-30<br>iwtf-k43-28$ which mpirun<br>/usr/local/packages/openmpi/1.5.4/gcc-4.4.5/bin/mpirun<br>iwtf-k43-28$ mpicc testmpi.c<br>iwtf-k43-28$ mpirun -np 2 -hostfile machinefile --mca btl openib,self ./a.out 0<br>
Hello from <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a>: 0 of 2<br>Hello from <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a>: 1 of 2<br><br>It is only when mixing and matching hosts that it fails.<br>
<br>######################################################################<br><br><br>Relevant system information:<br> - Same error on RHEL6.2 and RHEL6.3.<br><br>iwtf-k43-28$ uname -a<br>Linux <a href="http://iwtf-k43-28.pace.gatech.edu">iwtf-k43-28.pace.gatech.edu</a> 2.6.32-220.23.1.el6.x86_64 #1 SMP Tue Jun 12 11:20:15 EDT 2012 x86_64 x86_64 x86_64 GNU/Linux<br>
iwm-k43-30$ uname -a<br>Linux <a href="http://iwm-k43-30.pace.gatech.edu">iwm-k43-30.pace.gatech.edu</a> 2.6.32-220.23.1.el6.x86_64 #1 SMP Tue Jun 12 11:20:15 EDT 2012 x86_64 x86_64 x86_64 GNU/Linux<br><br><br><br># rpm -qa | grep -i verb<br>
libibverbs-debuginfo-1.1.4-1.24.gb89d4d7.x86_64<br>libibverbs-1.1.4-1.24.gb89d4d7.x86_64<br>libibverbs-devel-static-1.1.4-1.24.gb89d4d7.x86_64<br>libibverbs-devel-1.1.4-1.24.gb89d4d7.x86_64<br>libipathverbs-1.2-1.x86_64<br>
libipathverbs-debuginfo-1.2-1.x86_64<br>libibverbs-utils-1.1.4-1.24.gb89d4d7.x86_64<br>libipathverbs-devel-1.2-1.x86_64<br><br># rpm -qa | grep libmthca<br>libmthca-1.0.5-0.1.gbe5eef3.x86_64<br>libmthca-debuginfo-1.0.5-0.1.gbe5eef3.x86_64<br>
libmthca-devel-static-1.0.5-0.1.gbe5eef3.x86_64<br><br># rpm -qa | grep libmlx<br>libmlx4-devel-1.0.1-1.20.g6771d22.x86_64<br>libmlx4-debuginfo-1.0.1-1.20.g6771d22.x86_64<br>libmlx4-1.0.1-1.20.g6771d22.x86_64<br><br><br>1.4.3 &quot;configure&quot; flags: &quot;--with-tm=/opt/torque/2.4.3 --with-io-romio-flags=\&quot;--with-file-system=nfs+ufs+panfs\&quot; --enable-static&quot;<br>
1.5.4 &quot;configure&quot; flags: &quot;--with-tm=/opt/torque/2.4.3 --with-io-romio-flags=\&quot;--with-file-system=nfs+ufs+panfs\&quot; --with-hwloc=/usr/local/packages/hwloc/1.2/ --enable-static&quot;<br>1.6.2 &quot;configure&quot; flags: &quot;--with-tm=/opt/torque/2.4.3 --with-io-romio-flags=\&quot;--with-file-system=nfs+ufs+panfs\&quot; --enable-static --with-knem&quot;<br>
<br><br>iwm-k43-30# ibv_devinfo  -v<br>hca_id:    mthca0<br>    transport:            InfiniBand (0)<br>    fw_ver:                1.2.0<br>    node_guid:            0002:c902:0029:8434<br>    sys_image_guid:            0002:c902:0029:8437<br>
    vendor_id:            0x02c9<br>    vendor_part_id:            25204<br>    hw_ver:                0xA0<br>    board_id:            MT_03B0150002<br>    phys_port_cnt:            1<br>    max_mr_size:            0xffffffffffffffff<br>
    page_size_cap:            0xfffff000<br>    max_qp:                64512<br>    max_qp_wr:            16384<br>    device_cap_flags:        0x00001c76<br>    max_sge:            27<br>    max_sge_rd:            0<br>    max_cq:                65408<br>
    max_cqe:            131071<br>    max_mr:                131056<br>    max_pd:                32764<br>    max_qp_rd_atom:            4<br>    max_ee_rd_atom:            0<br>    max_res_rd_atom:        258048<br>    max_qp_init_rd_atom:        128<br>
    max_ee_init_rd_atom:        0<br>    atomic_cap:            ATOMIC_HCA (1)<br>    max_ee:                0<br>    max_rdd:            0<br>    max_mw:                0<br>    max_raw_ipv6_qp:        0<br>    max_raw_ethy_qp:        0<br>
    max_mcast_grp:            8192<br>    max_mcast_qp_attach:        56<br>    max_total_mcast_qp_attach:    458752<br>    max_ah:                0<br>    max_fmr:            0<br>    max_srq:            960<br>    max_srq_wr:            16384<br>
    max_srq_sge:            27<br>    max_pkeys:            64<br>    local_ca_ack_delay:        15<br>        port:    1<br>            state:            PORT_ACTIVE (4)<br>            max_mtu:        2048 (4)<br>            active_mtu:        2048 (4)<br>
            sm_lid:            465<br>            port_lid:        54<br>            port_lmc:        0x00<br>            link_layer:        IB<br>            max_msg_sz:        0x80000000<br>            port_cap_flags:        0x02510a68<br>
            max_vl_num:        4 (3)<br>            bad_pkey_cntr:        0x0<br>            qkey_viol_cntr:        0x0<br>            sm_sl:            0<br>            pkey_tbl_len:        64<br>            gid_tbl_len:        32<br>
            subnet_timeout:        17<br>            init_type_reply:    0<br>            active_width:        4X (2)<br>            active_speed:        5.0 Gbps (2)<br>            phys_state:        LINK_UP (5)<br>            GID[  0]:        fe80:0000:0000:0000:0002:c902:0029:8435<br>
##################################################################<br><br>##################################################################<br>iwtf-k43-28# ibv_devinfo -v<br>hca_id:    mlx4_0<br>    transport:            InfiniBand (0)<br>
    fw_ver:                2.9.1000<br>    node_guid:            0002:c903:004b:2170<br>    sys_image_guid:            0002:c903:004b:2173<br>    vendor_id:            0x02c9<br>    vendor_part_id:            26428<br>    hw_ver:                0xB0<br>
    board_id:            MT_0D90110009<br>    phys_port_cnt:            1<br>    max_mr_size:            0xffffffffffffffff<br>    page_size_cap:            0xfffffe00<br>    max_qp:                261056<br>    max_qp_wr:            16351<br>
    device_cap_flags:        0x007c9c76<br>    max_sge:            32<br>    max_sge_rd:            0<br>    max_cq:                65408<br>    max_cqe:            4194303<br>    max_mr:                524272<br>    max_pd:                32764<br>
    max_qp_rd_atom:            16<br>    max_ee_rd_atom:            0<br>    max_res_rd_atom:        4176896<br>    max_qp_init_rd_atom:        128<br>    max_ee_init_rd_atom:        0<br>    atomic_cap:            ATOMIC_HCA (1)<br>
    max_ee:                0<br>    max_rdd:            0<br>    max_mw:                0<br>    max_raw_ipv6_qp:        0<br>    max_raw_ethy_qp:        1<br>    max_mcast_grp:            8192<br>    max_mcast_qp_attach:        120<br>
    max_total_mcast_qp_attach:    983040<br>    max_ah:                0<br>    max_fmr:            0<br>    max_srq:            65472<br>    max_srq_wr:            16383<br>    max_srq_sge:            31<br>    max_pkeys:            128<br>
    local_ca_ack_delay:        15<br>        port:    1<br>            state:            PORT_ACTIVE (4)<br>            max_mtu:        2048 (4)<br>            active_mtu:        2048 (4)<br>            sm_lid:            465<br>
            port_lid:        35<br>            port_lmc:        0x00<br>            link_layer:        IB<br>            max_msg_sz:        0x40000000<br>            port_cap_flags:        0x02510868<br>            max_vl_num:        8 (4)<br>
            bad_pkey_cntr:        0x0<br>            qkey_viol_cntr:        0x0<br>            sm_sl:            0<br>            pkey_tbl_len:        128<br>            gid_tbl_len:        128<br>            subnet_timeout:        17<br>
            init_type_reply:    0<br>            active_width:        4X (2)<br>            active_speed:        10.0 Gbps (4)<br>            phys_state:        LINK_UP (5)<br>            GID[  0]:        fe80:0000:0000:0000:0002:c903:004b:2171<br>
##################################################################<br><br><br><br><br>-- <br>Wesley Emeneker, Research Scientist<br>The Partnership for an Advanced Computing Environment<br>Georgia Institute of Technology<br>
<br><a href="tel:404.385.2303" value="+14043852303" target="_blank">404.385.2303</a><br><a href="mailto:Wesley.Emeneker@oit.gatech.edu" target="_blank">Wesley.Emeneker@oit.gatech.edu</a><br>
<a href="http://pace.gatech.edu" target="_blank">http://pace.gatech.edu</a><br>

