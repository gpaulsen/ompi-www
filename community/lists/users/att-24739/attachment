<html><head><meta http-equiv="Content-Type" content="text/html charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">OMPI started binding by default during the 1.7 series. You should add the following to your cmd line:<div><br></div><div>--map-by :pe=$OMP_NUM_THREADS</div><div><br></div><div>This will give you a dedicated core for each thread. Alternatively, you could instead add</div><div><br></div><div>--bind-to socket</div><div><br></div><div>OMPI 1.5.5 doesn't bind at all unless directed to do so, which is why you are getting the difference in behavior.</div><div><br></div><div><br></div><div><div><div>On Jul 2, 2014, at 12:33 AM, Timur Ismagilov &lt;<a href="mailto:tismagilov@mail.ru">tismagilov@mail.ru</a>&gt; wrote:</div><br class="Apple-interchange-newline"><blockquote type="cite">
<div><p>Hello!</p><p>I have open mpi&nbsp;1.9a1r32104 and open mpi 1.5.5.<br>I have much better perfomance in open mpi 1.5.5 with openMP on 8 cores<br><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">in &nbsp;the program:<br></span></p><p style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">....<br><br><span style="font-family: arial, helvetica; font-size: 12px; line-height: normal;">#define N 10000000</span></p><div><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"></span></span><br class="webkit-block-placeholder"></div><p>int main(int argc, char *argv[]) {<br>...............<br>MPI_Init(&amp;argc, &amp;argv);<br>...............<br>for (i = 0; i &lt; N; i++) {<br>a[i] = i * 1.0;<br>b[i] = i * 2.0;<br>}<br><br>#pragma omp parallel for shared(a, b, c) private(i)<br>for (i = 0; i &lt; N; i++) {<br>c[i] = a[i] + b[i];<br>}<br>.............<br>MPI_Finalize();<br>}</p><p><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">I got on 1 node <br>(for i in 1 2 4 8 ; do export OMP_NUM_THREADS=$i; sbatch -p test -t 5 --exclusive -N 1 -o hybrid-hello_omp$i.out -e hybrid-hello_omp$i.err ompi_mxm3.0 ./hybrid-hello; done)</span><br></p><div style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><br class="webkit-block-placeholder"></div><ul><li data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><span data-mce-type="bookmark" id="mce_0_start" data-mce-style="overflow:hidden;line-height:0px" style="overflow:hidden;line-height:0px">ï»¿</span>open mpi 1.5.5 (Data for node: node1-128-17 Num slots: 8 Max slots: 0):&nbsp;<ul><li data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">8 threads&nbsp;0.014527 sec</li><li data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">4 threads 0.016138 sec</li><li data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">2 threads&nbsp;0.018764 sec</li><li data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">1 thread &nbsp; 0.029963 sec<br></span></li></ul></li></ul><ul><li><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;"><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">openmpi 1.9a1r32104 (<span style="font-family: arial, helvetica; font-size: 12px; line-height: normal;">node1-128-29: slots=8 max_slots=0 slots_inuse=0 state=UP</span></span></span></span></span><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">):</span><ul><li><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">8 threads&nbsp;0.035055 sec</span></li><li><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">4 threads&nbsp;0.029859 sec&nbsp;</span></li><li><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">2 threads&nbsp;0.019564 sec&nbsp;<span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">(same as&nbsp;</span><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">open mpi 1.5.5</span><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">)</span></span></li><li><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">1 thread &nbsp;&nbsp;0.028394 sec (same as <span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">open mpi 1.5.5</span>)<br></span></li></ul></li></ul><p><span style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;" data-mce-style="font-family: Arial, Tahoma, Verdana, sans-serif; font-size: 13px; line-height: 18.200000762939453px;">So, it looks like, that open mpi 1.9 use only 2 cores from 8.</span><br><br>What can i do with this?<br><br>$cat ompi_mxm3.0<br></p><p>#!/bin/sh</p><p>[ x"$TMPDIR" == x"" ] &amp;&amp; TMPDIR=/tmp</p><p>HOSTFILE=${TMPDIR}/hostfile.${SLURM_JOB_ID}<br>srun hostname -s|sort|uniq -c|awk '{print $2" slots="$1}' &gt; $HOSTFILE || { rm -f $HOSTFILE; exit 255; }<br>LD_PRELOAD=/mnt/data/users/dm2/vol3/semenov/_scratch/mxm/mxm-3.0/lib/libmxm.so mpirun -x LD_PRELOAD -x MXM_SHM_KCOPY_MODE=off --display-allocation --hostfile $HOSTFILE "$@"<br>rc=$?<br>rm -f $HOSTFILE</p><p>exit $rc<br><br>For open mpi 1.5.5 i remove LD_PRELOAD from run script.</p></div>
_______________________________________________<br>users mailing list<br><a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>Subscription: http://www.open-mpi.org/mailman/listinfo.cgi/users<br>Link to this post: http://www.open-mpi.org/community/lists/users/2014/07/24738.php</blockquote></div><br></div></body></html>
