<html><head></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space; ">You might want to send this to the MPICH mailing lists - this is for Open MPI issues.<div><br><div><div>On Oct 27, 2011, at 4:59 PM, Jonathan Bishop wrote:</div><br class="Apple-interchange-newline"><blockquote type="cite">I am using MPI_Comm_spawn to dynamically run workers. However, when the workers exit they get hung up on MPI_Finalize. Here is a short program which shows the issue...<br><br>It responds to several commands...<br><br>Do<br>
<br>start<br>stop<br><br>and then check how many processes are running - it should be 1, not 2.<div><br></div><div>I am using MPICH2 1.4.1-p1.</div><div><br></div><div>Thanks,</div><div><br></div><div>Jon</div><div><font class="Apple-style-span" face="'courier new', monospace"><br>
</font></div><div><div><font class="Apple-style-span" face="'courier new', monospace">#include &lt;sys/types.h&gt;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">#include &lt;unistd.h&gt;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">#include &lt;iostream&gt;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">#include "mpi.h"</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace">using namespace std;</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br>
</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace">main(int argc, char **argv)</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">{</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; MPI_Init(&amp;argc, &amp;argv);</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; MPI_Comm parent;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; MPI_Comm_get_parent(&amp;parent);</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div>
<font class="Apple-style-span" face="'courier new', monospace">&nbsp; // Master</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; if (parent == MPI_COMM_NULL) {</font></div><div>
<font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; cout &lt;&lt; getpid() &lt;&lt; endl;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; MPI_Comm intercom = MPI_COMM_NULL;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; while (1) {</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; cout &lt;&lt; "Enter: ";</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; string s;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; cin &gt;&gt; s;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; if (s == "start") {</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>if (intercom != MPI_COMM_NULL) {</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;cout &lt;&lt; "already started" &lt;&lt; endl;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;continue;</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>}</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>MPI_Comm_spawn(argv[0], MPI_ARGV_NULL, 1, MPI_INFO_NULL, 0, MPI_COMM_SELF, &amp;intercom, &nbsp;MPI_ERRCODES_IGNORE);</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>continue;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; }</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; if (s == "stop") {</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>if (intercom == MPI_COMM_NULL) {</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;cout &lt;&lt; "worker not running" &lt;&lt; endl;</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;continue;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>}</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>MPI_Send(const_cast&lt;char*&gt;(s.c_str()), s.size(), MPI_CHAR, 0, 0, intercom);</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>intercom = MPI_COMM_NULL;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">//<span class="Apple-tab-span" style="white-space:pre">	</span>MPI_Finalize(); &nbsp;// This will allow the workers to die, but then I can not restart them.</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>continue;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; }</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; if (s == "exit") {</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>if (intercom != MPI_COMM_NULL) {</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;cout &lt;&lt; "need to stop before exit" &lt;&lt; endl;</font></div><div>
<font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span> &nbsp;continue;</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>}</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>break;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; }</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; if (intercom == MPI_COMM_NULL) {</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>cout &lt;&lt; "need to start" &lt;&lt; endl;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>continue;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; }</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Send(const_cast&lt;char*&gt;(s.c_str()), s.size(), MPI_CHAR, 0, 0, intercom);</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; char buf[1000];</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Status status;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Recv(buf, 1000, MPI_CHAR, MPI_ANY_SOURCE, MPI_ANY_TAG, intercom, &amp;status);</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; int count;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Get_count(&amp;status, MPI_CHAR, &amp;count);</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; buf[count] = 0;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; string t = buf;</font></div><div>
<font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; cout &lt;&lt; "worker returned " &lt;&lt; t &lt;&lt; endl;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; }</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; }</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br></font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; // Worker</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; if (parent != MPI_COMM_NULL) {</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; while (1) {</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; char buf[1000];</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Status status;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Recv(buf, 1000, MPI_CHAR, MPI_ANY_SOURCE, MPI_ANY_TAG, parent, &amp;status);</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; int count;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Get_count(&amp;status, MPI_CHAR, &amp;count);</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; buf[count] = 0;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; string s = buf;</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; if (s == "stop") {</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>cout &lt;&lt; "worker stopping" &lt;&lt; endl;</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><span class="Apple-tab-span" style="white-space:pre">	</span>break;</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; }</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; &nbsp; MPI_Send(const_cast&lt;char*&gt;(s.c_str()), s.size(), MPI_CHAR, 0, 0, parent);</font></div>
<div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; &nbsp; }</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; }</font></div><div><font class="Apple-style-span" face="'courier new', monospace"><br>
</font></div><div><font class="Apple-style-span" face="'courier new', monospace">&nbsp; MPI_Finalize();</font></div><div><font class="Apple-style-span" face="'courier new', monospace">}</font></div><div><br></div>
<br><br><br><br><br></div>
_______________________________________________<br>users mailing list<br><a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>http://www.open-mpi.org/mailman/listinfo.cgi/users</blockquote></div><br></div></body></html>
