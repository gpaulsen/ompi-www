<div dir="ltr">Hello Open MPI Gurus,<div><br></div><div>As I explore MPI-OpenMP hybrid codes, I&#39;m trying to figure out how to do things to get the same behavior in various stacks. For example, I have a 28-core node (2 14-core Haswells), and I&#39;d like to run 4 MPI processes and 7 OpenMP threads. Thus, I&#39;d like the processes to be 2 processes per socket with the OpenMP threads laid out on them. Using a &quot;hybrid Hello World&quot; program, I can achieve this with Intel MPI (after a lot of testing):</div><div><br></div><div><div><font face="monospace, monospace">(1097) $ env OMP_NUM_THREADS=7 KMP_AFFINITY=compact mpirun -np 4 ./hello-hybrid.x | sort -g -k 18</font></div><div><font face="monospace, monospace">srun.slurm: cluster configuration lacks support for cpu binding</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 2 out of 4 on borgo035 on CPU 0</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 2 out of 4 on borgo035 on CPU 1</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 2 out of 4 on borgo035 on CPU 2</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 2 out of 4 on borgo035 on CPU 3</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 2 out of 4 on borgo035 on CPU 4</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 2 out of 4 on borgo035 on CPU 5</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 2 out of 4 on borgo035 on CPU 6</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 3 out of 4 on borgo035 on CPU 7</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 3 out of 4 on borgo035 on CPU 8</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 3 out of 4 on borgo035 on CPU 9</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 3 out of 4 on borgo035 on CPU 10</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 3 out of 4 on borgo035 on CPU 11</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 3 out of 4 on borgo035 on CPU 12</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 3 out of 4 on borgo035 on CPU 13</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 0 out of 4 on borgo035 on CPU 14</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 0 out of 4 on borgo035 on CPU 15</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 0 out of 4 on borgo035 on CPU 16</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 0 out of 4 on borgo035 on CPU 17</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 0 out of 4 on borgo035 on CPU 18</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 0 out of 4 on borgo035 on CPU 19</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 0 out of 4 on borgo035 on CPU 20</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 1 out of 4 on borgo035 on CPU 21</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 1 out of 4 on borgo035 on CPU 22</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 1 out of 4 on borgo035 on CPU 23</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 1 out of 4 on borgo035 on CPU 24</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 1 out of 4 on borgo035 on CPU 25</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 1 out of 4 on borgo035 on CPU 26</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 1 out of 4 on borgo035 on CPU 27</font></div><div><br></div><div>Other than the odd fact that Process #0 seemed to start on Socket #1 (this might be an artifact of how I&#39;m trying to detect the CPU I&#39;m on), this looks reasonable. 14 threads on each socket and each process is laying out its threads in a nice orderly fashion.</div><div><br></div><div>I&#39;m trying to figure out how to do this with Open MPI (version 1.10.0) and apparently I am just not quite good enough to figure it out. The closest I&#39;ve gotten is:</div><div><font face="monospace, monospace"><br></font></div><div><div><font face="monospace, monospace">(1155) $ env OMP_NUM_THREADS=7 KMP_AFFINITY=compact mpirun -np 4 -map-by ppr:2:socket ./hello-hybrid.x | sort -g -k 18</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 0 out of 4 on borgo035 on CPU 0</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 1 out of 4 on borgo035 on CPU 0</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 0 out of 4 on borgo035 on CPU 1</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 1 out of 4 on borgo035 on CPU 1</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 0 out of 4 on borgo035 on CPU 2</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 1 out of 4 on borgo035 on CPU 2</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 0 out of 4 on borgo035 on CPU 3</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 1 out of 4 on borgo035 on CPU 3</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 0 out of 4 on borgo035 on CPU 4</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 1 out of 4 on borgo035 on CPU 4</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 0 out of 4 on borgo035 on CPU 5</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 1 out of 4 on borgo035 on CPU 5</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 0 out of 4 on borgo035 on CPU 6</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 1 out of 4 on borgo035 on CPU 6</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 2 out of 4 on borgo035 on CPU 14</font></div><div><font face="monospace, monospace">Hello from thread 0 out of 7 from process 3 out of 4 on borgo035 on CPU 14</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 2 out of 4 on borgo035 on CPU 15</font></div><div><font face="monospace, monospace">Hello from thread 1 out of 7 from process 3 out of 4 on borgo035 on CPU 15</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 2 out of 4 on borgo035 on CPU 16</font></div><div><font face="monospace, monospace">Hello from thread 2 out of 7 from process 3 out of 4 on borgo035 on CPU 16</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 2 out of 4 on borgo035 on CPU 17</font></div><div><font face="monospace, monospace">Hello from thread 3 out of 7 from process 3 out of 4 on borgo035 on CPU 17</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 2 out of 4 on borgo035 on CPU 18</font></div><div><font face="monospace, monospace">Hello from thread 4 out of 7 from process 3 out of 4 on borgo035 on CPU 18</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 2 out of 4 on borgo035 on CPU 19</font></div><div><font face="monospace, monospace">Hello from thread 5 out of 7 from process 3 out of 4 on borgo035 on CPU 19</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 2 out of 4 on borgo035 on CPU 20</font></div><div><font face="monospace, monospace">Hello from thread 6 out of 7 from process 3 out of 4 on borgo035 on CPU 20</font></div></div><div><br></div><div>Obviously not right. Any ideas on how to help me learn? The man mpirun page is a bit formidable in the pinning part, so maybe I&#39;ve missed an obvious answer.</div><div><br></div><div>Matt</div>-- <br><div class="gmail_signature"><div dir="ltr"><div><div dir="ltr"><div>Matt Thompson</div></div></div><blockquote style="margin:0px 0px 0px 40px;border:none;padding:0px"><div><div><div>Man Among Men</div></div></div><div><div><div>Fulcrum of History</div></div></div></blockquote></div></div>
</div></div>

