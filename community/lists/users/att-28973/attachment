<html><head><meta http-equiv="Content-Type" content="text/html charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;" class="">Hmmm…I’m not entirely sure what might be specifically causing the differences you cite. We didn’t make any changes to the LSF components, so that wouldn’t be it. The main things I can recall involved how we handle hostfile and -host specifications, and when we directly sense the available cpus on each node.<div class=""><br class=""></div><div class="">My guess is that something in the LSF RAS component may be interacting with those changes, but I’d have to look closer at what goes on in there to really tell. I’d recommend someone “scrub” the RAS component as it has gone many years without an update, and was never all that carefully constructed.</div><div class=""><br class=""></div><div class=""><br class=""><div><blockquote type="cite" class=""><div class="">On Apr 19, 2016, at 1:19 PM, Josh Hursey &lt;<a href="mailto:jjhursey@open-mpi.org" class="">jjhursey@open-mpi.org</a>&gt; wrote:</div><br class="Apple-interchange-newline"><div class=""><div dir="ltr" style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" class=""><div class="">Just an update for the list. Really only impacts folks running Open MPI under LSF.</div><div class=""><br class=""></div><div class=""><br class=""></div><div class="">The LSB_PJL_TASK_GEOMETRY changes what lbs_getalloc() returns regarding the allocation. It adjusts it to the mapping/ordering specified in that environment variable. However, since it is not set by LSF when the job starts the LSB_AFFINITY_HOSTFILE will show a broader mapping/ordering. The difference between these two requests is the core of the problem here.</div><div class=""><br class=""></div><div class="">Consider an LSB hostfile with the following:</div><div class="">=== LSB_AFFINITY_HOSTFILE ===</div><div class="">p10a33 0,1,2,3,4,5,6,7</div><div class="">p10a33 8,9,10,11,12,13,14,15</div><div class="">p10a33 16,17,18,19,20,21,22,23</div><div class="">p10a30 0,1,2,3,4,5,6,7</div><div class="">p10a30 8,9,10,11,12,13,14,15</div><div class="">p10a30 16,17,18,19,20,21,22,23</div><div class="">p10a58 0,1,2,3,4,5,6,7</div><div class="">p10a58 8,9,10,11,12,13,14,15</div><div class="">p10a58 16,17,18,19,20,21,22,23</div><div class="">=============================</div><div class=""><br class=""></div><div class="">This tells Open MPI to launch 3 processes per node with a particular set of bindings - so 9 processes total.<br class=""></div><div class=""><br class=""></div><div class="">export LSB_PJL_TASK_GEOMETRY="{(5)(4,3)(2,1,0)}"<br class=""></div><div class=""><br class=""></div><div class="">The LSB_PJL_TASK_GEOMETRY variable (above) tells us to only launch 6 processes. So lbs_getalloc() will return to us (ras_lsf_module.c) a list of resources that match launching 6 processes. However, when we go to the rmaps_seq.c we tell it to pay attention to the LSB_AFFINITY_HOSTFILE. So it tries to map 9 processes even though we set the slots on the nodes to be a total of 6. So eventually we get an oversubscription issue.</div><div class=""><br class=""></div><div class="">Interesting difference between 1.10.2 and 1.10.3rc1 - using the LSB_AFFINITY_HOSTFILE, seen above.</div><div class="">In 1.10.2 RAS thinks it has the following allocation (with and without the LSB_PJL_TASK_GEOMETRY set):</div><div class="">====================== &nbsp; ALLOCATED NODES &nbsp; ======================</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a33: slots=1 max_slots=0 slots_inuse=0 state=UP</div><div class="">=================================================================</div><div class="">In 1.10.3.rc1 RAS thinks it has the following allocation (with the LSB_PJL_TASK_GEOMETRY set)</div><div class="">====================== &nbsp; ALLOCATED NODES &nbsp; ======================</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a33: slots=1 max_slots=0 slots_inuse=0 state=UP</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a30: slots=2 max_slots=0 slots_inuse=0 state=UP</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a58: slots=3 max_slots=0 slots_inuse=0 state=UP</div><div class="">=================================================================</div><div class="">In 1.10.3.rc1 RAS thinks it has the following allocation (without the LSB_PJL_TASK_GEOMETRY set)</div><div class="">====================== &nbsp; ALLOCATED NODES &nbsp; ======================</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a33: slots=3 max_slots=0 slots_inuse=0 state=UP</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a30: slots=3 max_slots=0 slots_inuse=0 state=UP</div><div class="">&nbsp; &nbsp; &nbsp; &nbsp; p10a58: slots=3 max_slots=0 slots_inuse=0 state=UP</div><div class="">=================================================================</div><div class=""><br class=""></div><div class="">The 1.10.3rc1 behavior is what I would expect to happen. The 1.10.2 behavior seems to be a bug when running under LSF.</div><div class=""><br class=""></div><div class="">The original error comes from trying to map 3 process on each of the nodes (since the affinity file wants to launch 9 processes), but the nodes having a more restricted set of slots (Due to the LSB_PJL_TASK_GEOMETRY variable).</div><div class=""><br class=""></div><div class=""><br class=""></div><div class="">I know a number of things have changed from 1.10.2 to 1.10.3 regarding how we allocate/map. Ralph, do you know offhand what might have caused this difference? It's not a big deal if not, just curious.</div><div class=""><br class=""></div><div class=""><br class=""></div><div class="">I'm working with Farid on some options to work around the issue for 1.10.2. Open MPI 1.10.3 seems to be ok for basic LSF functionality (without the LSB_PJL_TASK_GEOMETRY variable).</div><div class=""><br class=""></div><div class="">-- Josh</div><div class=""><br class=""></div><div class="gmail_extra"><br class=""><div class="gmail_quote">On Tue, Apr 19, 2016 at 8:57 AM, Josh Hursey<span class="Apple-converted-space">&nbsp;</span><span dir="ltr" class="">&lt;<a href="mailto:jjhursey@open-mpi.org" target="_blank" class="">jjhursey@open-mpi.org</a>&gt;</span><span class="Apple-converted-space">&nbsp;</span>wrote:<br class=""><blockquote class="gmail_quote" style="margin: 0px 0px 0px 0.8ex; border-left-width: 1px; border-left-color: rgb(204, 204, 204); border-left-style: solid; padding-left: 1ex;"><div dir="ltr" class="">Farid,<div class=""><br class=""></div><div class="">I have access to the same cluster inside IBM. I can try to help you track this down and maybe work up a patch with the LSF folks. I'll contact you off-list with my IBM address and we can work on this a bit.</div><div class=""><br class=""></div><div class="">I'll post back to the list with what we found.</div><span class=""><font color="#888888" class=""><div class=""><br class=""></div><div class="">-- Josh</div><div class=""><br class=""></div></font></span></div><div class=""><div class="h5"><div class="gmail_extra"><br class=""><div class="gmail_quote">On Tue, Apr 19, 2016 at 5:06 AM, Jeff Squyres (jsquyres)<span class="Apple-converted-space">&nbsp;</span><span dir="ltr" class="">&lt;<a href="mailto:jsquyres@cisco.com" target="_blank" class="">jsquyres@cisco.com</a>&gt;</span><span class="Apple-converted-space">&nbsp;</span>wrote:<br class=""><blockquote class="gmail_quote" style="margin: 0px 0px 0px 0.8ex; border-left-width: 1px; border-left-color: rgb(204, 204, 204); border-left-style: solid; padding-left: 1ex;"><span class="">On Apr 18, 2016, at 7:08 PM, Farid Parpia &lt;<a href="mailto:parpia@us.ibm.com" target="_blank" class="">parpia@us.ibm.com</a>&gt; wrote:<br class="">&gt;<br class="">&gt; I will try to put you in touch with someone in LSF development immediately.<br class=""><br class=""></span>FWIW: It would be great if IBM could contribute the fixes to this.&nbsp; None of us have access to LSF resources, and IBM is a core contributor to Open MPI.<br class=""><br class="">--<br class="">Jeff Squyres<br class=""><a href="mailto:jsquyres@cisco.com" target="_blank" class="">jsquyres@cisco.com</a><br class="">For corporate legal information go to:<span class="Apple-converted-space">&nbsp;</span><a href="http://www.cisco.com/web/about/doing_business/legal/cri/" rel="noreferrer" target="_blank" class="">http://www.cisco.com/web/about/doing_business/legal/cri/</a><br class=""><span class=""><br class="">_______________________________________________<br class="">users mailing list<br class=""><a href="mailto:users@open-mpi.org" target="_blank" class="">users@open-mpi.org</a><br class="">Subscription:<span class="Apple-converted-space">&nbsp;</span><a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" rel="noreferrer" target="_blank" class="">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br class=""></span>Link to this post:<span class="Apple-converted-space">&nbsp;</span><a href="http://www.open-mpi.org/community/lists/users/2016/04/28963.php" rel="noreferrer" target="_blank" class="">http://www.open-mpi.org/community/lists/users/2016/04/28963.php</a><br class=""></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></div><span style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none; display: inline !important;" class="">_______________________________________________</span><br style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" class=""><span style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none; display: inline !important;" class="">users mailing list</span><br style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" class=""><span style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none; display: inline !important;" class=""><a href="mailto:users@open-mpi.org" class="">users@open-mpi.org</a></span><br style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" class=""><span style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none; display: inline !important;" class="">Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" class="">http://www.open-mpi.org/mailman/listinfo.cgi/users</a></span><br style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" class=""><span style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px; float: none; display: inline !important;" class="">Link to this post:<span class="Apple-converted-space">&nbsp;</span></span><a href="http://www.open-mpi.org/community/lists/users/2016/04/28972.php" style="font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-stroke-width: 0px;" class="">http://www.open-mpi.org/community/lists/users/2016/04/28972.php</a></div></blockquote></div><br class=""></div></body></html>
