<div dir="ltr"><div class="gmail_extra"><div class="gmail_quote">On Thu, Mar 5, 2015 at 6:22 PM, Bogdan Sataric <span dir="ltr">&lt;<a href="mailto:bogdan.sataric@gmail.com" target="_blank">bogdan.sataric@gmail.com</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr">Hello George,<div><br></div><div>So is it safe for me to assume that my code is good and that you will remove this bug from next OpenMPI version?</div></div></blockquote><div><br></div><div>Yes I think it is safe to assume your code is correct (or at least it follows the specifications you describe in your email).</div><div><br></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr"><div>Also I would like to know which future OpenMPI version will incorporate this fix (so I can try my code in fixed version)? <br></div></div></blockquote><div><br></div><div>I pushed the code in the trunk, and created a request to get it into the 1.8.5. So you can try any nightly build starting from tonight, and then any stable release after the 1.8.4</div><div><br></div><div>  George.</div><div> </div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr"></div></blockquote><div> </div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div dir="ltr"><div></div><div><br></div><div>Thank you, </div></div><div class="gmail_extra"><span class=""><br clear="all"><div><div><div dir="ltr"><div><div dir="ltr"><div><div dir="ltr"><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394" size="1">----</font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394" size="1"><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394"><font>Bogdan Sataric</font><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394" size="1"><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">email: <a href="mailto:bogdan.sataric@gmail.com" target="_blank">bogdan.sataric@gmail.com</a></font></span></div><div><font color="#0b5394"><span style="background-color:rgb(243,243,243)">phone: +381 21-485-</span><span style="font-family:Arial,Helvetica,sans-serif;font-size:13.3333330154419px;white-space:nowrap">2441</span></font></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394"><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">Teaching &amp; Research Assistant</font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">Chair for Applied Computer Science</font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">Faculty of Technical Sciences, Novi Sad, Serbia<br></font></span></div></div></div></div></div></div></div></div>
<br></span><div class="gmail_quote"><div><div class="h5">On Thu, Mar 5, 2015 at 6:31 PM, George Bosilca <span dir="ltr">&lt;<a href="mailto:bosilca@icl.utk.edu" target="_blank">bosilca@icl.utk.edu</a>&gt;</span> wrote:<br></div></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div><div class="h5"><div dir="ltr">Bogdan,<div><br></div><div>As far as I can tell your code is correct, and the problem is coming from Open MPI. More specifically, I used alloca in the optimization stage in MPI_Type_commit, and as your arrays of length were too large, alloca failed and lead to a segfault. I fixed in the trunk (3c489ea), and this will get into our next release.</div><div><br></div><div>Unfortunately there is no fix for the 1.6 that I can think of. Apparently, you are really the first that run into such kind of problems, so guess you are the first creating gigantic datatypes.</div><div><br></div><div>Thanks for the bug report,</div><div>  George.</div><div><br></div></div><div class="gmail_extra"><br><div class="gmail_quote"><div><div>On Thu, Mar 5, 2015 at 9:09 AM, Bogdan Sataric <span dir="ltr">&lt;<a href="mailto:bogdan.sataric@gmail.com" target="_blank">bogdan.sataric@gmail.com</a>&gt;</span> wrote:<br></div></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex"><div><div><div dir="ltr"><div>I&#39;ve been having problems with my 3D matrix transpose program. I&#39;m using MPI_Type_indexed in order to allign specific blocks that I want to send and receive across one or multiple nodes of a cluster. Up to few days ago I was able to run my program without any errors. However several test cases on the cluster in last few days exposed segmentation fault when I try to form indexed type on some specific matrix configurations.<br></div><div><br></div><div>The code that forms indexed type is as follows:</div><div><br></div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;stdlib.h&gt;</div><div>#include &lt;mpi.h&gt;</div><div><br></div><div>int main(int argc, char **argv) {</div><div><br></div><div>    int Nx = 800;</div><div>    int Ny = 640;</div><div>    int Nz = 480;</div><div>    int gsize;</div><div>    int i, j;</div><div><br></div><div>    MPI_Init(&amp;argc, &amp;argv);                             </div><div>    MPI_Comm_size(MPI_COMM_WORLD, &amp;gsize);  </div><div><br></div><div>    printf(&quot;GSIZE: %d\n&quot;, gsize);</div><div><br></div><div>    MPI_Datatype double_complex_type;</div><div>    MPI_Datatype block_send_complex_type; </div><div><br></div><div>    int * send_displ = (int *) malloc(Nx * Ny/gsize * sizeof(int));</div><div>    int * send_blocklen = (int *) malloc(Nx * Ny/gsize * sizeof(int));</div><div><br></div><div>    MPI_Type_contiguous(2, MPI_DOUBLE, &amp;double_complex_type); </div><div>    MPI_Type_commit(&amp;double_complex_type);</div><div><br></div><div>    for (i = Ny/gsize - 1; i &gt;= 0 ; i--) {     </div><div>        for (j = 0; j &lt; Nx; j++) { </div><div>            send_displ[(Ny/gsize - 1 - i) * Nx + j] = i * Nz + j * Ny * Nz;  </div><div>            send_blocklen[(Ny/gsize - 1 - i) * Nx + j] = Nz;     </div><div>        }</div><div>    }</div><div><br></div><div>    MPI_Type_indexed(Nx * Ny/gsize, send_blocklen, send_displ, double_complex_type, &amp;block_send_complex_type); </div><div>    MPI_Type_commit(&amp;block_send_complex_type);</div><div><br></div><div>    free(send_displ);</div><div>    free(send_blocklen);</div><div><br></div><div>    MPI_Finalize();</div><div>}</div><div><br></div><div>Values of the Nx, Ny and Nz respectively are 800, 640 and 480. Value of gsize for this test was 1 (simulation of MPI program on 1 node). The node has 32GB of RAM and no other memory has been allocated (only this code has been run).</div><div><br></div><div>In code basically I&#39;m creating double_complex_type to represent complex number (2 contiguous MPI_DOUBLE) values. The whole matrix has 800 * 640 * 480 of these values and I&#39;m trying to catch these values in the indexed type. One indexed type block length is the whole Nz &quot;rod&quot; while ordering of these &quot;rods&quot; in displacements array is given by the formula i * Nz + j * Ny * Nz. Basically displacements start from top row, and left column of the 3D matrix. Then I gradually sweep to the right sight of that top row, then go to one row below sweep to the right side and so on until the bottom row.</div><div><br></div><div>The strange thing is that this formula and algorithm <b>WORK</b> if I put MPI_DOUBLE type instead of derived complex type (1 instead of 2 in MPI_TYPE_CONTIGIOUS). Also this formula <b>WORKS</b> if I put 1 for Nz dimension instead of 480. However if I change Nz to even 2 I get segmentation fault error in the MPI_Type_commit call.</div><div><br></div><div>I checked all of the displacements and they seem fine. There is no overlapping of displacements or going under 0 or over extent of the formed indexed type. Also the size of the datatype is below 4GB (which is I believe limit of MPI datatypes (since MPI_Type_size function returns int * ). Also I believe amount of memory is not an issue as even if I put Nz to be 2, I get the same segmentation fault error, and the node has 32GB of RAM just for this test.</div><div><br></div><div>What bothers me is that most of other indexed type configurations (with plain MPI_DOUBLE type elements), or complex type with smaller matrix (say 400 * 640 * 480) <b>WORK</b> without segmentation fault. Also If I commit the indexed type with MPI_DOUBLE type elements even larger matrices work (say 960 x 800 x 640) which have exactly the same type size as 800 x 640 x 480 complex indexed type (just under 4GB)! So basically the type size is not an issue here, but somehow either number of blocks, size of particular blocks, or size of block elements create problems. I&#39;m not sure weather there is problem in implementation of OpenMPI or something in my code is wrong...</div><div><br></div><div>I would greatly appreciate any help as I&#39;ve been stuck on this problem for days now and nothing in MPI documentation and the examples I found on the internet is giving me a clue where the error might be.</div><div><br></div><div>At the end I would like to say that code has been compiled with Open-MPI version 1.6.5.</div><div><br></div><div>Thank you,</div><div><br></div><div>Bogdan Sataric</div><div><div><div dir="ltr"><div><div dir="ltr"><div><div dir="ltr"><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394" size="1">----</font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394" size="1"><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394"><font>Bogdan Sataric</font><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394" size="1"><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">email: <a href="mailto:bogdan.sataric@gmail.com" target="_blank">bogdan.sataric@gmail.com</a></font></span></div><div><font color="#0b5394"><span style="background-color:rgb(243,243,243)">phone: +381 21-485-</span><span style="font-family:Arial,Helvetica,sans-serif;font-size:13.3333330154419px;white-space:nowrap">2441</span></font></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394"><br></font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">Teaching &amp; Research Assistant</font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">Chair for Applied Computer Science</font></span></div><div><span style="background-color:rgb(243,243,243)"><font color="#0b5394">Faculty of Technical Sciences, Novi Sad, Serbia<br></font></span></div></div></div></div></div></div></div></div>
</div>
<br></div></div>_______________________________________________<br>
users mailing list<br>
<a href="mailto:users@open-mpi.org" target="_blank">users@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/users/2015/03/26430.php" target="_blank">http://www.open-mpi.org/community/lists/users/2015/03/26430.php</a><br></blockquote></div><br></div>
<br>_______________________________________________<br>
users mailing list<br>
<a href="mailto:users@open-mpi.org" target="_blank">users@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br></div></div>
Link to this post: <a href="http://www.open-mpi.org/community/lists/users/2015/03/26431.php" target="_blank">http://www.open-mpi.org/community/lists/users/2015/03/26431.php</a><br></blockquote></div><br></div>
<br>_______________________________________________<br>
users mailing list<br>
<a href="mailto:users@open-mpi.org">users@open-mpi.org</a><br>
Subscription: <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br>
Link to this post: <a href="http://www.open-mpi.org/community/lists/users/2015/03/26433.php" target="_blank">http://www.open-mpi.org/community/lists/users/2015/03/26433.php</a><br></blockquote></div><br></div></div>

