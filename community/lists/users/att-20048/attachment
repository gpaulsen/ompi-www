<html><body><div style="color:#000; background-color:#fff; font-family:times new roman, new york, times, serif;font-size:12pt"><div>Paul I tried NetPipeMPI - (belatedly because their site was down down for a couple of days)</div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span><br></span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>The results show a max of 7.4 Gb/s at 8388605 bytes which seems fine.</span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span><br></span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px;
 font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>But my program still runs slowly and stalls occasionally.</span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>I've using 1 buffer per process - I assume this is ok.</span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>Is it of any significance that the&nbsp;</span><span style="font-size: 12pt; ">&nbsp;</span><span style="font-size: 13.888888359069824px; line-height: 12.991898536682129px; ">log_num_mtt and&nbsp;</span><span style="font-size: 13.888888359069824px; line-height: 12.991898536682129px; ">log_mtts_per_seg params where not set?</span></div><div
 style="color: rgb(0, 0, 0); font-size: 13.888888359069824px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span style="font-size: 13.888888359069824px; line-height: 12.991898536682129px; ">Is this a symptom of a broken install?</span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><br></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>Reposting original message for clarity - its been a few days...</span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>2nd posts are below this 1st
 section</span></div><div style="color: rgb(0, 0, 0); font-size: 15.833333015441895px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span>







<div class="p1"><b></b>========================================================================================</div>
<div class="p2">I have a test rig comprising 2 i7 systems 8GB RAM with Melanox III HCA 10G cards</div>
<div class="p2">running Centos 5.7 Kernel 2.6.18-274</div>
<div class="p2">Open MPI 1.4.3</div>
<div class="p2">MLNX_OFED_LINUX-1.5.3-1.0.0.2 (OFED-1.5.3-1.0.0.2):</div>
<div class="p2">On a Cisco 24 pt switch</div>
<div class="p3"><br></div>
<div class="p2">Normal performance is:</div>
<div class="p2">$ mpirun --mca btl openib,self -n 2 -hostfile mpi.hosts &nbsp;PingPong</div>
<div class="p2">results in:</div>
<div class="p2">&nbsp;Max rate = 958.388867 MB/sec &nbsp;Min latency = 4.529953 usec</div>
<div class="p2">and:</div>
<div class="p2">$ mpirun --mca btl tcp,self -n 2 -hostfile mpi.hosts &nbsp;PingPong</div>
<div class="p2">Max rate = 653.547293 MB/sec &nbsp;Min latency = 19.550323 usec</div>
<div class="p3"><br></div>
<div class="p3"><br></div>
<div class="p2">My application exchanges about a gig of data between the processes with 2 sender and 2 consumer processes on each node with 1 additional controler process on the starting node.</div>
<div class="p2">The program splits the data into 64K blocks and uses non blocking sends and receives with busy/sleep loops to monitor progress until completion.</div>
<div class="p3"><br></div>
<div class="p2">My problem is I see better performance under IPoIB then I do on native IB (RDMA_CM).</div>
<div class="p2">My understanding is that IPoIB is limited to about 1G/s so I am at a loss to know why it is faster.</div>
<div class="p3"><br></div>
<div class="p2">These 2 configurations are equivelant (about 8-10 seconds per cycle)</div>
<div class="p2">mpirun --mca btl_openib_flags 2 --mca mpi_leave_pinned 1 --mca btl tcp,self -H vh2,vh1 -np 9 --bycore prog</div>
<div class="p2">mpirun --mca btl_openib_flags 3 --mca mpi_leave_pinned 1 --mca btl tcp,self -H vh2,vh1 -np 9 --bycore prog</div>
<div class="p3"><br></div>
<div class="p2">And this one produces similar run times but seems to degrade with repeated cycles:</div>
<div class="p2">mpirun --mca btl_openib_eager_limit 64 --mca mpi_leave_pinned 1 --mca btl openib,self -H vh2,vh1 -np 9 --bycore &nbsp;prog</div>
<div class="p3"><br></div>
<div class="p2">Other &nbsp;btl_openib_flags settings result in much lower performance.&nbsp;</div>
<div class="p2">Changing the first of the above configs to use openIB results in a 21 second run time at best. &nbsp;Sometimes it takes up to 5 minutes.</div>
<div class="p2">With openib:</div>
<div class="p2">- Repeated cycles during a single run seem to slow down with each cycle.</div>
<div class="p2">- On occasions it seems to stall indefinately, waiting on a single receive.&nbsp;</div>
<div class="p3"><br></div>
<div class="p2">Any ideas appreciated.</div>
<div class="p3"><br></div>
<div class="p2">Thanks in advance,</div>
<div class="p2">Randolph</div></span></div><div><br></div>  <div style="font-family: 'times new roman', 'new york', times, serif; font-size: 12pt; "> <div style="font-family: 'times new roman', 'new york', times, serif; font-size: 12pt; "> <div dir="ltr"> <font size="2" face="Arial"> <hr size="1">  <b><span style="font-weight:bold;">From:</span></b> Randolph Pullen &lt;randolph_pullen@yahoo.com.au&gt;<br> <b><span style="font-weight: bold;">To:</span></b> Paul Kapinos &lt;kapinos@rz.rwth-aachen.de&gt;; Open MPI Users &lt;users@open-mpi.org&gt; <br> <b><span style="font-weight: bold;">Sent:</span></b> Thursday, 30 August 2012 11:46 AM<br> <b><span style="font-weight: bold;">Subject:</span></b> Re: [OMPI users] Infiniband performance Problem and stalling<br> </font> </div> <br><div id="yiv223134359"><div><div style="color: rgb(0, 0, 0); background-color: rgb(255, 255, 255); font-family: 'times new roman', 'new york', times, serif; font-size: 12pt;
 "><div><span>Interesting, the&nbsp;</span><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;">log_num_mtt and&nbsp;</span><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;">log_mtts_per_seg params where not set.</span></div><div style="color: rgb(0, 0, 0); font-size: 13.888888359069824px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;">Setting them to utilise 2*8G of my RAM resulted in no change to the stalls or run time ie; (19,3) (20,2) (21,1) or (</span><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;background-color:transparent;">6,16).&nbsp;</span></div><div style="color: rgb(0, 0, 0); font-size: 13.888888359069824px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal;
 "><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;">In all cases, OpenIB runs in twice the time it takes TCP,except if I push the small message max to 64K and force short messages. &nbsp;Then the openib times are the same as TCP and no faster.</span></div><div style="color: rgb(0, 0, 0); font-size: 13.888888359069824px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;"><br></span></div><div style="color: rgb(0, 0, 0); font-size: 14.166666030883789px; font-family: 'times new roman', 'new york', times, serif; background-color: transparent; font-style: normal; "><span style="font-size:13.888888359069824px;line-height:12.991898536682129px;">I'ms till at a loss as to why...</span></div><div><br></div>  <div style="font-family: 'times new roman', 'new york', times, serif; font-size: 12pt; ">
 <div style="font-family: 'times new roman', 'new york', times, serif; font-size: 12pt; "> <div dir="ltr"> <font size="2" face="Arial"> <hr size="1">  <b><span style="font-weight:bold;">From:</span></b> Paul Kapinos &lt;kapinos@rz.rwth-aachen.de&gt;<br> <b><span style="font-weight:bold;">To:</span></b> Randolph Pullen &lt;randolph_pullen@yahoo.com.au&gt;; Open MPI Users &lt;users@open-mpi.org&gt; <br> <b><span style="font-weight:bold;">Sent:</span></b> Tuesday, 28 August 2012 6:13 PM<br> <b><span style="font-weight:bold;">Subject:</span></b> Re: [OMPI users] Infiniband performance Problem and stalling<br> </font> </div> <br>Randolph,<br>after reading this:<br><br>On 08/28/12 04:26, Randolph Pullen wrote:<br>&gt; - On occasions it seems to stall indefinately, waiting on a single receive.<br><br>... I
 would make a blind guess: are you aware about IB card parameters for registered memory?<br><a rel="nofollow" target="_blank" href="http://www.open-mpi.org/faq/?category=openfabrics#ib-low-reg-mem">http://www.open-mpi.org/faq/?category=openfabrics#ib-low-reg-mem</a><br><br>"Waiting forever" for a single operation is one of symptoms of the problem especially in 1.5.3.<br><br><br>best,<br>Paul<br><br>P.S. the lower performance with 'big' chinks is known phenomenon, cf.<br><a rel="nofollow" target="_blank" href="http://www.scl.ameslab.gov/netpipe/">http://www.scl.ameslab.gov/netpipe/</a><br>(image on bottom of the page). But the chunk size of 64k is fairly small<br><br><br><br><br>-- Dipl.-Inform. Paul Kapinos&nbsp;  -&nbsp;  High Performance Computing,<br>RWTH Aachen University, Center for Computing and Communication<br>Seffenter Weg 23,&nbsp; D 52074&nbsp; Aachen (Germany)<br>Tel: +49 241/80-24915<br><br><br><br> </div> </div> 
 </div></div></div><br>_______________________________________________<br>users mailing list<br><a ymailto="mailto:users@open-mpi.org" href="mailto:users@open-mpi.org">users@open-mpi.org</a><br><a href="http://www.open-mpi.org/mailman/listinfo.cgi/users" target="_blank">http://www.open-mpi.org/mailman/listinfo.cgi/users</a><br><br> </div> </div>  </div></body></html>
