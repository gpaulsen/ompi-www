<div dir="ltr">I think I might have fixed this, but I still don&#39;t really understand it.<div><br></div><div>In setting up the RPi machines, I followed a config guide that suggested switching the SSH service in systemd to &quot;ssh.socket&quot; instead of &quot;ssh.service&quot;. It&#39;s supposed to be lighter weight and get you cleaner shut-downs, and I&#39;ve used this trick on other machines, without really knowing the implications.</div><div><br></div><div>By way of completeness of my config audit to try to figure this out, I backed this out, restoring the &quot;ssh.service&quot; link and removing the &quot;ssh.socket&quot; one. Now MPI works, and I also get clean disconnections at exit-time, so apparently there&#39;s no reason at all to do this.</div><div><br></div><div>This behavior has survived two reboot cycles, so I think it&#39;s real. Not sure if this behavior is relevant to just Raspbian, or if it&#39;s in all architectures of Debian Jessie, or all systemd init systems, or what.</div><div><br></div><div>         -- A.</div></div><br><div class="gmail_quote"><div dir="ltr">On Sat, May 14, 2016 at 3:27 PM Andrew Reid &lt;<a href="mailto:andrew.ce.reid@gmail.com">andrew.ce.reid@gmail.com</a>&gt; wrote:<br></div><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><div>Hi all --</div><div><br></div><div>I am having a weird problem on a cluster of Raspberry Pi model 2 machines running the Debian/Raspbian version of OpenMPI, 1.6.5.</div><div><br></div><div>I apologize for the length of this message, but I am trying to include all the pertinent details, but of course can&#39;t reliably discriminate between pertinent and irrelevant details.</div><div><br></div><div>I am actually a fairly long-time user of OpenMPI in various environments, and have never had any trouble with it, but in configuring my &quot;toy&quot; cluster, this came up.  </div><div><br></div><div>The basic issue is, a sample MPI executable runs with &quot;mpirun -d&quot; or under &quot;slurm&quot; resource allocation, but not directly from the command line -- in the direct command-line case, it just hangs, apparently forever.</div><div><br></div><div>What is even weirder is that, earlier today, while backing out a private domain configuration (see below), it actually started working for a while, but after reboots, the problem behavior has returned.</div><div><br></div><div>It seems overwhelmingly likely that this is some kind of network transport configuration problem, but it eludes me.</div><div><br></div><div> </div><div>More details about the problem:</div><div><br></div><div>  </div><div>The Pis are all quad-core, and are named pi (head node), pj, pk, and pl (work nodes).  They&#39;re connected by ethernet.  They all have a single non-privileged user, named &quot;pi&quot;.</div><div><br></div><div>There&#39;s a directory on my account containing an MPI executable, the &quot;cpi&quot; example from the OpenMPI package, and a list of machines to run on, named &quot;machines&quot;, with the following contents:</div><div><br></div><div>&gt; pj slots=4</div><div>&gt; pk slots=4</div><div>&gt; pl slots=4</div><div><br></div><div><br></div><div>&gt; mpirun --hostfile machines ./cpi</div><div><br></div><div>  ... hangs forever, but</div><div><br></div><div>&gt; mpirun -d --hostfile machines ./cpi </div><div><br></div><div>  ... runs correctly, if somewhat verbosely.</div><div><br></div><div>Also:</div><div><br></div><div>&gt; salloc -n 12 /bin/bash   </div><div>&gt; mpirun ./cpi</div><div><br></div><div>   ... also runs correctly.  The &quot;salloc&quot; command is a slurm directive to allocate CPU resources, and start an interactive shell with a bunch of environment variables set to give mpirun the clues it needs, of course.  The work CPUs are allocated correctly on my &quot;work&quot; nodes when salloc is run from the head node.</div><div><br></div><div>  </div><div><br></div><div>  Config details and diagnostic efforts:</div><div><br></div><div>The outputs of the ompi_info runs are attached.</div><div><br></div><div>The cluster of four Raspberry Pi model 2 computers runs the Jessie distribution of Raspbian, which is essentially Debian.  They differ a bit, the &quot;head node&quot;, creatively named &quot;pi&quot;, has an older static network config, with everything specified in /etc/network/interfaces.  The &quot;cluster nodes&quot;, equally creatively named pj, pk, and pl, all have the newer DHCPCD client daemon configured for static interfaces, via /etc/dhcpcd.conf (NB this is *not* the DHCP *server*, these machines do not use DHCP services.)  The dhcpcd configuration tool is the new scheme for Raspian, and has been modified from the &quot;as-shipped&quot; set-up to have a static IPv4 address on eth0, and to remove some ipv6 functionality (router solicitation) that pollutes the log files.</div><div><br></div><div><br></div><div>MDNS is turned off in /etc/nsswitch.conf, &quot;hosts&quot; are resolved via &quot;files&quot;, then &quot;dns&quot;.  The DNS name servers are statically configured to be 8.8.8.8 and 8.8.4.4.  None of the machines involved in the OpenMPI operation are in DNS.</div><div><br></div><div>For slightly complicated reasons, all four machines were initially configured as members of a local, non-DNS-resolveable domain, named &quot;.gb&quot;  This was done because slurm requires e-mail, and my first crack at e-mail config seemed to require a domain.  All the hostnames were statically configured through /etc/hosts.   I realized later that I misunderstood the mail config, and have backed out the domain configuration, the machines all have non-dotted names.  </div><div><br></div><div>This seemed to briefly change the behavior, it worked several times after this, but then on reboot, stopped working again, making me think I am perhaps losing my mind.</div><div><br></div><div>The system is *not* running nscd, so some kind of name-service cache is not a good explanation here.</div><div><br></div><div><br></div><div>The whole cluster is set up for host-based SSH authentication for the default user, &quot;pi&quot;.  This works for all possible host pairs, tested via:</div><div><br></div><div>&gt; ssh -o PreferredAuthentications=hostbased pi@&lt;target&gt;</div><div><br></div><div>The network config looks OK.  I can ping and ssh every way I want to, and it all works.  The pis are all wired to the same Netgear 10/100 switch, which in turn goes to my household switch, which in turn goes to my cable modem.  &quot;ifconfig&quot; shows eth0 and lo configured. &quot;ifconfig -a&quot; does not show any additional unconfigured interfaces.</div><div>  </div><div>Ifconfig output is, in order for pi, pj, pk, and pl:</div><div><br></div><div><br></div><div><br></div><div>eth0      Link encap:Ethernet  HWaddr b8:27:eb:16:0a:70  </div><div>          inet addr:192.168.0.11  Bcast:192.168.0.255  Mask:255.255.255.0</div><div>          inet6 addr: ::ba27:ebff:fe16:a70/64 Scope:Global</div><div>          inet6 addr: fe80::ba27:ebff:fe16:a70/64 Scope:Link</div><div>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div>          RX packets:164 errors:0 dropped:23 overruns:0 frame:0</div><div>          TX packets:133 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:1000 </div><div>          RX bytes:15733 (15.3 KiB)  TX bytes:13756 (13.4 KiB)</div><div><br></div><div>lo        Link encap:Local Loopback  </div><div>          inet addr:127.0.0.1  Mask:255.0.0.0</div><div>          inet6 addr: ::1/128 Scope:Host</div><div>          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div>          RX packets:7 errors:0 dropped:0 overruns:0 frame:0</div><div>          TX packets:7 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:0 </div><div>          RX bytes:616 (616.0 B)  TX bytes:616 (616.0 B)</div><div><br></div><div><br></div><div><br></div><div><br></div><div>eth0      Link encap:Ethernet  HWaddr b8:27:eb:27:4d:17  </div><div>          inet addr:192.168.0.12  Bcast:192.168.0.255  Mask:255.255.255.0</div><div>          inet6 addr: ::4c5c:1329:f1b6:1169/64 Scope:Global</div><div>          inet6 addr: fe80::6594:bfad:206:1191/64 Scope:Link</div><div>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div>          RX packets:237 errors:0 dropped:31 overruns:0 frame:0</div><div>          TX packets:131 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:1000                                          </div><div>          RX bytes:28966 (28.2 KiB)  TX bytes:18841 (18.3 KiB)                  </div><div>                                                                                </div><div>lo        Link encap:Local Loopback                                             </div><div>          inet addr:127.0.0.1  Mask:255.0.0.0                                   </div><div>          inet6 addr: ::1/128 Scope:Host                                        </div><div>          UP LOOPBACK RUNNING  MTU:65536  Metric:1                              </div><div>          RX packets:136 errors:0 dropped:0 overruns:0 frame:0                  </div><div>          TX packets:136 errors:0 dropped:0 overruns:0 carrier:0                </div><div>          collisions:0 txqueuelen:0                                             </div><div>          RX bytes:11664 (11.3 KiB)  TX bytes:11664 (11.3 KiB)</div><div><br></div><div><br></div><div><br></div><div> </div><div>eth0      Link encap:Ethernet  HWaddr b8:27:eb:f4:ec:03  </div><div>          inet addr:192.168.0.13  Bcast:192.168.0.255  Mask:255.255.255.0</div><div>          inet6 addr: fe80::ba08:3c9:67c3:a2a1/64 Scope:Link</div><div>          inet6 addr: ::8e5a:32a5:ab50:d955/64 Scope:Global</div><div>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div>          RX packets:299 errors:0 dropped:57 overruns:0 frame:0</div><div>          TX packets:138 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:1000 </div><div>          RX bytes:34334 (33.5 KiB)  TX bytes:19909 (19.4 KiB)</div><div><br></div><div>lo        Link encap:Local Loopback  </div><div>          inet addr:127.0.0.1  Mask:255.0.0.0</div><div>          inet6 addr: ::1/128 Scope:Host</div><div>          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div>          RX packets:136 errors:0 dropped:0 overruns:0 frame:0</div><div>          TX packets:136 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:0 </div><div>          RX bytes:11664 (11.3 KiB)  TX bytes:11664 (11.3 KiB)</div><div><br></div><div><br></div><div><br></div><div>eth0      Link encap:Ethernet  HWaddr b8:27:eb:da:c6:7f  </div><div>          inet addr:192.168.0.14  Bcast:192.168.0.255  Mask:255.255.255.0</div><div>          inet6 addr: ::a8db:7245:458f:2342/64 Scope:Global</div><div>          inet6 addr: fe80::3c5f:7092:578a:6c10/64 Scope:Link</div><div>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div>          RX packets:369 errors:0 dropped:76 overruns:0 frame:0</div><div>          TX packets:165 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:1000 </div><div>          RX bytes:38040 (37.1 KiB)  TX bytes:22788 (22.2 KiB)</div><div><br></div><div>lo        Link encap:Local Loopback  </div><div>          inet addr:127.0.0.1  Mask:255.0.0.0</div><div>          inet6 addr: ::1/128 Scope:Host</div><div>          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div>          RX packets:136 errors:0 dropped:0 overruns:0 frame:0</div><div>          TX packets:136 errors:0 dropped:0 overruns:0 carrier:0</div><div>          collisions:0 txqueuelen:0 </div><div>          RX bytes:11664 (11.3 KiB)  TX bytes:11664 (11.3 KiB)</div><div><br></div><div><br></div><div><br></div><div><br></div><div>There are no firewalls on any of the machines.  I checked this via &quot;iptables-save&quot;, which dumps the system firewall state in a way that allows it to be re-loaded by a script, and the output is reasonably human-readable.  It shows all tables with no rules and a default &quot;accept&quot; state.</div><div><br></div><div><br></div><div>The OpenMPI installation is the current Raspbian version, freshly installed (via &quot;apt-get install openmpi-bin libopenmpi-dev&quot;) from the repos.  The OpenMPI is version 1.6.5, the package version is 1.6.5-9.1+rpi1.  No configuration options have been modified.</div><div><br></div><div>There is no &quot;.openmpi&quot; directory on the pi user account on any of the machines.</div><div><br></div><div>When I run the problem case, I can sometimes catch the &quot;orted&quot; daemon spinning up on the pj machine, it looks something like this (the port number on the tcp uri varies from run to run): </div><div><br></div><div>&gt; 1 S pi        4895     1  0  80   0 -  1945 poll_s 20:23 ?        00:00:00 orted --daemonize -mca ess env -mca orte_ess_jobid 1646002176 -mca orte_ess_vpid 1 -mca orte_ess_num_procs 4 --hnp-uri 1646002176.0;tcp://<a href="http://192.168.0.11:59646" target="_blank">192.168.0.11:59646</a> -mca plm rsh</div><div><br></div><div>(192.168.0.11 is indeed the correct address of the launching machine, hostname pi.  The first &quot;pi&quot; in column 3 is the name of the user who owns the process.</div><div><br></div><div>If I run &quot;telnet 192.168.0.11 59646&quot;, it connects.  I can send some garbage into the connection, but this does not cause the orted to exit, nor does it immedately blow up the launching process on the launch machine.  I have not investigated in detail, but it seems that if you molest the TCP connection in this way, the launching process eventually reports an error, but if you don&#39;t, it will hang forever.</div><div><br></div><div>  </div><div>One additional oddity, when I run the job in &quot;debug&quot; mode, the clients generate the following dmesg traffic:</div><div><br></div><div>&gt; [ 1002.404021] sctp: [Deprecated]: cpi (pid 13770) Requested SCTP_SNDRCVINFO event.</div><div>&gt; Use SCTP_RCVINFO through SCTP_RECVRCVINFO option instead.</div><div>&gt; [ 1002.412423] sctp: [Deprecated]: cpi (pid 13772) Requested SCTP_SNDRCVINFO event.</div><div>&gt; Use SCTP_RCVINFO through SCTP_RECVRCVINFO option instead.</div><div>&gt; [ 1002.427621] sctp: [Deprecated]: cpi (pid 13771) Requested SCTP_SNDRCVINFO event.</div><div>&gt; Use SCTP_RCVINFO through SCTP_RECVRCVINFO option instead.</div><div><br></div><div><br></div><div><br></div><div>  I have tried:</div><div><br></div><div> - Adding or removing the domain suffix from the hosts in the machines file.</div><div> - Checked that the clocks on all four machines match.</div><div> - Changing the host names in the machines file to invalid names -- this causes the expected failure, reassuring me that the file is being read.  Note that the hanging behavior also occurs with the &quot;-H&quot; option in place of a machine file.</div><div> - Running with &quot;-mca btl tcp,self -mca btl_tcp_if_include eth0&quot; in case it&#39;s having device problems.  When I do this, I see this argument echoed on the orted process on pj, but the behavior is the same, it still hangs.</div><div> - Removing the &quot;slots=&quot; directive from the machines file.</div><div> - Disabling IPv6 (via sysctl).</div><div> - Turning off the SLURM daemons (via systemctl, not by uninstalling them.)</div><div> - Different host combinations in the machines file.  This changes things in weird ways, which I have not systematically explored.</div><div>   It seems that if pk is the first in line, then the thing eventually times out, but if pj or pl is first, it hangs forever.  The willingness of orted to appear in the client process table seems seems inconsistent, but it may be that it always runs, but I am not consistently catching it.</div><div> - Adding/removing &quot;multi on&quot; from /etc/host.conf.</div><div><br></div><div>None of these have changed the behavior, except, as noted, briefly after backing out the private domain configuration (which involves editing the hosts file, which motivates the focus on DNS in some of this.)</div><div><br></div><div><br></div><div>All configurations work with &quot;-d&quot;, or with &quot;--debug-daemons&quot; or with no arguments inside a slurm allocation, but hang in the &quot;ordinary&quot; case.</div><div><br></div><div>I am stumped.  I am totally willing to believe I have mucked up the network config, but where? How? What&#39;s different about debug mode?</div><div><br></div></div></blockquote></div>

