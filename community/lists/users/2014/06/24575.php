<?
$subject_val = "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1";
include("../../include/msg-header.inc");
?>
<!-- received="Fri Jun  6 13:31:10 2014" -->
<!-- isoreceived="20140606173110" -->
<!-- sent="Fri, 6 Jun 2014 13:31:07 -0400" -->
<!-- isosent="20140606173107" -->
<!-- name="Dan Dietz" -->
<!-- email="ddietz_at_[hidden]" -->
<!-- subject="Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1" -->
<!-- id="CABy+9wFjh8tTNaCVDC8wkEoaot=NkK+J+99rOvRKxG3-bpxEOA_at_mail.gmail.com" -->
<!-- charset="UTF-8" -->
<!-- inreplyto="BEAE5ABA-4ECB-47D9-A236-B4F1CEB8EB52_at_open-mpi.org" -->
<!-- expires="-1" -->
<div class="center">
<table border="2" width="100%" class="links">
<tr>
<th><a href="date.php">Date view</a></th>
<th><a href="index.php">Thread view</a></th>
<th><a href="subject.php">Subject view</a></th>
<th><a href="author.php">Author view</a></th>
</tr>
</table>
</div>
<p class="headers">
<strong>Subject:</strong> Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1<br>
<strong>From:</strong> Dan Dietz (<em>ddietz_at_[hidden]</em>)<br>
<strong>Date:</strong> 2014-06-06 13:31:07
</p>
<ul class="links">
<!-- next="start" -->
<li><strong>Next message:</strong> <a href="24576.php">Mike Dubman: "Re: [OMPI users] spml_ikrit_np random values"</a>
<li><strong>Previous message:</strong> <a href="24574.php">Ralph Castain: "Re: [OMPI users] Determining what parameters a scheduler passes to OpenMPI"</a>
<li><strong>In reply to:</strong> <a href="24558.php">Ralph Castain: "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="24578.php">Ralph Castain: "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1"</a>
<li><strong>Reply:</strong> <a href="24578.php">Ralph Castain: "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1"</a>
<!-- reply="end" -->
</ul>
<hr>
<!-- body="start" -->
<p>
Thanks for the reply. I tried out the --display-allocation option with
<br>
several different combinations and have attached the output. I see
<br>
this behavior on both RHEL6.4, RHEL6.5, and RHEL5.10 clusters.
<br>
<p><p>Here's debugging info on the segfault. Does that help? FWIW this does
<br>
not seem to crash on the RHEL5 cluster or RHEL6.5 cluster. Just
<br>
crashes on RHEL6.4.
<br>
<p>ddietz_at_conte-a009:/scratch/conte/d/ddietz/hello$ gdb -c core.22623
<br>
`which mpirun`
<br>
No symbol table is loaded.  Use the &quot;file&quot; command.
<br>
GNU gdb (GDB) 7.5-1.3.187
<br>
Copyright (C) 2012 Free Software Foundation, Inc.
<br>
License GPLv3+: GNU GPL version 3 or later &lt;<a href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a>&gt;
<br>
This is free software: you are free to change and redistribute it.
<br>
There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;
<br>
and &quot;show warranty&quot; for details.
<br>
This GDB was configured as &quot;x86_64-unknown-linux-gnu&quot;.
<br>
For bug reporting instructions, please see:
<br>
&lt;<a href="http://www.gnu.org/software/gdb/bugs/">http://www.gnu.org/software/gdb/bugs/</a>&gt;...
<br>
Reading symbols from
<br>
/scratch/conte/d/ddietz/openmpi-1.8.1-debug/intel-14.0.2.144/bin/mpirun...done.
<br>
[New LWP 22623]
<br>
[New LWP 22624]
<br>
<p>warning: Can't read pathname for load map: Input/output error.
<br>
[Thread debugging using libthread_db enabled]
<br>
Using host libthread_db library &quot;/lib64/libthread_db.so.1&quot;.
<br>
Core was generated by `mpirun -np 2 -machinefile ./nodes ./hello'.
<br>
Program terminated with signal 11, Segmentation fault.
<br>
#0  0x00002acc602920e1 in orte_plm_base_complete_setup (fd=-1,
<br>
args=-1, cbdata=0x20c0840) at base/plm_base_launch_support.c:422
<br>
422                    node-&gt;hostid = node-&gt;daemon-&gt;name.vpid;
<br>
(gdb) bt
<br>
#0  0x00002acc602920e1 in orte_plm_base_complete_setup (fd=-1,
<br>
args=-1, cbdata=0x20c0840) at base/plm_base_launch_support.c:422
<br>
#1  0x00002acc60eec145 in opal_libevent2021_event_base_loop () from
<br>
/scratch/conte/d/ddietz/openmpi-1.8.1-debug/intel-14.0.2.144/lib/libopen-pal.so.6
<br>
#2  0x00000000004073b5 in orterun (argc=6, argv=0x7fff5bb2a3a8) at
<br>
orterun.c:1077
<br>
#3  0x00000000004048f4 in main (argc=6, argv=0x7fff5bb2a3a8) at main.c:13
<br>
<p>ddietz_at_conte-a009:/scratch/conte/d/ddietz/hello$ cat nodes
<br>
conte-a009
<br>
conte-a009
<br>
conte-a055
<br>
conte-a055
<br>
ddietz_at_conte-a009:/scratch/conte/d/ddietz/hello$ uname -r
<br>
2.6.32-358.14.1.el6.x86_64
<br>
<p>On Thu, Jun 5, 2014 at 7:54 PM, Ralph Castain &lt;rhc_at_[hidden]&gt; wrote:
<br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; On Jun 5, 2014, at 2:13 PM, Dan Dietz &lt;ddietz_at_[hidden]&gt; wrote:
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Hello all,
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; I'd like to bind 8 cores to a single MPI rank for hybrid MPI/OpenMP
</span><br>
<span class="quotelev2">&gt;&gt; codes. In OMPI 1.6.3, I can do:
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; $ mpirun -np 2 -cpus-per-rank 8  -machinefile ./nodes ./hello
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; I get one rank bound to procs 0-7 and the other bound to 8-15. Great!
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; But I'm having some difficulties doing this with openmpi 1.8.1:
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; $ mpirun -np 2 -cpus-per-rank 8  -machinefile ./nodes ./hello
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt; The following command line options and corresponding MCA parameter have
</span><br>
<span class="quotelev2">&gt;&gt; been deprecated and replaced as follows:
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;  Command line options:
</span><br>
<span class="quotelev2">&gt;&gt;    Deprecated:  --cpus-per-proc, -cpus-per-proc, --cpus-per-rank,
</span><br>
<span class="quotelev2">&gt;&gt; -cpus-per-rank
</span><br>
<span class="quotelev2">&gt;&gt;    Replacement: --map-by &lt;obj&gt;:PE=N
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;  Equivalent MCA parameter:
</span><br>
<span class="quotelev2">&gt;&gt;    Deprecated:  rmaps_base_cpus_per_proc
</span><br>
<span class="quotelev2">&gt;&gt;    Replacement: rmaps_base_mapping_policy=&lt;obj&gt;:PE=N
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; The deprecated forms *will* disappear in a future version of Open MPI.
</span><br>
<span class="quotelev2">&gt;&gt; Please update to the new syntax.
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt; There are not enough slots available in the system to satisfy the 2 slots
</span><br>
<span class="quotelev2">&gt;&gt; that were requested by the application:
</span><br>
<span class="quotelev2">&gt;&gt;  ./hello
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Either request fewer slots for your application, or make more slots available
</span><br>
<span class="quotelev2">&gt;&gt; for use.
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; OK, let me try the new syntax...
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; $ mpirun -np 2 --map-by core:pe=8 -machinefile ./nodes ./hello
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt; There are not enough slots available in the system to satisfy the 2 slots
</span><br>
<span class="quotelev2">&gt;&gt; that were requested by the application:
</span><br>
<span class="quotelev2">&gt;&gt;  ./hello
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Either request fewer slots for your application, or make more slots available
</span><br>
<span class="quotelev2">&gt;&gt; for use.
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; What am I doing wrong? The documentation on these new options is
</span><br>
<span class="quotelev2">&gt;&gt; somewhat poor and confusing so I'm probably doing something wrong. If
</span><br>
<span class="quotelev2">&gt;&gt; anyone could provide some pointers here it'd be much appreciated! If
</span><br>
<span class="quotelev2">&gt;&gt; it's not something simple and you need config logs and such please let
</span><br>
<span class="quotelev2">&gt;&gt; me know.
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; Looks like we think there are less than 16 slots allocated on that node. What is in this &quot;nodes&quot; file? Without it, OMPI should read the Torque allocation directly. You might check what we think the allocation is by adding --display-allocation to the cmd line
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; As a side note -
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; If I try this using the PBS nodefile with the above, I get a confusing message:
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt; A request for multiple cpus-per-proc was given, but a directive
</span><br>
<span class="quotelev2">&gt;&gt; was also give to map to an object level that has less cpus than
</span><br>
<span class="quotelev2">&gt;&gt; requested ones:
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;  #cpus-per-proc:  8
</span><br>
<span class="quotelev2">&gt;&gt;  number of cpus:  1
</span><br>
<span class="quotelev2">&gt;&gt;  map-by:          BYCORE:NOOVERSUBSCRIBE
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Please specify a mapping level that has more cpus, or else let us
</span><br>
<span class="quotelev2">&gt;&gt; define a default mapping that will allow multiple cpus-per-proc.
</span><br>
<span class="quotelev2">&gt;&gt; --------------------------------------------------------------------------
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; From what I've gathered this is because I have a node listed 16 times
</span><br>
<span class="quotelev2">&gt;&gt; in my PBS nodefile so it's assuming then I have 1 core per node?
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; No - if listed 16 times, it should compute 16 slots. Try adding --display-allocation to your cmd line and it should tell you how many slots are present.
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; However, it doesn't assume there is a core for each slot. Instead, it detects the cores directly on the node. It sounds like it isn't seeing them for some reason. What OS are you running on that node?
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; FWIW: the 1.6 series has a different detection system for cores. Could be something is causing problems for the new one.
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Some
</span><br>
<span class="quotelev2">&gt;&gt; better documentation here would be helpful. I haven't been able to
</span><br>
<span class="quotelev2">&gt;&gt; figure out how to use the &quot;oversubscribe&quot; option listed in the docs.
</span><br>
<span class="quotelev2">&gt;&gt; Not that I really want to oversubscribe, of course, I need to modify
</span><br>
<span class="quotelev2">&gt;&gt; the nodefile, but this just stumped me for a while as 1.6.3 didn't
</span><br>
<span class="quotelev2">&gt;&gt; have this behavior.
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; As a extra bonus, I get a segfault in this situation:
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; $ mpirun -np 2 -machinefile ./nodes ./hello
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] *** Process received signal ***
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] Signal: Segmentation fault (11)
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] Signal code: Address not mapped (1)
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] Failing at address: 0x2c
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 0] /lib64/libpthread.so.0[0x3c9460f500]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 1]
</span><br>
<span class="quotelev2">&gt;&gt; /apps/rhel6/openmpi/1.8.1/intel-14.0.2.144/lib/libopen-rte.so.7(orte_plm_base_complete_setup+0x615)[0x2ba960a59015]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 2]
</span><br>
<span class="quotelev2">&gt;&gt; /apps/rhel6/openmpi/1.8.1/intel-14.0.2.144/lib/libopen-pal.so.6(opal_libevent2021_event_base_loop+0xa05)[0x2ba961666715]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 3] mpirun(orterun+0x1b45)[0x40684f]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 4] mpirun(main+0x20)[0x4047f4]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 5] /lib64/libc.so.6(__libc_start_main+0xfd)[0x3a1bc1ecdd]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] [ 6] mpirun[0x404719]
</span><br>
<span class="quotelev2">&gt;&gt; [conte-a497:13255] *** End of error message ***
</span><br>
<span class="quotelev2">&gt;&gt; Segmentation fault (core dumped)
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; Huh - that's odd. Could you perhaps configure OMPI with --enable-debug and gdb the core file to tell us the line numbers involved?
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; Thanks
</span><br>
<span class="quotelev1">&gt; Ralph
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; My &quot;nodes&quot; file simply contains the first two lines of my original
</span><br>
<span class="quotelev2">&gt;&gt; $PBS_NODEFILE provided by Torque. See above why I modified. Works fine
</span><br>
<span class="quotelev2">&gt;&gt; if use the full file.
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Thanks in advance for any pointers you all may have!
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; Dan
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt;
</span><br>
<span class="quotelev2">&gt;&gt; --
</span><br>
<span class="quotelev2">&gt;&gt; Dan Dietz
</span><br>
<span class="quotelev2">&gt;&gt; Scientific Applications Analyst
</span><br>
<span class="quotelev2">&gt;&gt; ITaP Research Computing, Purdue University
</span><br>
<span class="quotelev2">&gt;&gt; _______________________________________________
</span><br>
<span class="quotelev2">&gt;&gt; users mailing list
</span><br>
<span class="quotelev2">&gt;&gt; users_at_[hidden]
</span><br>
<span class="quotelev2">&gt;&gt; <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users">http://www.open-mpi.org/mailman/listinfo.cgi/users</a>
</span><br>
<span class="quotelev1">&gt;
</span><br>
<span class="quotelev1">&gt; _______________________________________________
</span><br>
<span class="quotelev1">&gt; users mailing list
</span><br>
<span class="quotelev1">&gt; users_at_[hidden]
</span><br>
<span class="quotelev1">&gt; <a href="http://www.open-mpi.org/mailman/listinfo.cgi/users">http://www.open-mpi.org/mailman/listinfo.cgi/users</a>
</span><br>
<p><p><p><pre>
-- 
Dan Dietz
Scientific Applications Analyst
ITaP Research Computing, Purdue University

</pre>
<hr>
<ul>
<li>application/octet-stream attachment: <a href="http://www.open-mpi.org/community/lists/users/att-24575/slots">slots</a>
</ul>
<!-- attachment="slots" -->
<!-- body="end" -->
<hr>
<ul class="links">
<!-- next="start" -->
<li><strong>Next message:</strong> <a href="24576.php">Mike Dubman: "Re: [OMPI users] spml_ikrit_np random values"</a>
<li><strong>Previous message:</strong> <a href="24574.php">Ralph Castain: "Re: [OMPI users] Determining what parameters a scheduler passes to OpenMPI"</a>
<li><strong>In reply to:</strong> <a href="24558.php">Ralph Castain: "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1"</a>
<!-- nextthread="start" -->
<li><strong>Next in thread:</strong> <a href="24578.php">Ralph Castain: "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1"</a>
<li><strong>Reply:</strong> <a href="24578.php">Ralph Castain: "Re: [OMPI users] Bind multiple cores to rank - OpenMPI 1.8.1"</a>
<!-- reply="end" -->
</ul>
<div class="center">
<table border="2" width="100%" class="links">
<tr>
<th><a href="date.php">Date view</a></th>
<th><a href="index.php">Thread view</a></th>
<th><a href="subject.php">Subject view</a></th>
<th><a href="author.php">Author view</a></th>
</tr>
</table>
</div>
<!-- trailer="footer" -->
<? include("../../include/msg-footer.inc") ?>
