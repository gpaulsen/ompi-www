That could be a bug in openib, openmpi and/or your application.<div>for example, a memory corruption could be unnoticed with tcp, but might cause openib hang.</div><div><br></div><div>you can start by running your program under a memory debugger</div><div>(valgrind, ddt or other) and confirm your application works fine.</div><div>you can also update your application and use tags unique per message, and confirm both send and recv hang when transmitting the same message.</div><div><br></div><div>I assume you ran</div><div>unlimit -l unlimited</div><div>or equivalent before invoking mpirun</div><div>(and this is correctly propagated to the remote nodes)</div><div><br></div><div>btw, did you try an other MPI library ?</div><div>(mpich/mvapich, intel MPI or other)</div><div><br></div><div>That being said, my preferred option is you make your application source available,</div><div>so the hang can be confirmed on a different system, and then debugged</div><div><br></div><div>Cheers,</div><div><br></div><div>Gilles<br><br>On Thursday, January 21, 2016, Eva &lt;<a href="mailto:wuzhh01@gmail.com">wuzhh01@gmail.com</a>&gt; wrote:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">Gilles,<div>Actually, there are some more strange things.</div><div>With the same environment and MPI version, I write a simple program by using the same communication logic with my hang program.</div><div>The simple program can work without hang.</div><div>So is there any possible reason?  I can try them one by one.</div><div>Or can I debug into the openib source code to find the root cause with your instructions or guide?</div></div><div class="gmail_extra"><br><div class="gmail_quote">2016-01-21 17:03 GMT+08:00 Eva <span dir="ltr">&lt;<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;wuzhh01@gmail.com&#39;);" target="_blank">wuzhh01@gmail.com</a>&gt;</span>:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">Gilles,<div><span style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px">&gt;&gt;Can you try to </span><br style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px"><span style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px">&gt;&gt;mpirun --mca btl tcp,self --mca btl_tcp_eager_limit 56 ... </span><br style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px"><span style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px">&gt;&gt;and confirm it works fine with TCP *and* without eager ? </span><br></div><div><span style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px"><br></span></div><div><span style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px">I have tried this and it works. </span></div><div><span style="color:rgb(0,0,0);font-family:verdana,arial,helvetica;font-size:12px">So what should I do next?</span></div><div><br></div></div><div><div><div class="gmail_extra"><br><div class="gmail_quote">2016-01-21 16:25 GMT+08:00 Eva <span dir="ltr">&lt;<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;wuzhh01@gmail.com&#39;);" target="_blank">wuzhh01@gmail.com</a>&gt;</span>:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><div>Thanks Gilles.</div>it works fine on tcp <div>So I use this to disable eager:</div><div> -mca btl_openib_use_eager_rdma 0 -mca btl_openib_max_eager_rdma 0<br></div></div><div><div><div class="gmail_extra"><br><div class="gmail_quote">2016-01-21 13:10 GMT+08:00 Eva <span dir="ltr">&lt;<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;wuzhh01@gmail.com&#39;);" target="_blank">wuzhh01@gmail.com</a>&gt;</span>:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr">I run with two machines, 2 process per node: process0, process1, process2, process3.<div>After some random rounds of communications, the communication hangs. When I debug into the program, I found:<br><div>process1 sent a message to process2; </div><div>process2 received the message from process1 and then start to receive messages from other processes. </div><div>But process1 doesn&#39;t get notice: process2 has received its message and then hang on MPI_Send-&gt;...-&gt;poll_device() of rdmav2.</div><div><br></div><div><div>#0  0x00007f6ba95f03e5 in ?? () from /usr/lib64/libmlx4-rdmav2.so</div><div>#1  0x00007f6bacf1ed93 in poll_device () from /home/openmpi-1.8.5-gcc4.8/lib/openmpi/mca_btl_openib.so</div><div>#2  0x00007f6bacf1f7ed in btl_openib_component_progress () from /home/openmpi-1.8.5-gcc4.8/lib/openmpi/mca_btl_openib.so</div><div>#3  0x00007f6bb06539da in opal_progress () from /home/openmpi-1.8.5-gcc4.8/lib/libopen-pal.so.6</div><div>#4  0x00007f6bab831f55 in mca_pml_ob1_send () from /home/openmpi-1.8.5-gcc4.8/lib/openmpi/mca_pml_ob1.so</div><div>#5  0x00007f6bb0df33c2 in PMPI_Send () from /home/openmpi-1.8.5-gcc4.8/lib/libmpi.so.1</div></div></div><div><br></div><div>Some experiments I have tried:</div><div>1. compile openmpi without multi-thread enable</div><div>2. <span style="font-family:Calibri;font-size:10.5pt;background-color:yellow">--mca
pml_ob1_use_early_completion 0</span></div><div><span style="font-family:Calibri;font-size:10.5pt;background-color:yellow">3. disable eager mode</span></div><div><span style="font-family:Calibri;font-size:10.5pt;background-color:yellow">4. ssend, Bsend</span></div><div><span style="font-family:Calibri;font-size:10.5pt;background-color:yellow"><br></span></div><div><span style="font-family:Calibri;font-size:10.5pt;background-color:yellow">but it still hangs.</span></div><div><span style="font-family:Calibri;font-size:10.5pt;background-color:yellow"><br></span></div><div><font face="Calibri"><span style="font-size:14px;background-color:rgb(255,255,0)">The same program works fine on TCP for more than one year. After I move it onto rdma, it starts to hang. And I can&#39;t debug into any rdma details</span></font></div></div><div><div><div class="gmail_extra"><br><div class="gmail_quote">2016-01-21 11:24 GMT+08:00 Eva <span dir="ltr">&lt;<a href="javascript:_e(%7B%7D,&#39;cvml&#39;,&#39;wuzhh01@gmail.com&#39;);" target="_blank">wuzhh01@gmail.com</a>&gt;</span>:<br><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><span style="font-size:14px">Run MPI_Send on MPI1.8.5 without multithread enabled:</span><div style="font-size:14px">it hangs on mca_pml_ob1_send() -&gt; opal_progreses() -&gt; btl_openib_component_progress() -&gt; poll_device() -&gt; libmlx4-rdmav2.so -&gt; cq -&gt; phread_spin_unlock</div><div style="font-size:14px">The program can run on TCP with no error.</div></div>
</blockquote></div><br></div>
</div></div></blockquote></div><br></div>
</div></div></blockquote></div><br></div>
</div></div></blockquote></div><br></div>
</blockquote></div>

